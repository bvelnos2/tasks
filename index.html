<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Household Favors</title>
    <style>
        :root {
            --bg: #0b0b0d;
            --panel: #1a1b20;
            --panel-2: #20222a;
            --text: #e9e9ee;
            --muted: #a9adbb;
            --accent: #8b7cf3;
            --accent-2: #69d5ff;
            --danger: #ff6b6b;
            --success: #6bff95;
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0,0,0,.35);
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 10% -10%, #131318 0%, transparent 60%), radial-gradient(1000px 600px at 110% 10%, #101019 0%, transparent 60%), var(--bg);
            color: var(--text);
            font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
            color-scheme: dark;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px;
            transition: filter .2s ease
        }

        body.modal-open .container {
            filter: blur(6px) saturate(.9)
        }

        .panel {
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,.05);
            padding: 20px
        }

            .panel + .panel {
                margin-top: 18px
            }

        .title {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: .3px;
            margin: 0 0 12px
        }

        .subtitle {
            font-size: 14px;
            color: var(--muted);
            margin: -6px 0 16px
        }

        .grid {
            display: grid;
            gap: 16px
        }

        @media (min-width: 860px) {
            .grid {
                grid-template-columns: 1fr 1fr
            }
        }

        .btn {
            appearance: none;
            border: 0;
            cursor: pointer;
            padding: 0 16px;
            border-radius: 14px;
            background: linear-gradient(180deg,#2a2b33,#1f2027);
            color: #fff;
            font-weight: 700;
            box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 8px 18px rgba(0,0,0,.25);
            transition: transform .04s ease, filter .2s ease;
            height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center
        }

            .btn:hover {
                filter: brightness(1.07)
            }

            .btn:active {
                transform: translateY(1px)
            }

            .btn.ghost {
                background: linear-gradient(180deg,#24252d,#1b1c22);
                border: 1px solid rgba(255,255,255,.08)
            }

        .selector {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
            margin-top: 16px
        }

        .card {
            background: linear-gradient(180deg,#1a1b20,#15161b);
            border: 1px solid rgba(255,255,255,.05);
            padding: 22px;
            border-radius: 22px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform .08s ease,filter .15s ease
        }

            .card:hover {
                transform: translateY(-2px);
                filter: brightness(1.06)
            }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: #252734;
            color: var(--muted);
            border: 1px solid rgba(255,255,255,.06)
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px
        }

        .muted {
            color: var(--muted)
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
            margin: 14px 0
        }

        .room {
            border-top: 1px solid rgba(255,255,255,.06);
            padding-top: 14px;
            margin-top: 10px;
            position: relative
        }

            .room h3 {
                margin: 8px 0 8px;
                font-size: 18px
            }

        .task {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            background: #1d1e25;
            border: 1px solid rgba(255,255,255,.05);
            margin: 8px 0
        }

            .task input[type="checkbox"] {
                width: 22px;
                height: 22px;
                margin-top: 0
            }

            .task .meta {
                margin-left: auto;
                font-size: 12px;
                color: var(--muted)
            }

        .icon-btn {
            border: 0;
            background: #252734;
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 10px;
            padding: 6px 12px;
            cursor: pointer;
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            min-width: 92px
        }

            .icon-btn + .icon-btn {
                margin-left: 8px
            }

        #alerts {
            margin-bottom: 12px
        }

        .alert {
            background: #3a3205;
            border: 1px solid #f5d34f;
            color: #ffe58a;
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px
        }

            .alert .msg {
                flex: 1
            }

            .alert .close {
                cursor: pointer;
                font-weight: 900;
                opacity: .8
            }

                .alert .close:hover {
                    opacity: 1
                }

            .alert .actions {
                display: flex;
                gap: 8px
            }

        .topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px
        }

        .bal-peek {
            font-weight: 800;
            letter-spacing: .3px
        }

        .right-tools {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto
        }

        .chip-btn {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #252734;
            border: 1px solid rgba(255,255,255,.06);
            color: #cfd3df;
            cursor: pointer
        }

            .chip-btn svg {
                width: 18px;
                height: 18px
            }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 50
        }

            .overlay.show {
                display: flex
            }

        .modal {
            width: min(880px,95vw);
            background: linear-gradient(180deg,#1a1b20,#15161b);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 24px;
            box-shadow: 0 30px 70px rgba(0,0,0,.55);
            padding: 20px;
            position: relative;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden
        }

            .modal .close-x {
                position: absolute;
                top: 12px;
                right: 12px;
                cursor: pointer;
                opacity: .8
            }

                .modal .close-x:hover {
                    opacity: 1
                }

            .modal h3 {
                margin: 0 0 8px
            }

        .modal-body {
            margin-top: 8px;
            overflow: auto;
            flex: 1 1 auto
        }

            .modal-body::-webkit-scrollbar {
                width: 0;
                height: 0
            }

        .modal-body {
            scrollbar-width: none;
            -ms-overflow-style: none
        }

        .big-bals {
            display: flex;
            gap: 16px;
            align-items: stretch;
            flex-wrap: wrap
        }

        .big-card {
            flex: 1;
            min-width: 240px;
            background: #1d1e25;
            border: 1px solid rgba(255,255,255,.06);
            border-radius: 16px;
            padding: 16px
        }

        .big-num {
            font-size: 42px;
            font-weight: 900
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 12px
        }

        .round-ghost {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,.08);
            background: linear-gradient(180deg,#24252d,#1b1c22);
            padding: 10px 14px;
            font-weight: 700;
            cursor: pointer;
            color: var(--text);
            height: 44px
        }

            .round-ghost svg {
                width: 18px;
                height: 18px
            }

        .submodal {
            margin-top: 12px;
            border-top: 1px dashed rgba(255,255,255,.08);
            padding-top: 12px;
            display: none
        }

            .submodal.show {
                display: block
            }

        .field {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        /* Themed inputs */
        input:not([type="checkbox"]):not([type="radio"]), select {
            background: #0f1117;
            border: 1px solid rgba(255,255,255,.12);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            outline: none;
            min-height: 40px;
            width: 100%;
        }

        input::placeholder {
            color: #7d8192
        }

        select {
            appearance: none;
            background-image: linear-gradient(45deg,transparent 50%,#9aa0ae 50%),linear-gradient(135deg,#9aa0ae 50%,transparent 50%),linear-gradient(to right,#0f1117,#0f1117);
            background-position: calc(100% - 20px) calc(50% + 2px),calc(100% - 14px) calc(50% + 2px),100% 0;
            background-size: 6px 6px,6px 6px,2.5em 100%;
            background-repeat: no-repeat
        }

        input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield
        }

        input:-webkit-autofill {
            -webkit-text-fill-color: var(--text);
            box-shadow: 0 0 0px 1000px #0f1117 inset;
            -webkit-box-shadow: 0 0 0px 1000px #0f1117 inset;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .hx-item {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            background: #15161b;
            border: 1px solid rgba(255,255,255,.06);
            border-radius: 14px;
            padding: 10px
        }

        .hx-amt {
            font-weight: 900
        }

        .hx-meta {
            font-size: 12px;
            color: var(--muted)
        }

        .wallet-history {
            margin-top: 8px;
            max-height: 42vh;
            overflow: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            flex: 1 1 auto
        }

            .wallet-history::-webkit-scrollbar {
                width: 0;
                height: 0
            }

        .glance {
            margin-top: 14px;
            padding: 12px;
            border-radius: 14px;
            background: #14151a;
            border: 1px solid rgba(255,255,255,.06)
        }

        .glance-title {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px
        }

        .glance-room {
            font-size: 12px;
            margin: 6px 0 2px;
            color: var(--muted)
        }

        .glance-list {
            margin: 0;
            padding-left: 16px
        }

            .glance-list li {
                font-size: 13px;
                line-height: 1.35;
                margin: 4px 0
            }

        .glance-empty {
            font-size: 13px;
            color: var(--muted)
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
            gap: 12px;
            margin: 8px 0
        }

        .stat {
            background: #17181e;
            border: 1px solid rgba(255,255,255,.06);
            border-radius: 14px;
            padding: 12px
        }

            .stat .big {
                font-weight: 900;
                font-size: 34px;
                line-height: 1.1
            }

        .editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
            gap: 14px;
            margin-top: 10px
        }

        .editor-card {
            background: #15171e;
            border: 1px solid rgba(255,255,255,.06);
            border-radius: 16px;
            padding: 12px;
            min-width: 0
        }

        .editor-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px
        }

        .task-row {
            display: grid;
            grid-template-columns: 1fr 88px 130px 38px;
            gap: 8px;
            align-items: center;
            margin-top: 8px
        }

            .task-row > * {
                min-width: 0
            }

        .menu-wrap {
            position: relative
        }

        .menu {
            position: absolute;
            right: 0;
            top: 44px;
            background: #121319;
            border: 1px solid rgba(255,255,255,.12);
            border-radius: 12px;
            padding: 10px;
            width: 240px;
            display: none;
            box-shadow: 0 12px 30px rgba(0,0,0,.45);
            z-index: 5
        }

            .menu.show {
                display: block
            }

            .menu .row {
                gap: 8px;
                justify-content: stretch
            }

            .menu label {
                font-size: 12px;
                color: var(--muted)
            }

        .grace-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,.45);
            border-radius: 14px;
            backdrop-filter: blur(2px);
            border: 1px dashed rgba(255,255,255,.08)
        }

        .grace-badge {
            text-align: center;
            background: #1b1c23;
            border: 1px solid rgba(255,255,255,.12);
            padding: 16px;
            border-radius: 16px;
            box-shadow: var(--shadow)
        }

            .grace-badge h4 {
                margin: 0 0 8px;
                font-size: 18px;
                display: flex;
                gap: 8px;
                align-items: center;
                justify-content: center
            }

            .grace-badge .muted {
                margin-bottom: 10px
            }

        .shield {
            width: 20px;
            height: 20px;
            display: inline-block;
            border-radius: 6px;
            background: linear-gradient(180deg,#8b7cf3,#5b54c8);
            box-shadow: inset 0 1px 0 rgba(255,255,255,.25)
        }

        canvas#confetti {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 70;
            display: none
        }
    </style>
</head>
<body>
    <canvas id="confetti"></canvas>
    <div class="container" aria-live="polite">
        <div id="alerts"></div>

        <!-- Profile selector -->
        <div id="view-selector" class="panel" aria-label="Profile selection">
            <h1 class="title">Household Favors</h1>
            <p class="subtitle">Pick your profile to open your dashboard.</p>
            <div class="selector">
                <div class="card" onclick="selectUser('spibbs')" role="button" aria-label="Open spibbs dashboard">
                    <div class="row"><span class="chip">User</span><span class="muted">spibbs</span></div>
                    <div style="height:8px"></div>
                    <div class="balance"><span class="big-num" id="bal-card-spibbs">0.00</span><span class="muted">Favors</span></div>
                    <div class="glance">
                        <div class="glance-title">Today’s tasks</div>
                        <div id="glance-spibbs"></div>
                    </div>
                </div>
                <div class="card" onclick="selectUser('sneefli')" role="button" aria-label="Open sneefli dashboard">
                    <div class="row"><span class="chip">User</span><span class="muted">sneefli</span></div>
                    <div style="height:8px"></div>
                    <div class="balance"><span class="big-num" id="bal-card-sneefli">0.00</span><span class="muted">Favors</span></div>
                    <div class="glance">
                        <div class="glance-title">Today’s tasks</div>
                        <div id="glance-sneefli"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="view-dashboard" style="display:none">
            <div class="topbar">
                <button class="btn" onclick="backToProfiles()" aria-label="Switch profile">← Switch profile</button>
                <span class="bal-peek">Balance: <span id="peek-balance">0.00</span></span>

                <div class="right-tools">
                    <!-- NEW: streak chip -->
                    <span class="chip" id="streak-chip" title="Daily streak">🔥 0</span>
                    <span class="chip" id="who-chip">User: —</span>
                    <button class="chip-btn" id="settings-btn" title="Settings" aria-label="Settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.04 3.2l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.26 1.3.73 1.77.47.47 1.11.73 1.77.73H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
                        </svg>
                    </button>
                    <button class="chip-btn" id="wallet-btn" title="Wallet" aria-label="Wallet">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="6" width="18" height="12" rx="2"></rect>
                            <circle cx="16.5" cy="12" r="1.5"></circle>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Household Watch -->
            <div class="panel">
                <h2 class="title" style="font-size:22px;margin:0 0 6px">Household Watch</h2>
                <p class="subtitle">Checking a box means the <b>other user</b> missed it; you instantly gain <b>+0.25</b> Favor.</p>
                <div id="household-watch"></div>
            </div>

            <!-- Daily Tasks -->
            <div class="panel" id="panel-daily">
                <div class="row">
                    <div>
                        <h2 class="title" style="font-size:22px;margin:0 0 6px">Today's Tasks</h2>
                        <p class="subtitle">Complete by <b id="cutoff-label">11:59pm</b>. Incomplete tasks give the other user Favor based on weight.</p>
                    </div>
                    <button class="btn ghost" id="swap-btn" aria-label="Swap a task">⇄ Swap</button>
                </div>
                <div id="daily-tasks" style="position:relative"></div>
            </div>

            <!-- Weekly Tasks -->
            <div class="panel">
                <h2 class="title" style="font-size:22px;margin:0 0 6px">This Week's Tasks (Mon–Sun)</h2>
                <p class="subtitle">Assigned once per week; incomplete at week end gives the other user Favor based on weight.</p>
                <div id="weekly-tasks"></div>
            </div>
        </div>
    </div>

    <!-- Wallet Overlay -->
    <div class="overlay" id="wallet-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wallet-title">
            <div class="close-x" id="wallet-close" title="Close">✕</div>
            <h3 class="title" id="wallet-title" style="font-size:22px;margin:0 0 6px">Wallet</h3>
            <p class="subtitle" style="margin-top:-4px">Quick actions and balances</p>

            <div class="big-bals">
                <div class="big-card">
                    <div class="muted">Your balance</div>
                    <div class="big-num" id="modal-my">0.00</div>
                    <div class="muted" id="grace-line">Grace tokens: 0</div>
                </div>
                <div class="big-card">
                    <div class="muted" id="modal-their-label">Other user’s balance</div>
                    <div class="big-num" id="modal-their">0.00</div>
                    <div class="muted" id="grace-other">Grace tokens: 0</div>
                </div>
            </div>

            <div class="actions">
                <button class="round-ghost" id="btn-redeem">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="9" width="18" height="9" rx="2"></rect>
                        <path d="M7 9V6h10v3"></path>
                        <path d="M9 6V4h6v2"></path>
                        <path d="M7.5 12h3M13.5 12h3"></path>
                    </svg> Redeem
                </button>
                <button class="round-ghost" id="btn-grant">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 8h12"></path>
                        <path d="M14 5l3 3-3 3"></path>
                        <path d="M20 16H8"></path>
                        <path d="M10 19l-3-3 3-3"></path>
                    </svg> Trade
                </button>
                <button class="round-ghost" id="btn-grace">🛡 Use Grace</button>
            </div>

            <div class="submodal" id="subprompt">
                <div class="field">
                    <input id="amount-input" type="number" step="0.01" min="0" placeholder="Amount e.g. 1.50" aria-label="Amount" />
                    <button class="btn" id="amount-ok">OK</button>
                    <button class="btn" id="amount-cancel">Cancel</button>
                </div>
                <div class="muted" id="amount-hint" style="margin-top:6px"></div>
            </div>

            <div class="divider" style="margin-top:16px"></div>
            <div class="row">
                <h3 class="title" style="font-size:20px;margin:0 0 8px">Transaction History</h3>
                <div class="menu-wrap" style="margin-left:auto">
                    <button class="icon-btn" id="history-menu-btn" title="Filter/sort">⋮</button>
                    <div class="menu" id="history-menu">
                        <div style="font-weight:700;margin-bottom:6px">Filters</div>
                        <div class="row">
                            <label>Type</label>
                            <select id="hist-type">
                                <option value="all">All</option>
                                <option value="watch_claim">Watch</option>
                                <option value="daily_penalty">Daily</option>
                                <option value="weekly_penalty">Weekly</option>
                                <option value="grant">Trade</option>
                                <option value="redeem">Redeem</option>
                            </select>
                        </div>
                        <div class="row" style="margin-top:8px">
                            <label>User</label>
                            <select id="hist-user">
                                <option value="both">Both</option>
                                <option value="spibbs">spibbs</option>
                                <option value="sneefli">sneefli</option>
                            </select>
                        </div>
                        <div class="row" style="margin-top:8px;justify-content:flex-end">
                            <button class="icon-btn" id="hist-apply">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="wallet-history"><div id="history-list" class="history-list"></div></div>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div class="overlay" id="settings-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
            <div class="close-x" id="settings-close" title="Close">✕</div>
            <h3 class="title" id="settings-title" style="font-size:22px;margin:0 0 6px">Settings</h3>
            <p class="subtitle">Cutoff, away dates, and task editor (weights included). Saving re-generates today’s and this week’s assignments.</p>

            <div class="modal-body">
                <div class="grid">
                    <div class="stat">
                        <div class="muted">Cutoff & Timezone</div>
                        <div class="field" style="margin-top:8px">
                            <input type="time" id="cfg-cutoff" value="23:59" aria-label="Cutoff time" style="max-width:180px" />
                            <select id="cfg-tz" aria-label="Timezone" style="max-width:220px">
                                <option value="local">Local</option>
                                <option value="-360">UTC-6</option>
                                <option value="-300">UTC-5</option>
                                <option value="0">UTC</option>
                            </select>
                            <button class="btn" id="save-time">Save</button>
                        </div>
                        <small class="muted" id="cutoff-preview"></small>
                    </div>
                    <div class="stat">
                        <div class="muted">Away / Vacation</div>
                        <div class="field" style="margin-top:8px">
                            <select id="away-user" style="max-width:180px"><option value="spibbs">spibbs</option><option value="sneefli">sneefli</option></select>
                            <input type="date" id="away-start" aria-label="Away start" style="max-width:180px" />
                            <input type="date" id="away-end" aria-label="Away end" style="max-width:180px" />
                            <button class="btn" id="away-save">Set</button>
                        </div>
                        <small class="muted">Assignments & penalties paused for this user between the dates.</small>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="field" style="margin-bottom:6px">
                    <button class="btn" id="add-room">+ Add room</button>
                    <button class="btn ghost" id="save-tasks">Save & Apply</button>
                </div>

                <div id="task-editor" class="editor-grid"></div>

                <div class="divider"></div>

                <div class="grid">
                    <div class="stat">
                        <div class="muted">Export / Import</div>
                        <div class="field" style="margin-top:8px">
                            <button class="btn" id="export-btn">Export JSON</button>
                            <input type="file" id="import-file" accept="application/json" aria-label="Import JSON" style="max-width:280px" />
                            <button class="btn" id="import-btn">Import</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Swap Requester Overlay -->
    <div class="overlay" id="swap-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="swap-title">
            <div class="close-x" id="swap-close">✕</div>
            <h3 class="title" id="swap-title" style="font-size:22px;margin:0 0 6px">Propose a Swap</h3>
            <p class="subtitle">Pick one of your tasks and one of the other user’s tasks. Your partner must approve.</p>
            <div class="field">
                <select id="swap-mine" style="max-width:420px"></select>
                <select id="swap-theirs" style="max-width:420px"></select>
                <button class="btn" id="swap-do">Request</button>
            </div>
            <div class="muted" id="swap-hint" style="margin-top:8px"></div>
        </div>
    </div>

    <script>
        (() => {
            /* ------------------ helpers & storage ------------------ */
            const BUS = (() => { try { if ('BroadcastChannel' in window) { const ch = new BroadcastChannel('household-favors'); return { post: m => ch.postMessage(m), on: f => ch.addEventListener('message', e => f(e.data)) } } } catch { } return { post: () => { }, on: () => { } } })();
            const USERS = ['spibbs', 'sneefli']; let currentUser = sessionStorage.getItem('hf.currentUser') || null;
            const fmt = n => (Math.round((n ?? 0) * 100) / 100).toFixed(2);
            const todayKey = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; };
            function weekKey(dt = new Date()) { const d = new Date(dt); const day = (d.getDay() + 6) % 7; d.setHours(0, 0, 0, 0); d.setDate(d.getDate() - day); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
            const loadJSON = (k, f) => { try { const v = JSON.parse(localStorage.getItem(k)); return v ?? f; } catch { return f; } };
            const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
            const otherUser = () => currentUser === 'spibbs' ? 'sneefli' : 'spibbs';

            /* config */
            function getConfig() { return loadJSON('hf.config', { cutoff: '23:59', tz: 'local' }); }
            function saveConfig(patch) { const now = getConfig(); saveJSON('hf.config', { ...now, ...patch }); updateCutoffLabel(); scheduleDailyCheck(); }
            function updateCutoffLabel() { const cfg = getConfig(); const label = document.getElementById('cutoff-label'); if (label) label.textContent = cfg.cutoff; const prev = document.getElementById('cutoff-preview'); if (prev) { const tzText = (cfg.tz === 'local') ? 'Local' : ('UTC' + (cfg.tz >= 0 ? '+' : '') + (cfg.tz / 60)); prev.textContent = `Cutoff set to ${cfg.cutoff}, timezone: ${tzText}`; } }

            /* default tasks */
            const DEFAULT_TASKS = {
                'Kitchen': [
                    { text: 'Do the dishes', weight: 0.75, freq: 'daily' },
                    { text: 'Clean the litter box', weight: 1.0, freq: 'daily' },
                    { text: 'Take out the trash', weight: 0.5, freq: 'daily' },
                    { text: 'Clean the stovetop', weight: 0.5, freq: 'daily' },
                    { text: 'Wipe down surfaces and mop/sweep floors', weight: 1.0, freq: 'weekly' }
                ],
                'Living Room': [
                    { text: 'Clear all surfaces of trash, food, and clutter', weight: 0.5, freq: 'daily' },
                    { text: 'Neatly place pillows on couch and put blankets away', weight: 0.25, freq: 'daily' },
                    { text: 'Clean desk areas of trash and clutter', weight: 0.5, freq: 'daily' },
                    { text: 'Vacuum', weight: 0.75, freq: 'weekly' },
                    { text: 'Wipe down surfaces', weight: 0.5, freq: 'weekly' }
                ],
                'Bedroom': [
                    { text: 'Trash cleared from surfaces and nightstands clutter cleared', weight: 0.5, freq: 'daily' },
                    { text: 'Vacuum', weight: 0.75, freq: 'weekly' },
                    { text: 'Wipe down surfaces', weight: 0.5, freq: 'weekly' }
                ],
                'Bathroom': [
                    { text: 'Toilet paper tower refilled', weight: 0.25, freq: 'daily' },
                    { text: 'Bathroom trash taken out', weight: 0.5, freq: 'daily' },
                    { text: 'Sweep/mop floors', weight: 0.75, freq: 'weekly' },
                    { text: 'Clean sink and mirror', weight: 0.5, freq: 'weekly' },
                    { text: 'Clean toilet', weight: 0.75, freq: 'weekly' }
                ]
            };
            function getTasks() { return loadJSON('hf.tasks', DEFAULT_TASKS); }
            function setTasks(t) { saveJSON('hf.tasks', t); BUS.post({ type: 'tasks' }); }

            /* assignments & completions */
            const dailyAssignKey = 'hf.dailyAssign', dailyDoneKey = 'hf.dailyDone';
            const weekAssignKey = 'hf.week.assignments', weekDoneKey = 'hf.week.completions';
            function dailyAssignments() { return loadJSON(dailyAssignKey, {}); }
            function saveDailyAssignments(x) { saveJSON(dailyAssignKey, x); BUS.post({ type: 'daily-assign' }); }
            function dailyCompletions() { return loadJSON(dailyDoneKey, {}); }
            function saveDailyCompletions(x) { saveJSON(dailyDoneKey, x); BUS.post({ type: 'daily-done' }); }
            function weekAssignments() { return loadJSON(weekAssignKey, {}); }
            function saveWeekAssignments(x) { saveJSON(weekAssignKey, x); BUS.post({ type: 'week-assign' }); }
            function weekCompletions() { return loadJSON(weekDoneKey, {}); }
            function saveWeekCompletions(x) { saveJSON(weekDoneKey, x); BUS.post({ type: 'week-done' }); }

            const isDaily = t => t.freq === 'daily', isWeekly = t => t.freq === 'weekly';
            const weightFor = (room, text) => { const arr = getTasks()[room] || []; const f = arr.find(t => t.text === text); return f ? f.weight : 0.5; };

            function ensureDailyAssignments() {
                const dk = todayKey(); const all = dailyAssignments(); if (all[dk]) return;
                const flat = []; for (const [room, arr] of Object.entries(getTasks())) { arr.filter(isDaily).forEach(t => flat.push(`${room}::${t.text}`)); }
                flat.sort(() => Math.random() - 0.5);
                const counts = { spibbs: 0, sneefli: 0 }; const map = {};
                flat.forEach(k => { const who = counts.spibbs <= counts.sneefli ? 'spibbs' : 'sneefli'; map[k] = who; counts[who]++; });
                all[dk] = map; saveDailyAssignments(all);
            }
            function ensureWeeklyAssignments() {
                const wk = weekKey(); const all = weekAssignments(); const expected = [];
                for (const [room, arr] of Object.entries(getTasks())) { arr.filter(isWeekly).forEach(t => expected.push(`${room}::${t.text}`)); }
                let need = !all[wk]; if (!need) { const cur = all[wk] || {}; const hits = expected.filter(k => Object.prototype.hasOwnProperty.call(cur, k)).length; if (hits < expected.length) need = true; }
                if (!need) return; const flat = expected.slice().sort(() => Math.random() - 0.5); const counts = { spibbs: 0, sneefli: 0 }; const assign = {};
                flat.forEach(id => { const chosen = counts.spibbs <= counts.sneefli ? 'spibbs' : 'sneefli'; assign[id] = chosen; counts[chosen]++; });
                all[wk] = assign; saveWeekAssignments(all);
            }

            /* balances & history */
            function loadBalances() { return loadJSON('hf.balances', { spibbs: 0, sneefli: 0 }); }
            function saveBalances(o) { saveJSON('hf.balances', o); BUS.post({ type: 'balances' }); updateCards(); renderPeek(); renderModalBalances(); renderSummary(); }
            function loadTx() { return loadJSON('hf.tx', []); }
            function saveTx(list) { saveJSON('hf.tx', list); BUS.post({ type: 'tx' }); renderHistory(); renderSummary(); }
            function logTx(entry) { const list = loadTx(); list.push({ id: Date.now() + Math.random(), time: new Date().toISOString(), ...entry }); saveTx(list); }
            function adjustBalance(user, delta, tx) { const b = loadBalances(); b[user] = (b[user] || 0) + delta; saveBalances(b); logTx({ actor: user, amount: Math.abs(delta), ...tx }); }

            /* GRACE TOKENS */
            function getGrace() { return loadJSON('hf.grace', { spibbs: 0, sneefli: 0 }); }
            function setGrace(obj) { saveJSON('hf.grace', obj); BUS.post({ type: 'grace' }); }
            function getGraceUse() { return loadJSON('hf.grace.use', {}); }
            function setGraceUse(map) { saveJSON('hf.grace.use', map); BUS.post({ type: 'grace-use' }); }
            function isGraceActive(u, d = todayKey()) { const m = getGraceUse(); return !!(m[d] && m[d][u]); }
            function toggleGraceToday(active) {
                const d = todayKey(); const m = getGraceUse(); m[d] = m[d] || {};
                if (active) { m[d][currentUser] = true; } else { delete m[d][currentUser]; if (Object.keys(m[d]).length === 0) delete m[d]; }
                setGraceUse(m);
                renderDaily(); renderModalBalances(); renderStreak();  /* update streak chip live */
            }
            function accrueWeeklyGraceIfNeeded() {
                const wk = weekKey(); const last = localStorage.getItem('hf.grace.lastAccruedWeek');
                if (last === wk) return;
                const g = getGrace(); USERS.forEach(u => g[u] = (g[u] || 0) + 1);
                setGrace(g); localStorage.setItem('hf.grace.lastAccruedWeek', wk);
            }

            /* streaks */
            function getStreak() { return loadJSON('hf.streak', { spibbs: { count: 0, last: '' }, sneefli: { count: 0, last: '' } }); }
            function setStreak(s) { saveJSON('hf.streak', s); BUS.post({ type: 'streak' }); renderStreak(); }
            function todayComplete(u) {
                ensureDailyAssignments();
                if (isGraceActive(u)) return true;
                const dk = todayKey(); const assigns = dailyAssignments()[dk] || {};
                const mine = Object.keys(assigns).filter(k => assigns[k] === u);
                const done = (dailyCompletions()[dk]?.[u]) || {};
                if (mine.length === 0) return true;
                return mine.every(k => !!done[k]);
            }
            function renderStreak() {
                const el = document.getElementById('streak-chip'); if (!el || !currentUser) return;
                const s = getStreak()[currentUser] || { count: 0, last: '' };
                const base = s.count || 0;
                const extra = todayComplete(currentUser) ? 1 : 0;   // include today if already complete/graced
                el.textContent = `🔥 ${base + extra}`;
            }

            /* alerts */
            function getAlerts(u) { return loadJSON(`hf.alerts.${u}`, []); }
            function saveAlerts(u, arr) { saveJSON(`hf.alerts.${u}`, arr); }
            function pushAlert(to, msg, actionsHTML, key) {
                const safeMsg = (typeof msg === 'string') ? msg : (msg == null ? '' : String(msg));
                if (!safeMsg) return;
                const arr = getAlerts(to);
                if (key) { const idx = arr.findIndex(a => a.key === key); if (idx >= 0) arr.splice(idx, 1); }
                const id = Date.now() + Math.random();
                arr.push({ id, key: key || null, msg: safeMsg, actions: actionsHTML || '' }); saveAlerts(to, arr);
                if (currentUser === to) renderAlerts();
                BUS.post({ type: 'alert', to });
            }
            function renderAlerts() {
                const box = document.getElementById('alerts');
                if (!box || !currentUser || document.getElementById('view-dashboard').style.display === 'none') { box.innerHTML = ''; return; }
                box.innerHTML = '';
                (getAlerts(currentUser) || []).forEach(({ id, msg, actions }) => {
                    if (!msg || msg === 'undefined') return;
                    const w = document.createElement('div'); w.className = 'alert';
                    const m = document.createElement('div'); m.className = 'msg'; m.innerHTML = msg;
                    const right = document.createElement('div'); right.style.display = 'flex'; right.style.gap = '8px'; right.style.alignItems = 'center';
                    if (actions) { const wrap = document.createElement('div'); wrap.className = 'actions'; wrap.innerHTML = actions; right.appendChild(wrap); }
                    const x = document.createElement('div'); x.className = 'close'; x.textContent = '✕';
                    x.onclick = () => { saveAlerts(currentUser, getAlerts(currentUser).filter(it => it.id !== id)); renderAlerts(); };
                    right.appendChild(x);
                    w.appendChild(m); w.appendChild(right); box.appendChild(w);
                });
            }

            /* Household Watch with Undo */
            const HOUSEHOLD_WATCH = [
                'All beauty/hair product returned to sink cabinets. No empty product or trash in cabinets.',
                'Hair dryer and shaving materials returned to drawer and unplugged',
                'No blankets or clothing on the floor (Household Wide)',
                'Kitchen counters cleared of all trash and clutter',
                'Kitchen should be cleaned and cleared of any trash or stray ingredients immediately after cooking.'
            ];
            function renderWatch() {
                const root = document.getElementById('household-watch'); root.innerHTML = '';
                const key = `hf.watchClaims.${todayKey()}`;
                const getClaims = () => loadJSON(key, { spibbs: {}, sneefli: {} }); const setClaims = (x) => saveJSON(key, x);
                HOUSEHOLD_WATCH.forEach((label, idx) => {
                    const row = document.createElement('label'); row.className = 'task';
                    const cb = document.createElement('input'); cb.type = 'checkbox';
                    const claims = getClaims(); cb.checked = !!claims[currentUser]?.[idx]; cb.disabled = !!claims[currentUser]?.[idx];
                    cb.onchange = () => {
                        if (!cb.checked) return;
                        const c = getClaims(); c[currentUser] = c[currentUser] || {}; if (c[currentUser][idx]) return; c[currentUser][idx] = true; setClaims(c);
                        adjustBalance(currentUser, +0.25, { type: 'watch_claim', reason: `Household Watch: "${label}"` });
                        // notify other user
                        pushAlert(otherUser(), `${currentUser} claimed Household Watch: "<b>${label}</b>" (+0.25 Favor).`);
                        // add undo banner for me
                        const ak = `watch:${todayKey()}:${idx}:${currentUser}`;
                        pushAlert(currentUser, `Claim added: “<b>${label}</b>” (+0.25).`, `<button class="icon-btn" onclick="window._undoWatch('${todayKey()}',${idx},'${currentUser}')">Undo</button>`, ak);
                        cb.disabled = true;
                    };
                    row.appendChild(cb); row.append(label); root.appendChild(row);
                });
            }
            window._undoWatch = function (date, idx, user) {
                if (user !== currentUser) return;
                const key = `hf.watchClaims.${date}`;
                const data = loadJSON(key, { spibbs: {}, sneefli: {} }); if (!data[user] || !data[user][idx]) return;
                const label = HOUSEHOLD_WATCH[idx];
                delete data[user][idx]; saveJSON(key, data);
                adjustBalance(currentUser, -0.25, { type: 'watch_claim', reason: `Reverted Watch claim: "${label}"` });
                const ak = `watch:${date}:${idx}:${user}`; const arr = getAlerts(currentUser).filter(a => a.key !== ak); saveAlerts(currentUser, arr); renderAlerts();
                renderWatch();
                pushAlert(otherUser(), `${currentUser} reverted a Watch claim: “<b>${label}</b>”.`);
            };

            /* daily & weekly renders (with grace overlay) */
            function renderDaily() {
                ensureDailyAssignments();
                const dk = todayKey(); const assigns = dailyAssignments()[dk] || {}; const done = (dailyCompletions()[dk]?.[currentUser]) || {};
                const root = document.getElementById('daily-tasks'); root.innerHTML = '';
                const grouped = {}; Object.entries(assigns).forEach(([key, who]) => { const [room, task] = key.split('::'); if (who !== currentUser) return; (grouped[room] = grouped[room] || []).push(task); });
                for (const [room, arr] of Object.entries(grouped)) {
                    const r = document.createElement('div'); r.className = 'room'; r.innerHTML = `<h3>${room}</h3>`;
                    arr.forEach(task => {
                        const key = `${room}::${task}`; const row = document.createElement('label'); row.className = 'task';
                        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!done[key]; cb.disabled = isGraceActive(currentUser);
                        const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = `weight ${weightFor(room, task).toFixed(2)}`;
                        cb.onchange = () => { const all = dailyCompletions(); all[dk] = all[dk] || { spibbs: {}, sneefli: {} }; all[dk][currentUser][key] = cb.checked; saveDailyCompletions(all); evaluateAndMaybeConfetti(); renderStreak(); };
                        row.appendChild(cb); row.append(task); row.appendChild(meta); r.appendChild(row);
                    });
                    root.appendChild(r);
                }
                const pane = document.getElementById('panel-daily');
                const existing = pane.querySelector('.grace-overlay'); if (existing) existing.remove();
                if (isGraceActive(currentUser)) {
                    const overlay = document.createElement('div'); overlay.className = 'grace-overlay';
                    overlay.innerHTML = `<div class="grace-badge"><h4><span class="shield"></span> Grace Token Activated</h4><div class="muted">All of today’s daily tasks are forgiven.</div><button class="btn" id="undo-grace">Un-redeem</button></div>`;
                    pane.style.position = 'relative'; overlay.style.borderRadius = 'var(--radius)'; pane.appendChild(overlay);
                    overlay.querySelector('#undo-grace').onclick = () => { const g = getGrace(); g[currentUser] = (g[currentUser] || 0) + 1; setGrace(g); toggleGraceToday(false); pushAlert(currentUser, 'Grace token returned. Tasks re-enabled.'); };
                }
                renderSelectorGlance();
                renderStreak();
            }
            function renderWeekly() {
                ensureWeeklyAssignments();
                const wk = weekKey(); const assigns = weekAssignments()[wk] || {}; const comps = (weekCompletions()[wk]?.[currentUser]) || {};
                const root = document.getElementById('weekly-tasks'); root.innerHTML = '';
                for (const [room, arr] of Object.entries(getTasks())) {
                    const my = arr.filter(t => t.freq === 'weekly').filter(t => assigns[`${room}::${t.text}`] === currentUser);
                    const r = document.createElement('div'); r.className = 'room'; r.innerHTML = `<h3>${room}</h3>`;
                    if (my.length === 0) { const p = document.createElement('div'); p.className = 'muted'; p.textContent = 'Nothing to do here :)'; r.appendChild(p); }
                    else {
                        my.forEach(t => {
                            const id = `${room}::${t.text}`; const row = document.createElement('label'); row.className = 'task';
                            const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!comps[id];
                            const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = `weight ${t.weight.toFixed(2)}`;
                            cb.onchange = () => { const all = weekCompletions(); all[wk] = all[wk] || { spibbs: {}, sneefli: {} }; all[wk][currentUser][id] = cb.checked; saveWeekCompletions(all); renderSummary(); };
                            row.appendChild(cb); row.append(t.text); row.appendChild(meta); r.appendChild(row);
                        });
                    }
                    root.appendChild(r);
                }
                renderSummary();
            }

            /* Weekly Summary (panel was removed; keep guard) */
            function renderSummary() { const panel = document.getElementById('panel-summary'); if (!panel) return; }

            /* cutoff & penalties + streak processing */
            function cutoffDate(d = new Date()) { const [hh, mm] = (getConfig().cutoff || '23:59').split(':').map(Number); const dt = new Date(d); dt.setHours(hh, mm, 10, 0); return dt; }
            function msUntilCutoff() { const now = new Date(); let target = cutoffDate(); if (now > target) { target.setDate(target.getDate() + 1); } return Math.max(2000, target - now); }
            function scheduleDailyCheck() { clearTimeout(window.__dailyTimer); window.__dailyTimer = setTimeout(() => { processYesterdayDailyPenalties(); scheduleDailyCheck(); }, msUntilCutoff()); }

            function allAssignedCompletedFor(assigns, comps, user) {
                const mine = Object.keys(assigns || {}).filter(k => assigns[k] === user);
                if (mine.length === 0) return true;
                const done = (comps?.[user]) || {};
                return mine.every(k => !!done[k]);
            }

            function processYesterdayDailyPenalties() {
                const last = localStorage.getItem('hf.daily.lastProcessed'); const today = todayKey(); if (last === today) return;
                const y = new Date(); y.setHours(0, 0, 0, 0); y.setDate(y.getDate() - 1); const yKey = `${y.getFullYear()}-${String(y.getMonth() + 1).padStart(2, '0')}-${String(y.getDate()).padStart(2, '0')}`;
                const assigns = dailyAssignments()[yKey]; if (!assigns) { localStorage.setItem('hf.daily.lastProcessed', today); return; }
                const comps = dailyCompletions()[yKey] || { spibbs: {}, sneefli: {} }; const balances = loadBalances();
                const graceUsed = getGraceUse()[yKey] || {};
                for (const [taskKey, who] of Object.entries(assigns)) {
                    if (graceUsed[who]) continue; // forgiven
                    const completed = !!(comps[who] && comps[who][taskKey]); if (completed) continue;
                    const [room, task] = taskKey.split('::'); const other = who === 'spibbs' ? 'sneefli' : 'spibbs';
                    const w = weightFor(room, task); balances[other] = (balances[other] || 0) + w;
                    logTx({ type: 'daily_penalty', amount: w, actor: other, reason: `Daily task missed by ${who}: ${task} (${room}) on ${yKey}` });
                }
                saveBalances(balances);

                // streak update for each user (grace preserves)
                const S = getStreak();
                USERS.forEach(u => {
                    const preserved = !!graceUsed[u];
                    const doneAll = preserved || allAssignedCompletedFor(assigns, comps, u);
                    if (doneAll) {
                        S[u] = S[u] || { count: 0, last: '' };
                        S[u].count = (S[u].last === yKey ? S[u].count : S[u].count) + 1; // processed once per day; bump by 1
                        S[u].last = yKey;
                    } else {
                        S[u] = { count: 0, last: yKey };
                    }
                });
                setStreak(S);

                localStorage.setItem('hf.daily.lastProcessed', today);
            }

            function processLastWeekPenalties() {
                const currentWk = weekKey(); const lastProcessed = localStorage.getItem('hf.week.lastProcessed'); if (lastProcessed === currentWk) return;
                const start = new Date(currentWk + "T00:00:00"); const prevStart = new Date(start.getTime() - 7 * 86400000);
                const prevKey = `${prevStart.getFullYear()}-${String(prevStart.getMonth() + 1).padStart(2, '0')}-${String(prevStart.getDate()).padStart(2, '0')}`;
                const assigns = weekAssignments()[prevKey]; if (!assigns) { localStorage.setItem('hf.week.lastProcessed', currentWk); return; }
                const compsAll = weekCompletions()[prevKey] || { spibbs: {}, sneefli: {} }; const balances = loadBalances();
                for (const [id, who] of Object.entries(assigns)) {
                    const done = !!(compsAll[who] && compsAll[who][id]); if (done) continue;
                    const [room, task] = id.split('::'); const other = who === 'spibbs' ? 'sneefli' : 'spibbs'; const w = weightFor(room, task);
                    balances[other] = (balances[other] || 0) + w;
                    logTx({ type: 'weekly_penalty', amount: w, actor: other, reason: `Weekly task missed by ${who}: ${task} (${room}) for week starting ${prevKey}` });
                }
                saveBalances(balances); localStorage.setItem('hf.week.lastProcessed', currentWk);
            }
            function msUntilNextWeek() { const now = new Date(); const d = new Date(now); const day = (d.getDay() + 6) % 7; d.setHours(24, 0, 10, 0); d.setDate(d.getDate() - day + 7); return Math.max(2000, d - now); }
            function scheduleWeeklyCheck() { clearTimeout(window.__weekTimer); window.__weekTimer = setTimeout(() => { processLastWeekPenalties(); ensureWeeklyAssignments(); accrueWeeklyGraceIfNeeded(); scheduleWeeklyCheck(); }, msUntilNextWeek()); }

            /* wallet & history */
            const overlay = document.getElementById('wallet-overlay'), btnWallet = document.getElementById('wallet-btn'), btnClose = document.getElementById('wallet-close');
            const sub = document.getElementById('subprompt'), input = document.getElementById('amount-input'), btnOK = document.getElementById('amount-ok'), btnCancel = document.getElementById('amount-cancel');
            const btnRedeem = document.getElementById('btn-redeem'), btnGrant = document.getElementById('btn-grant'), btnGrace = document.getElementById('btn-grace'); let currentAction = null;

            function openWallet() { overlay.classList.add('show'); document.body.classList.add('modal-open'); renderModalBalances(); hideSub(); renderHistory(); }
            function closeWallet() { overlay.classList.remove('show'); document.body.classList.remove('modal-open'); hideSub(); currentAction = null; input.value = ''; }
            function hideSub() { sub.classList.remove('show'); document.getElementById('amount-hint').textContent = ''; }
            function showSub(hint) { sub.classList.add('show'); document.getElementById('amount-hint').textContent = hint || ''; input.value = ''; input.focus(); }

            function renderModalBalances() {
                if (!currentUser) return;
                const b = loadBalances(); const other = otherUser();
                const g = getGrace(); const og = g[other] ?? 0, mg = g[currentUser] ?? 0;
                document.getElementById('modal-my').textContent = fmt(b[currentUser] || 0);
                document.getElementById('modal-their').textContent = fmt(b[other] || 0);
                document.getElementById('modal-their-label').textContent = `${other}’s balance`;
                document.getElementById('grace-line').textContent = `Grace tokens: ${mg}`;
                document.getElementById('grace-other').textContent = `Grace tokens: ${og}`;
            }
            function renderPeek() { const b = loadBalances(); const peek = document.getElementById('peek-balance'); if (peek && currentUser) peek.textContent = fmt(b[currentUser] || 0); }

            btnWallet.addEventListener('click', openWallet); btnClose.addEventListener('click', closeWallet);
            overlay.addEventListener('click', e => { if (e.target === overlay) closeWallet(); });
            btnRedeem.addEventListener('click', () => { currentAction = 'redeem'; showSub('Enter how much Favor you want to redeem.'); });
            btnGrant.addEventListener('click', () => { currentAction = 'grant'; showSub(`Enter how much Favor to add to ${otherUser()}. (Does not reduce your balance)`); });
            btnGrace.addEventListener('click', () => {
                const g = getGrace(); if ((g[currentUser] || 0) <= 0) { pushAlert(currentUser, 'No grace tokens available.'); return; }
                if (isGraceActive(currentUser)) { pushAlert(currentUser, 'Grace already active for today.'); return; }
                g[currentUser]--; setGrace(g);
                toggleGraceToday(true);
                pushAlert(currentUser, '🛡 Grace token redeemed for today. All daily chores forgiven.');
            });
            btnCancel.addEventListener('click', hideSub);
            btnOK.addEventListener('click', () => {
                const amt = Math.max(0, parseFloat(input.value || '0')); if (!amt) { hideSub(); return; }
                if (currentAction === 'redeem') {
                    const b = loadBalances(); if ((b[currentUser] || 0) < amt) { pushAlert(currentUser, 'Not enough Favor to redeem.'); return; }
                    adjustBalance(currentUser, -amt, { type: 'redeem', reason: `Redeemed ${fmt(amt)} Favor` }); hideSub();
                } else if (currentAction === 'grant') {
                    const target = otherUser(); adjustBalance(target, +amt, { type: 'grant', actor: currentUser, target, reason: `Granted ${fmt(amt)} Favor to ${target}` }); hideSub();
                }
            });

            let histType = 'all', histUser = 'both';
            const menuBtn = document.getElementById('history-menu-btn'), menu = document.getElementById('history-menu');
            menuBtn.onclick = () => { menu.classList.toggle('show'); };
            document.getElementById('hist-apply').onclick = () => { histType = document.getElementById('hist-type').value; histUser = document.getElementById('hist-user').value; menu.classList.remove('show'); renderHistory(); };

            function renderHistory() {
                const root = document.getElementById('history-list'); if (!root) return;
                const list = loadTx().slice().sort((a, b) => b.time.localeCompare(a.time)); root.innerHTML = '';
                if (list.length === 0) { const p = document.createElement('div'); p.className = 'muted'; p.textContent = 'No transaction history.'; root.appendChild(p); return; }
                list.filter(tx => {
                    const typeOK = (histType === 'all') || (tx.type === histType);
                    const userOK = (histUser === 'both') || (tx.actor === histUser);
                    return typeOK && userOK;
                }).forEach(tx => {
                    const wrap = document.createElement('div'); wrap.className = 'hx-item';
                    const amt = document.createElement('div'); amt.className = 'hx-amt'; const sign = (tx.type === 'redeem') ? '-' : '+'; amt.textContent = `${sign}${fmt(tx.amount)}`;
                    const main = document.createElement('div'); main.style.flex = '1';
                    const meta = document.createElement('div'); meta.className = 'hx-meta'; meta.textContent = new Date(tx.time).toLocaleString();
                    const desc = document.createElement('div'); const who = tx.actor || '';
                    if (tx.type === 'watch_claim') { desc.innerHTML = `<b>${who}</b> gained Favor — ${tx.reason}`; }
                    else if (tx.type === 'daily_penalty' || tx.type === 'weekly_penalty') { desc.textContent = `${who} gained Favor — ${tx.reason}`; }
                    else if (tx.type === 'grant') { desc.textContent = `${who} granted ${fmt(tx.amount)} to ${tx.target}`; }
                    else if (tx.type === 'redeem') { desc.textContent = `${who} redeemed ${fmt(tx.amount)}`; }
                    else { desc.textContent = tx.reason || 'Transaction'; }
                    main.appendChild(desc); main.appendChild(meta);
                    wrap.appendChild(amt); wrap.appendChild(main); root.appendChild(wrap);
                });
            }

            /* selector glance */
            function renderSelectorGlance() {
                ensureDailyAssignments();
                const dk = todayKey(); const assigns = dailyAssignments()[dk] || {};
                function build(user) { const per = {}; Object.entries(assigns).forEach(([k, who]) => { if (who !== user) return; const [room, task] = k.split('::'); (per[room] = per[room] || []).push(task); }); return per; }
                function fill(id, per) {
                    const host = document.getElementById(id); if (!host) return; host.innerHTML = ''; const rooms = Object.keys(per);
                    if (rooms.length === 0) { const s = document.createElement('div'); s.className = 'glance-empty'; s.textContent = 'Nothing to do here :)'; host.appendChild(s); return; }
                    rooms.forEach(r => { const t = document.createElement('div'); t.className = 'glance-room'; t.textContent = r; const ul = document.createElement('ul'); ul.className = 'glance-list'; per[r].forEach(x => { const li = document.createElement('li'); li.textContent = x; ul.appendChild(li); }); host.appendChild(t); host.appendChild(ul); });
                }
                fill('glance-spibbs', build('spibbs')); fill('glance-sneefli', build('sneefli'));
                updateCards();
            }
            function updateCards() { const b = loadBalances(); const a = document.getElementById('bal-card-spibbs'); if (a) a.textContent = fmt(b.spibbs || 0); const c = document.getElementById('bal-card-sneefli'); if (c) c.textContent = fmt(b.sneefli || 0); }

            /* settings editor */
            const settOverlay = document.getElementById('settings-overlay');
            document.getElementById('settings-btn').onclick = () => { populateSettings(); settOverlay.classList.add('show'); document.body.classList.add('modal-open'); };
            document.getElementById('settings-close').onclick = () => { settOverlay.classList.remove('show'); document.body.classList.remove('modal-open'); };
            settOverlay.addEventListener('click', e => { if (e.target === settOverlay) { document.getElementById('settings-close').onclick(); } });

            function populateSettings() { const cfg = getConfig(); document.getElementById('cfg-cutoff').value = cfg.cutoff || '23:59'; document.getElementById('cfg-tz').value = cfg.tz || 'local'; buildTaskEditor(); }
            document.getElementById('save-time').onclick = () => { saveConfig({ cutoff: document.getElementById('cfg-cutoff').value, tz: document.getElementById('cfg-tz').value }); pushAlert(currentUser, 'Time settings saved.'); };
            document.getElementById('away-save').onclick = () => {
                const who = document.getElementById('away-user').value, start = document.getElementById('away-start').value, end = document.getElementById('away-end').value;
                const a = loadJSON('hf.away', {}); a[who] = { start, end }; saveJSON('hf.away', a); pushAlert(currentUser, `Away saved for <b>${who}</b> from ${start} to ${end}.`);
            };

            function buildTaskEditor() {
                const host = document.getElementById('task-editor'); host.innerHTML = ''; const tasks = getTasks();
                Object.entries(tasks).forEach(([room, arr]) => {
                    const card = document.createElement('div'); card.className = 'editor-card';
                    const head = document.createElement('div'); head.className = 'editor-head';
                    head.innerHTML = `<div style="font-weight:700">${room}</div>`;
                    const right = document.createElement('div');
                    const addBtn = document.createElement('button'); addBtn.className = 'icon-btn'; addBtn.textContent = '+ Task';
                    const delBtn = document.createElement('button'); delBtn.className = 'icon-btn'; delBtn.textContent = '✕ Room';
                    addBtn.onclick = () => { arr.push({ text: 'New task', weight: 0.5, freq: 'daily' }); buildTaskEditor(); };
                    delBtn.onclick = () => { if (confirm('Delete room?')) { delete tasks[room]; setTasks(tasks); buildTaskEditor(); } };
                    right.append(addBtn, delBtn); head.appendChild(right); card.appendChild(head);

                    arr.forEach((t, ix) => {
                        const row = document.createElement('div'); row.className = 'task-row';
                        const i1 = document.createElement('input'); i1.type = 'text'; i1.value = t.text;
                        const i2 = document.createElement('input'); i2.type = 'number'; i2.step = '0.25'; i2.min = '0.25'; i2.max = '2'; i2.value = t.weight;
                        const sel = document.createElement('select'); sel.innerHTML = '<option value="daily">daily</option><option value="weekly">weekly</option><option value="seasonal">seasonal</option>'; sel.value = t.freq || 'daily';
                        const x = document.createElement('button'); x.className = 'icon-btn'; x.textContent = '✕'; x.onclick = () => { arr.splice(ix, 1); buildTaskEditor(); };
                        row.append(i1, i2, sel, x); card.appendChild(row);
                    });

                    host.appendChild(card);
                });

                document.getElementById('add-room').onclick = () => { const name = prompt('Room name'); if (!name) return; const cur = getTasks(); if (cur[name]) { pushAlert(currentUser, 'Room already exists.'); return; } cur[name] = [{ text: 'Example task', weight: 0.5, freq: 'daily' }]; setTasks(cur); buildTaskEditor(); };
                document.getElementById('save-tasks').onclick = () => {
                    const cur = {};[...host.querySelectorAll('.editor-card')].forEach(card => {
                        const room = card.querySelector('.editor-head div').textContent; const arr = [];
                        card.querySelectorAll('.task-row').forEach(row => { const [txt, wt, sel] = row.querySelectorAll('input,select'); const t = (txt.value || '').trim(); if (!t) return; arr.push({ text: t, weight: Math.max(0.25, parseFloat(wt.value) || 0.5), freq: sel.value }); });
                        cur[room] = arr;
                    });
                    setTasks(cur); const d = dailyAssignments(); delete d[todayKey()]; saveDailyAssignments(d); ensureDailyAssignments();
                    const w = weekAssignments(); delete w[weekKey()]; saveWeekAssignments(w); ensureWeeklyAssignments();
                    renderSelectorGlance(); renderDaily(); renderWeekly(); pushAlert(currentUser, 'Settings saved and assignments updated.');
                };
            }

            /* export/import */
            document.getElementById('export-btn').onclick = () => {
                const dump = { balances: loadJSON('hf.balances', {}), tx: loadTx(), tasks: getTasks(), config: getConfig(), daily: dailyAssignments(), weekly: weekAssignments(), grace: getGrace(), graceUse: getGraceUse() };
                const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'household-favors-backup.json'; a.click();
            };
            document.getElementById('import-btn').onclick = () => {
                const f = document.getElementById('import-file').files[0]; if (!f) return; const r = new FileReader();
                r.onload = () => { try { const j = JSON.parse(r.result); if (j.balances) saveJSON('hf.balances', j.balances); if (j.tx) saveJSON('hf.tx', j.tx); if (j.tasks) saveJSON('hf.tasks', j.tasks); if (j.config) saveJSON('hf.config', j.config); if (j.daily) saveJSON('hf.dailyAssign', j.daily); if (j.weekly) saveJSON('hf.week.assignments', j.weekly); if (j.grace) saveJSON('hf.grace', j.grace); if (j.graceUse) saveJSON('hf.grace.use', j.graceUse); pushAlert(currentUser, 'Import complete. Reloading…'); setTimeout(() => location.reload(), 400); } catch { pushAlert(currentUser, 'Invalid file for import.'); } };
                r.readAsText(f);
            };

            /* swap */
            const swapOverlay = document.getElementById('swap-overlay'), swapClose = document.getElementById('swap-close');
            document.getElementById('swap-btn').onclick = () => { buildSwapLists(); swapOverlay.classList.add('show'); document.body.classList.add('modal-open'); };
            swapClose.onclick = () => { swapOverlay.classList.remove('show'); document.body.classList.remove('modal-open'); };
            swapOverlay.addEventListener('click', e => { if (e.target === swapOverlay) swapClose.onclick(); });

            function buildSwapLists() {
                ensureDailyAssignments(); const dk = todayKey(); const assigns = dailyAssignments()[dk] || {};
                const mine = Object.keys(assigns).filter(k => assigns[k] === currentUser);
                const theirs = Object.keys(assigns).filter(k => assigns[k] === otherUser());
                const sMine = document.getElementById('swap-mine'), sTheirs = document.getElementById('swap-theirs'); sMine.innerHTML = ''; sTheirs.innerHTML = '';
                mine.forEach(k => { const [r, t] = k.split('::'); const o = document.createElement('option'); o.value = k; o.textContent = `${r}: ${t}`; sMine.appendChild(o); });
                theirs.forEach(k => { const [r, t] = k.split('::'); const o = document.createElement('option'); o.value = k; o.textContent = `${r}: ${t}`; sTheirs.appendChild(o); });
                document.getElementById('swap-hint').textContent = 'Select tasks to see suggested settlement.';
                sMine.onchange = sTheirs.onchange = () => { const a = sMine.value, b = sTheirs.value; if (!a || !b) return; const [r1, t1] = a.split('::'), [r2, t2] = b.split('::'); const w1 = weightFor(r1, t1), w2 = weightFor(r2, t2); const diff = (w1 - w2).toFixed(2); const owed = parseFloat(diff); document.getElementById('swap-hint').textContent = owed === 0 ? 'Even swap.' : (owed > 0 ? `${otherUser()} should receive +${diff}.` : `${currentUser} should receive +${Math.abs(owed).toFixed(2)}.`); };
            }
            function getSwaps() { return loadJSON('hf.swaps', []); }
            function saveSwaps(arr) { saveJSON('hf.swaps', arr); BUS.post({ type: 'swap-upd' }); }

            document.getElementById('swap-do').onclick = () => {
                const a = document.getElementById('swap-mine').value, b = document.getElementById('swap-theirs').value; if (!a || !b) return;
                const [r1, t1] = a.split('::'), [r2, t2] = b.split('::'); const w1 = weightFor(r1, t1), w2 = weightFor(r2, t2);
                const diff = parseFloat((w1 - w2).toFixed(2));
                const id = Date.now() + Math.random();
                const req = { id, date: todayKey(), requester: currentUser, responder: otherUser(), a, b, diff, status: 'pending' };
                const all = getSwaps(); all.push(req); saveSwaps(all);
                const key = `swap:${id}`;
                const msg = `<b>${req.requester}</b> requested a swap:<br>“${t1}” ↔ “${t2}”`;
                const actions = `<button class="icon-btn" onclick="window._approveSwap('${id}',true)">Approve</button>
                           <button class="icon-btn" onclick="window._approveSwap('${id}',false)">Deny</button>`;
                pushAlert(req.responder, msg, actions, key);
                pushAlert(req.requester, 'Swap request sent. Waiting for approval…', '', `swap-info:${id}`);
                swapClose.onclick();
            };

            window._approveSwap = function (id, ok) {
                const list = getSwaps(); const s = list.find(x => String(x.id) === String(id)); if (!s) return;
                if (s.responder !== currentUser) { pushAlert(currentUser, 'Only the responder can act on this swap.'); return; }
                if (s.status !== 'pending') { pushAlert(currentUser, 'This swap request is no longer pending.'); return; }

                if (ok) {
                    const all = dailyAssignments(); const map = all[s.date]; const ownerA = map[s.a], ownerB = map[s.b]; map[s.a] = ownerB; map[s.b] = ownerA; saveDailyAssignments(all);
                    if (s.diff !== 0) { const receiver = s.diff > 0 ? s.responder : s.requester; adjustBalance(receiver, Math.abs(s.diff), { type: 'grant', actor: 'swap', target: receiver, reason: `Swap settlement (${s.a} ↔ ${s.b})` }); }
                    s.status = 'approved'; saveSwaps(list);
                    pushAlert(s.requester, `Swap <b>approved</b> by ${s.responder}.`, '', `swap-info:${s.id}`);
                    pushAlert(s.responder, 'Swap approved.');
                } else {
                    s.status = 'denied'; saveSwaps(list);
                    pushAlert(s.requester, `Swap <b>denied</b> by ${s.responder}.`, '', `swap-info:${s.id}`);
                    pushAlert(s.responder, 'Swap denied.');
                }
                const filtered = getAlerts(currentUser).filter(a => !(a.key && a.key.startsWith('swap:') && a.key.includes(String(s.id)))); saveAlerts(currentUser, filtered); renderAlerts();
                renderDaily();
            };

            /* confetti */
            function evaluateAndMaybeConfetti() {
                const dk = todayKey(); const assigns = dailyAssignments()[dk] || {}; const mine = Object.keys(assigns).filter(k => assigns[k] === currentUser);
                const done = (dailyCompletions()[dk]?.[currentUser]) || {}; const allDone = mine.length > 0 && mine.every(k => done[k]);
                if (allDone) fireConfetti();
            }
            function fireConfetti() {
                const c = document.getElementById('confetti'); const ctx = c.getContext('2d'); c.width = innerWidth; c.height = innerHeight; c.style.display = 'block';
                let parts = Array.from({ length: 220 }, () => ({ x: Math.random() * c.width, y: -20, w: 6 + Math.random() * 7, h: 10, vy: 2 + Math.random() * 3, vx: (Math.random() - .5) * 2, rot: 0 }));
                let t = 0; const end = 520; const anim = () => { ctx.clearRect(0, 0, c.width, c.height); parts.forEach(p => { ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot); ctx.fillStyle = `hsl(${(p.y / 3 + t) % 360},90%,60%)`; ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.restore(); p.y += p.vy; p.x += p.vx; p.rot += .05; }); t += 2; if (t < end) requestAnimationFrame(anim); else c.style.display = 'none'; }; anim();
            }

            /* boot & bus */
            function renderAll() { renderAlerts(); renderWatch(); renderDaily(); renderWeekly(); renderPeek(); renderModalBalances(); renderHistory(); renderSummary(); updateCutoffLabel(); renderStreak(); }
            BUS.on((data) => {
                if (!data) return;
                if (data.type === 'balances') { if (currentUser) { renderPeek(); renderModalBalances(); } updateCards(); renderSummary(); }
                if (data.type === 'daily-assign' || data.type === 'daily-done') { if (currentUser) { renderDaily(); renderSelectorGlance(); renderStreak(); } }
                if (data.type === 'week-assign' || data.type === 'week-done') { if (currentUser) renderWeekly(); }
                if (data.type === 'alert' && currentUser) { renderAlerts(); }
                if (data.type === 'tasks') { if (currentUser) { renderDaily(); renderWeekly(); renderSelectorGlance(); renderSummary(); renderStreak(); } }
                if (data.type === 'swap-upd' && currentUser) { renderAlerts(); }
                if (data.type === 'tx' && currentUser) { renderHistory(); renderSummary(); }
                if (data.type === 'grace' || data.type === 'grace-use' || data.type === 'streak') { if (currentUser) { renderModalBalances(); renderDaily(); renderStreak(); } }
            });

            window.selectUser = function (u) {
                currentUser = u; sessionStorage.setItem('hf.currentUser', u);
                document.getElementById('view-selector').style.display = 'none';
                document.getElementById('view-dashboard').style.display = 'block';
                document.getElementById('who-chip').textContent = `User: ${currentUser}`;
                renderAll(); renderSelectorGlance();
            };
            window.backToProfiles = function () {
                sessionStorage.removeItem('hf.currentUser'); currentUser = null;
                document.getElementById('view-selector').style.display = 'block';
                document.getElementById('view-dashboard').style.display = 'none';
                document.getElementById('alerts').innerHTML = '';
                updateCards();
            };

            updateCards();
            ensureWeeklyAssignments(); processLastWeekPenalties(); scheduleWeeklyCheck(); accrueWeeklyGraceIfNeeded();
            ensureDailyAssignments(); processYesterdayDailyPenalties(); scheduleDailyCheck();
            renderSelectorGlance();
            if (currentUser) {
                document.getElementById('view-selector').style.display = 'none';
                document.getElementById('view-dashboard').style.display = 'block';
                renderAll();
            }
        })();
    </script>
</body>
</html>
