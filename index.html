<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>OurFavor</title>
<style>
  :root{
    --bg: #0f1115;
    --card: rgba(28,30,36,0.65);
    --card-opaque:#1c1e24;
    --surface: rgba(255,255,255,0.08);
    --on-surface: #e8e8ea;
    --muted: #aeb1b8;
    --accent: #d0d3dc;
    --primary:#d1d6e6;
    --green:#63d37a;
    --red:#ff6b6b;
    --yellow:#ffd466;
    --blue:#86b6ff;
    --blur: 18px;
    --radius: 24px;
    --radius-sm: 14px;
    --shadow: 0 10px 40px rgba(0,0,0,0.45);
    --focus: 0 0 0 3px rgba(255,255,255,0.12);
  }
  html,body{height:100%;}
  body{
    margin:0;
    min-height:100vh;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";
    color: var(--on-surface);
    background: radial-gradient(1200px 800px at 20% 10%, #2a2e3b33, transparent),
                radial-gradient(1400px 900px at 80% 0%, #3a3f4f33, transparent),
                radial-gradient(1000px 700px at 50% 100%, #2c314033, transparent),
                var(--bg);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: cover;
    overflow:auto;
  }
  .hidden{display:none!important;}
  .btn{ display:inline-flex;align-items:center;gap:.6rem;border:none;border-radius:20px;padding:.8rem 1.1rem;background:var(--surface);color:var(--on-surface);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:var(--shadow);cursor:pointer;transition:.2s transform,.25s background;}
  .btn:active{transform:translateY(1px) scale(.99);}
  .btn.primary{background:linear-gradient(180deg, #363b49aa, #2b2f3daa);}
  .btn.ghost{background:transparent;border:1px solid #ffffff1a;}
  .icon{width:22px;height:22px;display:block;opacity:.95;}
  .top-nav .icon-btn .icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;opacity:.95;}
  .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .7rem;border-radius:999px;background:#ffffff12;}
  .grid{display:grid;gap:1rem;}
  .row{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;}
  .fade-in{animation: fadeIn .35s ease both;}
  .fade-up{animation: fadeUp .35s ease both;}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes fadeUp{from{opacity:0; transform: translateY(10px)}to{opacity:1; transform: none}}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter: blur(6px);display:flex;align-items:center;justify-content:center;z-index:100;animation:fadeIn .2s both;}
  .modal{width:min(680px,92vw);background:var(--card);border:1px solid #ffffff20;border-radius:28px;padding:20px;animation:fadeIn .2s ease both;max-height:80vh;overflow:auto;}
  .modal .title{font-size:20px;font-weight:700;margin-bottom:12px;}
  .field{display:flex;flex-direction:column;gap:8px;margin:10px 0;}
  .field input,.field select{background:#ffffff10;color:var(--on-surface);border:1px solid #ffffff1c;padding:12px 14px;border-radius:14px;outline:none;transition:.15s border;}
  .field input:focus,.field select:focus{border-color:#ffffff44;box-shadow:var(--focus);}
  #app{position:relative;min-height:100vh;}
  .screen{position:relative;min-height:100vh;padding:24px;overflow:visible;}
  /* Profile selection */
  #profileScreen{
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
    text-align:center;min-height:100vh; padding:24px; box-sizing:border-box;
  }
  #profileScreen h1{font-size:32px;margin:0;color:#f3f5fb}
  .profiles-row{display:flex;gap:28px;align-items:center;justify-content:center;flex-wrap:wrap;max-width:90vw}
  .avatar-circle{width:108px;height:108px;border-radius:999px;overflow:hidden;border:2px solid #ffffff22;background:#2c3140;box-shadow:var(--shadow);position:relative;display:grid;place-items:center;cursor:pointer;transition:.2s transform;}
  .avatar-circle:hover{transform:translateY(-2px)}
  .avatar-circle img{width:100%;height:100%;object-fit:cover;display:block;}
  .avatar-circle .initial{font-size:42px;font-weight:800;color:#fff;}
  .avatar-label{margin-top:8px;font-size:14px;color:#cfd3dd}
  .manage-row{margin-top:8px}
  #advancedArea{width:min(1200px, 95vw);}
  .advanced-user{display:grid;grid-template-columns:120px 1fr;gap:16px;border:1px solid #ffffff18;background:#1b1f2a80;border-radius:20px;padding:16px;}
  .advanced-user .topline{display:flex;align-items:baseline;gap:16px;justify-content:space-between}
  .advanced-user .name-balance{display:flex;align-items:baseline;gap:16px}
  .advanced-user .tasks{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .task-chip{border:1px solid #ffffff22;border-radius:999px;padding:8px 10px;background:#ffffff10;font-size:12px}
  /* Dashboard */
  #dashboard{display:flex;flex-direction:column;gap:16px;}
  .top-nav{display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:5;padding-bottom:4px;background:linear-gradient(180deg, rgba(15,17,21,.9), rgba(15,17,21,0));backdrop-filter:blur(6px);}
  .avatar{width:48px;height:48px;border-radius:16px;overflow:hidden;position:relative;background:#394058;border:1px solid #ffffff24;cursor:pointer;}
  .avatar .initial{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:22px;color:#ffffffd8;}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block;}
  .tabs{display:flex;gap:10px;align-items:center;}
  .tab{padding:10px 14px;border-radius:16px;border:1px solid #ffffff18;background:#1e22306e;cursor:pointer;}
  .tab.active{background:#30384f80;}
  .spacer{flex:1}
  .icon-btn{width:40px;height:40px;border-radius:14px;border:1px solid #ffffff20;
    background:#1b1f2a;display:grid;place-items:center;cursor:pointer;position:relative;
    color:#cfd3dd;transition:.2s background;}
    .icon-btn:hover{background:#2a2f3d;}
  .top-nav .icon-btn .icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;opacity:.95;}
  .counter-badge{position:absolute;top:-8px;right:-8px;background:#ff5577;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;border:2px solid #0f1115;}
  .counter-badge-streak{position:absolute;top:-8px;right:-8px;background:#fff;color:#222;border-radius:999px;padding:2px 6px;font-size:12px;border:2px solid #0f1115;opacity:.9;}
  /* Wallet */
  .wallet-balance{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;}
  .balance-pill{background:#ffffff12;border:1px solid #ffffff20;border-radius:14px;padding:6px 12px;font-size:14px;}
  .tx-log{display:grid;gap:6px;}
  .tx{display:flex;justify-content:space-between;gap:10px;font-size:13px;padding:6px 10px;border-radius:12px;background:#1c1f29aa;border:1px solid #ffffff14;}
  
  /* Notifications */
  .notif-menu{position:absolute;top:44px;right:0;width:300px;background:#1b1f2acc;
    border:1px solid #ffffff22;border-radius:16px;box-shadow:var(--shadow);
    display:flex;flex-direction:column;gap:6px;padding:10px;z-index:20;backdrop-filter:blur(10px);}
  .notif-item{padding:8px 10px;border-radius:12px;background:#ffffff0d;
    border:1px solid #ffffff14;font-size:13px;display:flex;flex-direction:column;gap:6px;}
  .notif-actions{display:flex;gap:6px;justify-content:flex-end;}
  .notif-item button{font-size:12px;padding:4px 8px;border-radius:8px;}
  
  /* Sections */
  .section{padding:16px;border-radius:26px;border:1px solid #ffffff20;background:var(--card);position:relative;overflow:hidden;}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
  .task-grid{display:grid;grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:12px; transition:.2s filter;}
  .task-box{border:1px solid #ffffff18;background:#1c213080;border-radius:20px;padding:12px;display:flex;flex-direction:column;gap:8px;position:relative;overflow:hidden;transition:.2s transform,.2s background;}
  .task-box.completed{background:linear-gradient(180deg,#0f1c14aa,#13261baa),#1c213080;border-color:#3be68555;}
  .task-weights{display:flex;gap:8px;font-size:12px;color:#cdd2df;}
  .task-weights .pos{color:var(--green);} .task-weights .neg{color:#ff9aa7;}
  .banner{border:1px dashed #ffffff30;background:#1b223480;border-radius:18px;padding:12px;margin-bottom:12px;display:flex;gap:10px;align-items:center;}
  .banner.gold{background:linear-gradient(180deg,#403012aa,#2b1f0faa);border:1px solid #ffd46644;}
  .banner.season{background:linear-gradient(180deg,#243041aa,#1b2535aa);border:1px solid #86b6ff55;}
  /* Grace overlay */
  .grace-mask{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
  .grace-card{pointer-events:auto;padding:14px 16px;border-radius:18px;border:1px solid #ffffff2a;background:#0f1115bb;backdrop-filter:blur(8px);display:flex;align-items:center;gap:10px;}
  .grace-active .task-grid{filter:blur(6px) brightness(.9);}
  /* Settings drawer */
  .settings-drawer{position:fixed;top:24px;right:24px;width:380px;z-index:10;}
  .settings-card{padding:16px;border-radius:26px;border:1px solid #ffffff20;background:var(--card);}
  .settings-row{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px;}
  .settings-tile{border:1px solid #ffffff18;background:#1b1f2a80;border-radius:18px;padding:14px;cursor:pointer;}
  .settings-tile:hover{background:#22283a90;}
  .switch{position:relative;width:46px;height:28px;background:#FFFFFF18;border-radius:20px;cursor:pointer;transition:.2s;background-clip:padding-box;}
  .switch::after{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:999px;transition:.2s;}
  .switch.on{background:#6ecbff44;}
  .switch.on::after{left:21px;}
</style>
<style>
/* === OurFavor Neutral Grey Glass Theme Overrides === */
:root{
  --bg: #0e0f12;
  --card: rgba(24,26,32,0.60);
  --surface: rgba(255,255,255,0.06);
  --on-surface: #eceff3;
  --muted: #b8bcc6;
  --accent: #d7dbe4;
  --blur: 16px;
  --radius: 30px;
  --radius-sm: 20px;
}
/* overall backdrop: neutral dark greys instead of blue */
body{
  background: radial-gradient(1300px 900px at 15% 10%, rgba(255,255,255,0.06), transparent),
              radial-gradient(1400px 950px at 80% 0%, rgba(255,255,255,0.04), transparent),
              radial-gradient(1100px 800px at 50% 100%, rgba(255,255,255,0.03), transparent),
              var(--bg) !important;
}

/* Frosted glass look for all key cards/boxes */
.section, .modal, .settings-card, .settings-tile, .advanced-user,
.task-box, .tab, .icon-btn, .btn, .balance-pill, .notif-menu, .grace-card{
  background:
    radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,0.14), rgba(255,255,255,0.04)) ,
    radial-gradient(140% 140% at 90% 100%, rgba(255,255,255,0.10), rgba(255,255,255,0.05));
  border: 1px solid rgba(255,255,255,0.14);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
}

/* Round corners more aggressively */
.section{ border-radius: 30px !important; }
.modal{ border-radius: 32px !important; }
.settings-card{ border-radius: 28px !important; }
.settings-tile{ border-radius: 22px !important; }
.task-box{ border-radius: 22px !important; }
.tab{ border-radius: 20px !important; }
.icon-btn{ border-radius: 20px !important; }
.btn{ border-radius: 999px !important; } /* buttons pill-like */
.balance-pill{ border-radius: 999px !important; }
.grace-card{ border-radius: 22px !important; }

/* Make chips slightly softer */
.chip{ background: rgba(255,255,255,0.10) !important; border: 1px solid rgba(255,255,255,0.14); }

/* Remove blue tint from banners; keep the gold one but neutralize others */
.banner.season{
  background:
    radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,0.12), rgba(255,255,255,0.04)),
    radial-gradient(140% 140% at 90% 100%, rgba(255,255,255,0.08), rgba(255,255,255,0.04)) !important;
  border: 1px dashed rgba(255,255,255,0.18) !important;
}

/* Avatar circles: subtle glass edge, not blue */
.avatar-circle{
  background:
    radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,0.10), rgba(255,255,255,0.04)),
    rgba(32,35,42,0.6) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
}

/* Tabs and header */
.top-nav{ background: linear-gradient(180deg, rgba(14,15,18,0.95), rgba(14,15,18,0)) !important; }
.tab.active{ background: rgba(255,255,255,0.10) !important; border-color: rgba(255,255,255,0.18) !important; }

/* Wallet items */
.tx{ background: rgba(255,255,255,0.06) !important; border-color: rgba(255,255,255,0.12) !important; }

/* Inputs */
.field input, .field select{
  background: rgba(255,255,255,0.06) !important;
  border-color: rgba(255,255,255,0.16) !important;
}
.field input:focus, .field select:focus{
  border-color: rgba(255,255,255,0.28) !important;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.10) !important;
}

/* Hover states, very soft */
.icon-btn:hover, .settings-tile:hover, .task-box:hover{
  filter: brightness(1.04);
}
</style>
<style>
/* === OurFavor Material-lean Glass Tuning (readability-focused) === */
:root{
  --bg: #0e0f12;
  --glass: rgba(18,20,24,0.62);           /* darker glass for contrast */
  --glass-strong: rgba(18,20,24,0.72);
  --glass-soft: rgba(18,20,24,0.50);
  --stroke: rgba(255,255,255,0.07);       /* subtle outline like M3 */
  --stroke-strong: rgba(255,255,255,0.10);
  --on-surface: #e7e9ee;
  --muted: #b3b8c4;
  --blur: 10px;                           /* cleaner blur */
}
/* Background stays neutral and dark */
body{
  background:
    radial-gradient(1200px 800px at 15% 8%, rgba(255,255,255,0.03), transparent),
    radial-gradient(1400px 900px at 85% 0%, rgba(255,255,255,0.02), transparent),
    var(--bg) !important;
}

/* Replace bright glass gradients with darker, uniform glass */
.section, .modal, .settings-card, .settings-tile, .advanced-user,
.task-box, .tab, .icon-btn, .btn, .balance-pill, .notif-menu, .grace-card{
  background: var(--glass) !important;
  border: 1px solid var(--stroke) !important;
  backdrop-filter: blur(var(--blur)) saturate(1.15) !important;
  -webkit-backdrop-filter: blur(var(--blur)) saturate(1.15) !important;
  box-shadow: 0 10px 24px rgba(0,0,0,0.35) !important;
}

/* Elevation emphasis for modals & drawers */
.modal, .settings-card{ background: var(--glass-strong) !important; border-color: var(--stroke-strong) !important; }
.notif-menu{ background: var(--glass-strong) !important; }

/* Soften chips and inputs for readability */
.chip{ background: rgba(255,255,255,0.08) !important; border: 1px solid var(--stroke) !important; }
.field input, .field select{ background: rgba(255,255,255,0.06) !important; border-color: var(--stroke) !important; }
.field input:focus, .field select:focus{
  border-color: var(--stroke-strong) !important;
  box-shadow: 0 0 0 3px rgba(255,255,255,0.08) !important;
}

/* Tabs and header (reduce brightness) */
.top-nav{ background: linear-gradient(180deg, rgba(14,15,18,0.95), rgba(14,15,18,0)) !important; }
.tab.active{ background: rgba(255,255,255,0.09) !important; border-color: var(--stroke-strong) !important; }
.tab{ background: rgba(255,255,255,0.05) !important; }

/* Banners: clean + readable, no bright blues */
.banner.season{ background: var(--glass) !important; border: 1px dashed var(--stroke-strong) !important; }
.banner.gold{ background: var(--glass) !important; border: 1px dashed rgba(255,212,102,0.35) !important; }

/* Buttons: subtle pills */
.btn.primary{ background: rgba(255,255,255,0.08) !important; }
.btn.ghost{ background: rgba(255,255,255,0.04) !important; }
.btn:hover{ filter: brightness(1.04); }

/* Roundness (kept from earlier but less extreme on content blocks) */
.section{ border-radius: 24px !important; }
.task-box{ border-radius: 18px !important; }
.settings-tile{ border-radius: 18px !important; }
.modal{ border-radius: 24px !important; }
.icon-btn{ border-radius: 16px !important; }
.tab{ border-radius: 16px !important; }
.balance-pill{ border-radius: 999px !important; }
.btn{ border-radius: 999px !important; }

/* Transaction rows: darker for readability */
.tx{ background: rgba(255,255,255,0.05) !important; border-color: var(--stroke) !important; }

/* Avatar circles: subtle, neutral */
.avatar-circle{ background: rgba(32,35,42,0.55) !important; border-color: var(--stroke) !important; }
</style>
<style>
/* === Subtle M3-like blurred gradient overlays (readability-first) === */
:root{
  --glass-surface: rgba(20,22,26,0.58);
  --glass-strong: rgba(20,22,26,0.70);
  --stroke: rgba(255,255,255,0.07);
  --stroke-strong: rgba(255,255,255,0.10);
  --blur-card: 12px;
  --blur-ctl: 8px;
}

/* Base glass for components */
.section, .task-box, .settings-card, .settings-tile, .modal,
.notif-menu, .tab, .btn, .icon-btn, .balance-pill, .avatar-circle,
.chip, .banner {
  position: relative;
  background: var(--glass-surface) !important;
  border: 1px solid var(--stroke) !important;
  backdrop-filter: blur(var(--blur-card)) saturate(1.1) !important;
  -webkit-backdrop-filter: blur(var(--blur-card)) saturate(1.1) !important;
  overflow: hidden;
  box-shadow: 0 10px 24px rgba(0,0,0,0.32) !important;
}

/* Elevation for modal/drawer/menus */
.modal, .settings-card, .notif-menu {
  background: var(--glass-strong) !important;
  border-color: var(--stroke-strong) !important;
}

/* Subtle gradient overlay sheen */
.section::before, .task-box::before, .settings-card::before, .settings-tile::before, .modal::before,
.notif-menu::before, .tab::before, .btn::before, .icon-btn::before, .balance-pill::before,
.avatar-circle::before, .chip::before, .banner::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  border-radius: inherit;
  background:
    radial-gradient(120% 140% at 0% 0%, rgba(255,255,255,0.06), transparent 42%),
    radial-gradient(120% 140% at 100% 0%, rgba(255,255,255,0.035), transparent 46%),
    linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0) 70%);
}

/* Controls use lighter blur to feel crisp */
.btn, .icon-btn, .tab, .balance-pill, .chip { 
  backdrop-filter: blur(var(--blur-ctl)) saturate(1.1) !important;
  -webkit-backdrop-filter: blur(var(--blur-ctl)) saturate(1.1) !important;
}

/* Hover micro-elevation */
.settings-tile:hover, .task-box:hover, .btn:hover, .tab:hover, .icon-btn:hover {
  box-shadow: 0 12px 28px rgba(0,0,0,0.36) !important;
  filter: brightness(1.035);
}

/* Keep banners neutral but readable */
.banner.season, .banner.gold {
  background: var(--glass-surface) !important;
  border-style: dashed !important;
  border-color: var(--stroke-strong) !important;
}
</style>
<style>
/* === Polished Glass + Notification Fixes (Material-lean) === */
/* Make parent buttons not clip dropdowns/badges */
.icon-btn{ overflow: visible !important; }
/* Badges above overlay */
.counter-badge, .counter-badge-streak{ z-index: 3 !important; }
/* Reliable dropdown anchor */
#notifBtn{ position: relative; }
.notif-menu{ position: absolute !important; right: 0 !important; top: calc(100% + 8px) !important; z-index: 50 !important;
  border-radius: 16px !important; }
/* Tone down surfaces and give clean blur */
.section, .task-box, .settings-card, .settings-tile, .modal,
.notif-menu, .tab, .btn, .icon-btn, .balance-pill, .avatar-circle,
.chip, .banner {
  background: rgba(20,22,26,0.55) !important;
  border: 1px solid rgba(255,255,255,0.065) !important;
  backdrop-filter: blur(12px) saturate(1.05) !important;
  -webkit-backdrop-filter: blur(12px) saturate(1.05) !important;
  box-shadow: 0 8px 22px rgba(0,0,0,0.38) !important;
}
/* Replace loud overlays with a subtle top sheen */
.section::before, .task-box::before, .settings-card::before, .settings-tile::before, .modal::before,
.notif-menu::before, .tab::before, .btn::before, .icon-btn::before, .balance-pill::before,
.avatar-circle::before, .chip::before, .banner::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  border-radius: inherit;
  background:
    linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(255,255,255,0.02) 14%, rgba(255,255,255,0) 40%);
}
</style>

<style>
/* === Subtle shadow tuning (less heavy, more M3-like) === */
.section, .task-box, .settings-card, .settings-tile, .modal,
.notif-menu, .tab, .btn, .icon-btn, .balance-pill, .avatar-circle, .chip, .banner {
  box-shadow: 0 4px 14px rgba(0,0,0,0.22), 0 1px 0 rgba(255,255,255,0.02) !important;
}
.settings-tile:hover, .task-box:hover, .btn:hover, .tab:hover, .icon-btn:hover {
  box-shadow: 0 6px 16px rgba(0,0,0,0.26) !important;
}

/* === Completion animation (subtle green, preserves glass) === */
.task-box{
  transition: background 200ms ease, border-color 200ms ease, box-shadow 200ms ease, transform 150ms ease;
  position: relative;
}
@keyframes completePulse {
  0%   { box-shadow: 0 0 0 0 rgba(82, 255, 178, .35); }
  100% { box-shadow: 0 0 0 14px rgba(82, 255, 178, 0); }
}
.task-box.completed{
  background: linear-gradient(180deg, rgba(34, 70, 50, 0.55), rgba(20, 44, 32, 0.50)), rgba(20, 22, 26, 0.58) !important;
  border-color: rgba(82, 255, 178, 0.35) !important;
}
/* keep the subtle top sheen but with a tiny green tint when completed */
.task-box.completed::before{
  background: linear-gradient(to bottom, rgba(130, 255, 190, 0.07), rgba(255,255,255,0.02) 14%, rgba(255,255,255,0) 40%) !important;
}
.task-box.completed::after{
  content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit;
  animation: completePulse 500ms ease-out;
}
</style>


<style>
/* === Flat Glass Theme (no 3D, clean blur) === */

/* 1) Surfaces: flat glass with subtle gradient, no heavy shadows */
:root{
  --flat-surface-a: rgba(255,255,255,0.055);
  --flat-surface-b: rgba(255,255,255,0.030);
  --flat-stroke: rgba(255,255,255,0.07);
}
.section, .task-box, .settings-card, .settings-tile, .modal,
.notif-menu, .tab, .btn, .icon-btn, .balance-pill, .avatar-circle,
.chip, .banner {
  background:
    linear-gradient(135deg, var(--flat-surface-a), var(--flat-surface-b)) !important;
  border: 1px solid var(--flat-stroke) !important;
  box-shadow: none !important;                    /* flat look */
  backdrop-filter: blur(12px) saturate(1.05) !important;
  -webkit-backdrop-filter: blur(12px) saturate(1.05) !important;
  transform: none !important;                     /* no lift on hover */
}

/* 2) Remove sheen overlays from earlier theme */
.section::before, .task-box::before, .settings-card::before, .settings-tile::before, .modal::before,
.notif-menu::before, .tab::before, .btn::before, .icon-btn::before, .balance-pill::before,
.avatar-circle::before, .chip::before, .banner::before {
  content: none !important;
}

/* 3) Hover states remain flat (just tiny brightness) */
.settings-tile:hover, .task-box:hover, .btn:hover, .tab:hover, .icon-btn:hover {
  filter: brightness(1.02);
  box-shadow: none !important;
}

/* 4) Completion animation: flat green fade (no pulse/glow) */
.task-box{
  transition: background 200ms ease, border-color 200ms ease;
}
.task-box.completed{
  background: linear-gradient(135deg, rgba(82, 255, 178, 0.12), rgba(82, 255, 178, 0.08)) !important;
  border-color: rgba(82, 255, 178, 0.28) !important;
}
.task-box.completed::after{ content:none !important; }  /* remove pulse from earlier */

/* 5) Keep notification badges and dropdown functional/visible */
.icon-btn{ overflow: visible !important; }
.counter-badge, .counter-badge-streak{ z-index: 3 !important; }
#notifBtn{ position: relative !important; }
.notif-menu{ position: absolute !important; right: 0 !important; top: calc(100% + 8px) !important; z-index: 50 !important; }
</style>


<style>
/* === Readability pass: darker, less transparent glass === */

/* Make base surfaces slightly darker (still lighter than backdrop) */
:root{
  --flat-surface-a: rgba(255,255,255,0.035);
  --flat-surface-b: rgba(255,255,255,0.018);
  --flat-stroke: rgba(255,255,255,0.06);
}

/* Apply updated surface vars to flat-glass components */
.section, .task-box, .settings-tile, .tab, .btn, .icon-btn, .balance-pill, .avatar-circle, .chip, .banner {
  background: linear-gradient(135deg, var(--flat-surface-a), var(--flat-surface-b)) !important;
  border-color: var(--flat-stroke) !important;
  backdrop-filter: blur(12px) saturate(1.05) !important;
  -webkit-backdrop-filter: blur(12px) saturate(1.05) !important;
}

/* High-elevation surfaces: darker, more opaque for readability */
.settings-card, .modal, .notif-menu {
  background: rgba(18,20,24,0.86) !important;        /* darker glass */
  border: 1px solid rgba(255,255,255,0.10) !important;
  backdrop-filter: blur(14px) saturate(1.05) !important;
  -webkit-backdrop-filter: blur(14px) saturate(1.05) !important;
}

/* Ensure dropdown isn't clipped and sits above */
#notifBtn{ position: relative !important; }
.notif-menu{ position: absolute !important; right: 0 !important; top: calc(100% + 8px) !important; z-index: 60 !important; }
.icon-btn{ overflow: visible !important; }
.counter-badge, .counter-badge-streak{ z-index: 3 !important; }
</style>


<style>
/* === Modal backdrop: dark, blurred gradient (flat glass style) === */
.modal-backdrop{
  background:
    radial-gradient(120% 120% at 20% 0%, rgba(10,12,16,0.78), rgba(10,12,16,0.62)),
    radial-gradient(120% 120% at 80% 100%, rgba(10,12,16,0.70), rgba(10,12,16,0.50));
  backdrop-filter: blur(14px) saturate(1.02);
  -webkit-backdrop-filter: blur(14px) saturate(1.02);
}
</style>


<style>
/* === Per-user accent theming (scoped to dashboard + its modals) === */
/* We'll derive rgba() values from --accent-rgb set by JS */
:root{ --accent-rgb: 107,134,255; } /* fallback */
#dashboard .section, #dashboard .task-box, #dashboard .settings-card, #dashboard .settings-tile,
#dashboard .tab, #dashboard .btn, #dashboard .icon-btn, #dashboard .balance-pill, #dashboard .avatar-circle,
#dashboard .chip, #dashboard .banner {
  background:
    linear-gradient(135deg, var(--flat-surface-a, rgba(255,255,255,0.035)), var(--flat-surface-b, rgba(255,255,255,0.018))),
    radial-gradient(120% 120% at 0% 0%, rgba(var(--accent-rgb), 0.08), transparent 56%) !important;
  border-color: rgba(var(--accent-rgb), 0.12) !important;
}
/* Stronger accent for primaries and active states */
#dashboard .btn.primary, #dashboard .tab.active {
  background:
    linear-gradient(135deg, rgba(var(--accent-rgb), 0.28), rgba(var(--accent-rgb), 0.16)) !important;
  border-color: rgba(var(--accent-rgb), 0.22) !important;
}
#dashboard .chip{ border-color: rgba(var(--accent-rgb), 0.22) !important; }

/* Modal surfaces inherit accent; backdrop gets a faint accent glow */
#modalRoot .modal, #modalRoot .settings-card, #modalRoot .notif-menu {
  background:
    linear-gradient(135deg, rgba(18,20,24,0.86), rgba(18,20,24,0.80)),
    radial-gradient(120% 120% at 0% 0%, rgba(var(--accent-rgb), 0.05), transparent 60%) !important;
  border-color: rgba(var(--accent-rgb), 0.12) !important;
}
#modalRoot .modal-backdrop{
  background:
    radial-gradient(120% 120% at 20% 0%, rgba(10,12,16,0.78), rgba(10,12,16,0.62)),
    radial-gradient(120% 120% at 80% 100%, rgba(10,12,16,0.70), rgba(10,12,16,0.50)),
    radial-gradient(120% 140% at 50% 50%, rgba(var(--accent-rgb), 0.05), transparent 60%) !important;
}

/* Keep UI flat and readable */
#dashboard .section, #dashboard .task-box, #dashboard .settings-card, #dashboard .settings-tile, #modalRoot .modal, #modalRoot .notif-menu {
  box-shadow: none !important;
}
</style>


<style>
/* === Heavier profile-colored theming for dashboard modals (readable, flat) === */
#modalRoot .modal, #modalRoot .settings-card, #modalRoot .notif-menu {
  /* Dark, high-contrast glass with accent tint */
  background:
    linear-gradient(180deg, rgba(10,12,16,0.96), rgba(10,12,16,0.92)),
    radial-gradient(120% 140% at 0% 0%, rgba(var(--accent-rgb), 0.10), transparent 58%) !important;
  border: 1px solid rgba(var(--accent-rgb), 0.22) !important;
  backdrop-filter: blur(16px) saturate(1.05) !important;
  -webkit-backdrop-filter: blur(16px) saturate(1.05) !important;
  color: #eceff6 !important;
  box-shadow: none !important; /* keep it flat */
}
/* Inputs inside modals: slightly darker fields for readability */
#modalRoot .modal .field input, #modalRoot .modal .field select {
  background: rgba(255,255,255,0.06) !important;
  border: 1px solid rgba(255,255,255,0.14) !important;
  color: #eef1f7 !important;
}
#modalRoot .modal .field input::placeholder, #modalRoot .modal .field select::placeholder {
  color: rgba(255,255,255,0.55) !important;
}
/* Modal titles & buttons get a stronger accent */
#modalRoot .modal .title { color: #f5f7fb !important; }
#modalRoot .modal .btn.primary{
  background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.20), rgba(var(--accent-rgb), 0.14)) !important;
  border-color: rgba(var(--accent-rgb), 0.22) !important;
}
#modalRoot .modal .btn.ghost{
  background: rgba(255,255,255,0.05) !important;
  border-color: rgba(255,255,255,0.10) !important;
}
/* Modal backdrop stays dark but with a slight stronger accent halo */
#modalRoot .modal-backdrop{
  background:
    radial-gradient(120% 120% at 20% 0%, rgba(10,12,16,0.86), rgba(10,12,16,0.72)),
    radial-gradient(120% 120% at 80% 100%, rgba(10,12,16,0.80), rgba(10,12,16,0.62)),
    radial-gradient(120% 140% at 50% 50%, rgba(var(--accent-rgb), 0.05), transparent 60%) !important;
  backdrop-filter: blur(16px) saturate(1.02) !important;
  -webkit-backdrop-filter: blur(16px) saturate(1.02) !important;
}
/* Slightly heavier accent across dashboard surfaces too */
#dashboard .section, #dashboard .task-box, #dashboard .settings-card, #dashboard .settings-tile,
#dashboard .tab, #dashboard .btn, #dashboard .icon-btn, #dashboard .balance-pill, #dashboard .avatar-circle,
#dashboard .chip, #dashboard .banner {
  background:
    linear-gradient(135deg, var(--flat-surface-a, rgba(255,255,255,0.035)), var(--flat-surface-b, rgba(255,255,255,0.018))),
    radial-gradient(120% 120% at 0% 0%, rgba(var(--accent-rgb), 0.06), transparent 56%) !important;
  border-color: rgba(var(--accent-rgb), 0.22) !important;
}
</style>


<style>
/* === Stronger accent & darker Settings drawer (flat & readable) === */

/* 1) Slightly stronger accent across dashboard surfaces */
#dashboard .section, #dashboard .task-box, #dashboard .settings-card, #dashboard .settings-tile,
#dashboard .tab, #dashboard .btn, #dashboard .icon-btn, #dashboard .balance-pill, #dashboard .avatar-circle,
#dashboard .chip, #dashboard .banner {
  background:
    linear-gradient(135deg, var(--flat-surface-a, rgba(255,255,255,0.035)), var(--flat-surface-b, rgba(255,255,255,0.018))),
    radial-gradient(120% 120% at 0% 0%, rgba(var(--accent-rgb), 0.06), transparent 56%) !important;
  border-color: rgba(var(--accent-rgb), 0.14) !important;
}

/* 2) Settings drawer panel: darker glass + stronger accent tint */
#settingsDrawer .settings-card{
  background:
    linear-gradient(180deg, rgba(10,12,16,0.94), rgba(10,12,16,0.90)),
    radial-gradient(120% 140% at 0% 0%, rgba(var(--accent-rgb), 0.12), transparent 60%) !important;
  border: 1px solid rgba(var(--accent-rgb), 0.24) !important;
  color: #eef2f8 !important;
  backdrop-filter: blur(14px) saturate(1.05) !important;
  -webkit-backdrop-filter: blur(14px) saturate(1.05) !important;
}

/* 3) Settings tiles inside the drawer: darker and readable */
#settingsDrawer .settings-tile{
  background:
    linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.018)),
    radial-gradient(120% 140% at 0% 0%, rgba(var(--accent-rgb), 0.05), transparent 60%) !important;
  border-color: rgba(var(--accent-rgb), 0.12) !important;
  color: #e9edf4 !important;
}

/* 4) Meta text and chips readable on dark panel */
#settingsDrawer .chip{ border-color: rgba(var(--accent-rgb), 0.14) !important; background: rgba(255,255,255,0.08) !important; }
#settingsDrawer .settings-card .row div[style*="color:var(--muted)"]{ color: #c9ced8 !important; }
</style>


<style>
/* Remove nav-only vertical gradient; keep sticky + blur */
.top-nav{
  background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0)) !important;
}
</style>

<style>
/* Strong accent flash when tasks complete (uses --accent-rgb from profile color) */
@keyframes taskAccentBlast {
  0%   { background: linear-gradient(135deg, rgba(var(--accent-rgb,107,134,255), 0.90), rgba(var(--accent-rgb,107,134,255), 0.72)); }
  100% { background: linear-gradient(135deg, rgba(var(--accent-rgb,107,134,255), 0.52), rgba(var(--accent-rgb,107,134,255), 0.38)); }
}
#dashboard .task-box{ transition: background 240ms ease, border-color 240ms ease; }
#dashboard .task-box.completed{
  background: linear-gradient(135deg, rgba(var(--accent-rgb,107,134,255), 0.52), rgba(var(--accent-rgb,107,134,255), 0.38)) !important;
  border-color: rgba(var(--accent-rgb,107,134,255), 0.62) !important;
  animation: taskAccentBlast 260ms ease-out;
}
/* Ensure no leftover green pulse overrides this */
#dashboard .task-box.completed::after{ content: none !important; }
#dashboard .task-box.completed::before{
  background: linear-gradient(to bottom, rgba(var(--accent-rgb,107,134,255), 0.08), rgba(255,255,255,0.02) 14%, rgba(255,255,255,0) 40%) !important;
}
</style>


<style>
/* Hide the 'Undo' button, but keep all JS/logic intact */
.task-undo{ display:none !important; }
</style>


<style>
/* Scrollable settings lists (no visible scrollbar) */
#t_list, #w_list, #s_list{
  max-height: 60vh;
  overflow-y: auto;
  -ms-overflow-style: none;   /* IE/Edge */
  scrollbar-width: none;      /* Firefox */
}
#t_list::-webkit-scrollbar,
#w_list::-webkit-scrollbar,
#s_list::-webkit-scrollbar{
  display: none;
}
</style>


<style>
/* Wallet progressive enhancement (non-destructive) */
#walletTab .wallet-grid{
  display:grid; gap:16px;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  margin-bottom: 6px;
}
#walletTab .wallet-card{
  border:1px solid rgba(255,255,255,0.10);
  background: linear-gradient(135deg, rgba(255,255,255,0.045), rgba(255,255,255,0.024));
  backdrop-filter: blur(12px) saturate(1.05);
  -webkit-backdrop-filter: blur(12px) saturate(1.05);
  border-radius:16px; padding:14px;
}
#walletTab .wallet-card .name{ font-weight:600; opacity:.92; }
#walletTab .wallet-card .favor{ font-size:26px; font-weight:700; margin-top:4px; }
#walletTab .wallet-card .grace{ margin-top:4px; font-size:12px; opacity:.8; }

#walletTab .wallet-actions{ display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 4px; }
#walletTab .wallet-actions .btn{ flex:1 1 160px; }

#walletTab .txn-header{ display:flex; align-items:center; justify-content:space-between; margin:10px 0 8px; }
#walletTab .txn-title{ font-weight:600; opacity:.9; }
#walletTab .kebab{ width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; }
#walletTab .kebab:hover{ filter:brightness(1.06); cursor:pointer; }
#walletTab .kebab-menu{
  position:absolute; right:10px; top:44px; z-index:50;
  background: rgba(18,20,24,0.92);
  border: 1px solid rgba(255,255,255,0.10);
  backdrop-filter: blur(14px) saturate(1.05);
  -webkit-backdrop-filter: blur(14px) saturate(1.05);
  border-radius:14px; padding:10px; min-width:240px; display:none;
}
#walletTab .kebab-menu.open{ display:block; }
#walletTab .kebab-menu .row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
#walletTab .kebab-menu label{ font-size:13px; opacity:.9; }

/* Scrollable tx list with hidden scrollbar */
#txLog{
  max-height: 48vh;
  overflow-y: auto;
  -ms-overflow-style: none; scrollbar-width: none;
  position: relative;
}
#txLog::-webkit-scrollbar{ display:none; }
</style>


<style>
/* --- Wallet layout tweaks (CSS-only) --- */
/* 1) Horizontal balance cards row with side-scroll (no visible scrollbar) */
#walletTab .wallet-grid{
  display: flex !important;
  flex-wrap: nowrap !important;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  gap: 16px !important;
  padding-bottom: 4px;
  -ms-overflow-style: none;        /* IE/Edge */
  scrollbar-width: none;           /* Firefox */
}
#walletTab .wallet-grid::-webkit-scrollbar{ display:none; }
#walletTab .wallet-card{ flex: 0 0 260px !important; }

/* 2) Kebab menu should drop *beneath* the icon */
#walletTab .txn-header{ position: relative; }
#walletTab .kebab-menu{
  top: calc(100% + 8px) !important;
  right: 0 !important;
}
</style>


<style>
/* Dynamic, responsive balance cards (fill available space) */
#walletTab .wallet-grid{
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)) !important;
  gap: 16px !important;
  overflow: visible !important;
}
/* Let cards expand naturally within the grid */
#walletTab .wallet-card{
  flex: 1 1 auto !important;
  width: auto !important;
}
</style>


<style>
/* Horizontal, responsive balance cards (fill width + side-scroll) */
#walletTab .wallet-grid{
  display: grid !important;
  grid-auto-flow: column !important;                 /* force a single horizontal row of columns */
  grid-auto-columns: minmax(240px, 1fr) !important;  /* each card grows to fill available width */
  gap: 16px !important;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  -ms-overflow-style: none;          /* IE/Edge */
  scrollbar-width: none;             /* Firefox */
  padding-bottom: 4px;
}
#walletTab .wallet-grid::-webkit-scrollbar{ display:none; } /* Hide scrollbar in WebKit */
#walletTab .wallet-card{ width: auto !important; }
</style>


<style>
/* --- Wallet balance cards: dynamic horizontal fill --- */
#walletTab .wallet-grid{
  display: flex !important;
  flex-wrap: nowrap !important;
  width: 100% !important;
  gap: 16px !important;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  -ms-overflow-style: none;  /* IE/Edge */
  scrollbar-width: none;     /* Firefox */
  padding-bottom: 4px;
}
#walletTab .wallet-grid::-webkit-scrollbar{ display:none; }
#walletTab .wallet-card{
  flex: 1 1 240px !important;     /* grow to fill, but don't shrink below 240px */
  min-width: 240px !important;
  width: auto !important;
}
</style>


<style>
/* Ensure kebab menu isn't clipped by container overflow */
#walletTab .section, #walletTab .section .section-body{ overflow: visible !important; }
</style>


<style>
/* Grace overlay: fixed, blurred, readable */
.grace-mask{
  position: fixed !important;
  inset: 0 !important;
  z-index: 50 !important;
  display: flex !important;
  align-items: center;
  justify-content: center;
  background: radial-gradient(120% 120% at 50% 10%, rgba(15,18,24,0.55), rgba(10,12,18,0.75));
  backdrop-filter: blur(10px) saturate(1.05);
  -webkit-backdrop-filter: blur(10px) saturate(1.05);
  pointer-events: auto !important;
}
.grace-card{
  border-radius: 18px !important;
  border: 1px solid rgba(255,255,255,0.14) !important;
  background: rgba(27,31,42,0.85) !important;
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
}
.hidden{ display:none !important; }
</style>


<style>
/* Settings form label alignment for time input */
#cutoffLocalRow label{ opacity:.9; }
</style>

</head>
<body>
<div id="app">
  <!-- Profile Selection -->
  <section id="profileScreen" class="screen fade-in">
    <div class="chip" style="opacity:.7">OurFavor</div>
    <h1>Choose an account</h1>
    <div id="profileRow" class="profiles-row"></div>
    <div class="manage-row">
      <button id="toggleAdvanced" class="btn ghost">Advanced View</button>
    </div>
    <div id="advancedArea" class="hidden">
      <div id="advancedList" class="grid"></div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" class="screen hidden">
    <div class="top-nav">
      <div id="dashAvatar" class="avatar" title="Back to profiles"></div>
      <div class="tabs">
        <div class="tab active" data-tab="tasks">Tasks</div>
        <div class="tab hidden" data-tab="seasonal">Seasonal</div>
        <div class="tab" data-tab="watch">The Watch</div>
        <div class="tab" data-tab="wallet">Wallet</div>
      </div>
      <div class="spacer"></div>

      <div id="notifBtn" class="icon-btn" title="Notifications">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2z"></path>
          <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 9h18c0-2-3-2-3-9z"></path>
        </svg>
        <span id="notifCount" class="counter-badge hidden">0</span>
        <div id="notifMenu" class="notif-menu hidden"></div>
      </div>

      <div id="streak" class="icon-btn" title="Heat Streak"><span class="icon" aria-label="fire" role="img" style="font-size:20px;line-height:1;display:flex;align-items:center;justify-content:center;">üî•</span>
        <span id="streakCount" class="counter-badge-streak">0</span>
      </div>

      <div id="settingsBtn" class="icon-btn" title="Settings">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.66 0 1.26-.39 1.51-1 .25-.57.17-1.24-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06c.5.5 1.25.58 1.82.33H9c.66 0 1.26-.39 1.51-1V3a2 2 0 1 1 4 0v.09c0 .66.39 1.26 1 1.51.57.25 1.24.17 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.5.5-.58 1.25-.33 1.82.25.61.85 1 1.51 1H21a2 2 0 1 1 0 4h-.09c-.66 0-1.26.39-1.51 1z"/>
        </svg>
      </div>
    </div>

    <!-- Settings Drawer -->
    <div id="settingsDrawer" class="settings-drawer hidden">
      <div class="settings-card">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:10px">
            <div class="avatar" style="width:40px;height:40px;">
              <div id="settingsAvatar" class="initial">?</div>
              <img id="settingsAvatarImg" class="hidden" alt="">
            </div>
            <div>
              <div style="font-weight:700" id="settingsUserName">User</div>
              <div id="settingsDateTime" style="color:var(--muted); font-size:12px">‚Äî</div>
            </div>
          </div>
          <button class="btn ghost" id="closeSettings">Close</button>
        </div>
        <div class="settings-row">
          <div class="settings-tile" data-cat="general"><div class="row" style="justify-content:space-between"><div>General</div><div class="chip">Cutoff (device time), Rush Hour</div></div></div>
          <div class="settings-tile" data-cat="tasks">Tasks</div>
          <div class="settings-tile" data-cat="seasonal">Seasonal</div>
          <div class="settings-tile" data-cat="watch">The Watch</div>
          <div class="settings-tile" data-cat="away">Away</div>
          <div class="settings-tile" data-cat="export">Export / Import</div>
        </div>
      </div>
    </div>

    <!-- Tabs content -->
    <div id="tabContent" class="grid">
      <div id="tasksTab" class="grid fade-in">
        <div id="rushBanner" class="banner gold hidden">
          <strong>Rush Hour</strong> Extra favor active now. Complete tasks in this hour for a bonus!
        </div>
        <div id="seasonalBanner" class="banner season hidden">
          <strong>It's the season for cleaning.</strong>
          <span>New tasks available in Seasonal tab. Complete by <span id="seasonDeadlineTxt">‚Äî</span>.</span>
          <button id="dismissSeasonal" class="btn ghost">Dismiss</button>
        </div>

        <div id="dailySection" class="section">
          <div class="section-header">
            <div class="row">
              <h3 style="margin:0">Daily Tasks</h3>
              <span class="chip" id="cutoffChip">Cutoff ‚Äî</span>
            </div>
            <div class="row">
              <button id="swapBtn" class="btn ghost">Swap</button>
              <button id="useGraceBtn" class="btn primary">Use Grace (<span id="graceCount">0</span>)</button>
            </div>
          </div>
          <div id="dailyGrid" class="task-grid"></div>
          <div id="graceMask" data-for-user="" class="grace-mask hidden">
            <div class="grace-card"><span class="chip">üõ°Ô∏è</span> <strong>Grace Activated</strong> <button id="undoGraceBtn" class="btn ghost">Undo</button> <button id="okGraceBtn" class="btn primary">OK</button></div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 style="margin:0">Weekly Tasks</h3>
            <div class="chip" id="weekChip">Week ‚Äî</div>
          </div>
          <div id="weeklyGrid" class="task-grid"></div>
        </div>
      </div>

      <div id="seasonalTab" class="grid hidden fade-in">
        <div class="section">
          <div class="section-header">
            <h3 style="margin:0">Seasonal Tasks</h3>
            <div class="chip">Deadline: <span id="seasonDeadlineTxt2">‚Äî</span></div>
          </div>
          <div id="seasonalGrid" class="task-grid"></div>
        </div>
      </div>

      <div id="watchTab" class="grid hidden fade-in">
        <div class="section">
          <div class="section-header">
            <h3 style="margin:0">The Watch</h3>
            <div class="chip" id="watchRulesCount">‚Äî</div>
          </div>
          <div id="watchGrid" class="task-grid"></div>
        </div>
      </div>

      <div id="walletTab" class="grid hidden fade-in">
        <div class="section">
          <div class="section-header">
            <h3 style="margin:0">Wallet</h3>
            <div class="row">
              <button id="redeemBtn" class="btn ghost">Redeem Favor</button>
              <button id="tradeBtn" class="btn ghost">Trade Favor</button>
              <button id="grantGraceBtn" class="btn ghost">Add Grace</button>
            </div>
          </div>
          <div class="wallet-balance" id="walletBalances"></div>
          <div class="tx-log" id="txLog"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="modalRoot"></div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => (n%1 ? n.toFixed(2) : n.toString());
const uid = () => Math.random().toString(36).slice(2,9);
const todayStr = () => new Date().toISOString().slice(0,10);
const startOfWeek = (d=new Date()) => { const dt = new Date(d); const day = (dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt; };
const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));


function hexToRgb(hex){
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||''); 
  if(!m) return {r:107,g:134,b:255};
  return {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)};
}
function applyUserTheme(colorHex){
  const {r,g,b} = hexToRgb(colorHex||'#6b86ff');
  document.documentElement.style.setProperty('--accent-rgb', r + ', ' + g + ', ' + b);
}

const State = {
  load(){
    const raw = localStorage.getItem('ourfavor_state');
    if(raw){ try{ this.data = JSON.parse(raw);}catch(e){ this.seed(); } } else { this.seed(); }
    if(!this.data.system) this.data.system = {};
    if(!this.data.system.lastDailyDist) this.data.system.lastDailyDist = todayStr();
    if(!this.data.system.lastWeeklyDist) this.data.system.lastWeeklyDist = startOfWeek().toISOString();
    if(!this.data.system.rush){ this.data.system.rush = {window:[8,21], hour: null, date: todayStr(), bonus: 0.5} }
    if(this.data.system.seasonalBannerDismissed === undefined) this.data.system.seasonalBannerDismissed = false;
    if(!this.data.settings) this.data.settings = this.defaultSettings();
    this.save();
  },
  save(){ localStorage.setItem('ourfavor_state', JSON.stringify(this.data)); },
  seed(){
    const users = [
      {id:uid(), name:'Blake', favor: 12, pin:'', grace:2, away:[], avatarColor:'#6b86ff', avatarUrl:''},
      {id:uid(), name:'Sneefli', favor: 10, pin:'', grace:2, away:[], avatarColor:'#86d38f', avatarUrl:''}
    ];
    const allTasks = [
      {id:uid(), room:'Kitchen', title:'Dishes', freq:'daily', pos:1, neg:0.5, icon:'üçΩÔ∏è'},
      {id:uid(), room:'Living', title:'Vacuum', freq:'daily', pos:1, neg:0.5, icon:'üßπ'},
      {id:uid(), room:'Bathroom', title:'Mirror & Sink', freq:'daily', pos:1, neg:0.5, icon:'ü™û'},
      {id:uid(), room:'Bedroom', title:'Laundry', freq:'weekly', pos:3, neg:1.5, icon:'üß∫'},
      {id:uid(), room:'Kitchen', title:'Fridge Clean', freq:'weekly', pos:2, neg:1, icon:'üßº'}
    ];
    const rules = [
      {id:uid(), title:'No dishes left overnight', weight:0.25},
      {id:uid(), title:'Shoes off at entry', weight:0.25},
      {id:uid(), title:'Wipe counters after cooking', weight:0.25}
    ];
    this.data = {
      users,
      currentUserId: users[0].id,
      notifications: [], walletTx: [],
      settings: this.defaultSettings(),
      system: { lastDailyDist: todayStr(), lastWeeklyDist: startOfWeek().toISOString(), rush:{window:[8,21],hour:null,date:todayStr(),bonus:0.5}, seasonalBannerDismissed:false },
      catalog: { tasks: allTasks, rules, seasonal: {enabled:false, deadline: todayStr(), tasks: []} },
      assignments: { daily:{}, weekly:{}, seasonal:{} },
      swaps: []
    };
    this.distributeDaily(); this.distributeWeekly(); this.save();
  },
  defaultSettings(){ return { timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Chicago', dailyCutoffHour: 22, rush:{window:[8,21],bonus:0.5}, seasonal:{enabled:false, deadline: todayStr()} }; },
  get currentUser(){ return this.data.users.find(u=>u.id===this.data.currentUserId); },
  set currentUser(u){ this.data.currentUserId = u.id; this.save(); },
  userById(id){ return this.data.users.find(u=>u.id===id); },
  userIds(){ return this.data.users.map(u=>u.id); },
  presentUsers(){ const today = new Date(); return this.data.users.filter(u=>!u.away?.some(a=> new Date(a.start)<=today && today<=new Date(a.end) )); },
  distributeDaily(){
    const daily = this.data.catalog.tasks.filter(t=>t.freq==='daily');
    const users = this.presentUsers(); if(!users.length) return;
    const sorted = [...daily].sort((a,b)=>(b.pos+b.neg)-(a.pos+a.neg));
    const buckets = new Map(users.map(u=>[u.id,{risk:0,list:[]}]));

    for(const t of sorted){
      const pick = users.map(u=>({u, r:buckets.get(u.id).risk})).sort((a,b)=>a.r-b.r)[0].u;
      buckets.get(pick.id).list.push({taskId:t.id, completed:false, date: todayStr()});
      buckets.get(pick.id).risk += (t.pos + t.neg);
    }
    this.data.assignments.daily = {}; for(const [uid,v] of buckets.entries()){ this.data.assignments.daily[uid] = v.list; }
    this.data.system.lastDailyDist = todayStr();
  },
  distributeWeekly(){
    const weekly = this.data.catalog.tasks.filter(t=>t.freq==='weekly');
    const users = this.presentUsers(); if(!users.length) return;
    const sorted = [...weekly].sort((a,b)=>(b.pos+b.neg)-(a.pos+a.neg));
    const buckets = new Map(users.map(u=>[u.id,{risk:0,list:[]}]));

    for(const t of sorted){
      const pick = users.map(u=>({u, r:buckets.get(u.id).risk})).sort((a,b)=>a.r-b.r)[0].u;
      buckets.get(pick.id).list.push({taskId:t.id, completed:false, weekStartISO: startOfWeek().toISOString()});
      buckets.get(pick.id).risk += (t.pos + t.neg);
    }
    this.data.assignments.weekly = {}; for(const [uid,v] of buckets.entries()){ this.data.assignments.weekly[uid] = v.list; }
    this.data.system.lastWeeklyDist = startOfWeek().toISOString();
  },
  ensureRushForToday(){
    const sys = this.data.system; const s = this.data.settings.rush || {window:[8,21],bonus:0.5};
    if(sys.rush.date !== todayStr()){ const [start,end]=s.window; sys.rush.hour=Math.floor(Math.random()*(end-start+1))+start; sys.rush.date=todayStr(); sys.rush.bonus=s.bonus; }
    else if(sys.rush.hour==null){ const [start,end]=s.window; sys.rush.hour=Math.floor(Math.random()*(end-start+1))+start; sys.rush.bonus=s.bonus; }
  },
  isRushActive(){ this.ensureRushForToday(); const h=this.data.system.rush.hour; return (new Date()).getHours()===h; }
};
State.load();

/* Modal helpers */
const modalRoot = $('#modalRoot');
function closeModal(){ modalRoot.innerHTML=''; }
function openModal(content, fullPage=false){
  const wrapper=document.createElement('div'); wrapper.className='modal-backdrop'; wrapper.addEventListener('click',e=>{ if(e.target===wrapper) closeModal(); });
  const modal=document.createElement('div'); modal.className='modal'; if(fullPage) wrapper.classList.add('fp-modal'); modal.innerHTML=content;
  wrapper.appendChild(modal); modalRoot.innerHTML=''; modalRoot.appendChild(wrapper); return modal;
}

/* Profiles */
const profileRow = $('#profileRow');
const advancedArea = $('#advancedArea');
const advancedList = $('#advancedList');
const toggleAdvancedBtn = $('#toggleAdvanced');

function renderProfiles(){
  profileRow.innerHTML='';
  State.data.users.forEach(u=>{
    const wrap=document.createElement('div'); wrap.style.textAlign='center';
    const circle=document.createElement('div'); circle.className='avatar-circle fade-up';
    if(u.avatarUrl){ circle.innerHTML=`<img src="${u.avatarUrl}" alt="${u.name}">`; } else { circle.style.background=u.avatarColor; circle.innerHTML=`<div class="initial">${u.name[0].toUpperCase()}</div>`; }
    let pressTimer=null;
    circle.addEventListener('mousedown', ()=>{ pressTimer=setTimeout(()=>openManageUserModal(u),500); });
    ['mouseup','mouseleave'].forEach(evt=>circle.addEventListener(evt, ()=>{ if(pressTimer){clearTimeout(pressTimer); pressTimer=null;} }));
    circle.addEventListener('click', ()=>{
      if(pressTimer){clearTimeout(pressTimer); pressTimer=null;}
      if(u.pin){ const pin=prompt('Enter PIN (4 digits):')||''; if(pin!==u.pin){ alert('Incorrect PIN'); return; } }
      State.currentUser=u; switchToDashboard();
    });
    const label=document.createElement('div'); label.className='avatar-label'; label.textContent=u.name;
    wrap.appendChild(circle); wrap.appendChild(label); profileRow.appendChild(wrap);
  });
  const addWrap=document.createElement('div'); addWrap.style.textAlign='center';
  const addCircle=document.createElement('div'); addCircle.className='avatar-circle fade-up'; addCircle.innerHTML='<div class="initial">Ôºã</div>';
  addCircle.addEventListener('click', ()=> openAddAccountModal());
  const addLabel=document.createElement('div'); addLabel.className='avatar-label'; addLabel.textContent='Add account';
  addWrap.appendChild(addCircle); addWrap.appendChild(addLabel); profileRow.appendChild(addWrap);
}

function renderAdvanced(){
  advancedList.innerHTML='';
  State.data.users.forEach(u=>{
    const adv=document.createElement('div'); adv.className='advanced-user fade-up';
    const av=document.createElement('div'); av.className='avatar-circle'; av.style.width='100px'; av.style.height='100px';
    if(u.avatarUrl){ av.innerHTML=`<img src="${u.avatarUrl}" alt="${u.name}">`; } else { av.style.background=u.avatarColor; av.innerHTML=`<div class="initial">${u.name[0].toUpperCase()}</div>`; }
    const info=document.createElement('div');
    const todayTasks=(State.data.assignments.daily[u.id]||[]).map(a=> State.data.catalog.tasks.find(t=>t.id===a.taskId)).filter(Boolean);
    info.innerHTML=`
      <div class="topline">
        <div class="name-balance">
          <div style="font-weight:800;font-size:18px">${u.name}</div>
          <div style="color:var(--muted);font-size:13px">Favor ${fmt(u.favor)} ¬∑ Grace ${u.grace}</div>
        </div>
        <div class="chip">${todayTasks.length} tasks today</div>
      </div>
      <div class="tasks">${todayTasks.map(t=>`<span class="task-chip">${t.icon||'‚úÖ'} ${t.room}: ${t.title} <span style="opacity:.8">(+${fmt(t.pos)}/‚àí${fmt(t.neg)})</span></span>`).join('')}</div>
    `;
    adv.appendChild(av); adv.appendChild(info); advancedList.appendChild(adv);
  });
}

toggleAdvancedBtn.addEventListener('click', ()=>{
  const isAdv = !advancedArea.classList.contains('hidden');
  if(isAdv){ advancedArea.classList.add('hidden'); toggleAdvancedBtn.textContent='Advanced View'; }
  else { advancedArea.classList.remove('hidden'); toggleAdvancedBtn.textContent='Simple View'; renderAdvanced(); }
});

function openManageUserModal(u){
  const m=openModal(`
    <div class="title">Manage ${u.name}</div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:14px">
      <div class="field"><label>Name</label><input id="mu_name" value="${u.name}"></div>
      <div class="field"><label>Profile Color</label><input id="mu_color" type="color" value="${u.avatarColor}"></div>
      <div class="field"><label>Profile Image URL</label><input id="mu_url" placeholder="https://..." value="${u.avatarUrl||''}"></div>
      <div class="field"><label>PIN (4 digits, blank = none)</label><input id="mu_pin" inputmode="numeric" maxlength="4" value="${u.pin||''}"></div>
      <div class="field"><label>Grace Tokens</label><input id="mu_grace" type="number" min="0" value="${u.grace}"></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="mu_delete" class="btn" style="background:#4e2530">Delete</button>
      <button id="mu_cancel" class="btn ghost">Cancel</button>
      <button id="mu_save" class="btn primary">Save</button>
    </div>
  `);
  m.querySelector('#mu_cancel').onclick=closeModal;
  m.querySelector('#mu_delete').onclick=()=>{ if(confirm('Delete user?')){ State.data.users=State.data.users.filter(x=>x.id!==u.id); if(State.data.currentUserId===u.id && State.data.users[0]) State.data.currentUserId=State.data.users[0].id; State.save(); closeModal(); renderProfiles(); } };
  m.querySelector('#mu_save').onclick=()=>{
    u.name=m.querySelector('#mu_name').value.trim()||u.name;
    u.avatarColor=m.querySelector('#mu_color').value||u.avatarColor;
    u.avatarUrl=m.querySelector('#mu_url').value.trim()||'';
    const pin=m.querySelector('#mu_pin').value.trim(); u.pin=/^\d{4}$/.test(pin)?pin:'';
    u.grace=parseInt(m.querySelector('#mu_grace').value||'0'); State.save(); closeModal(); renderProfiles(); renderDashboard();
  };
}

function openAddAccountModal(){
  const m=openModal(`
    <div class="title">Add Account</div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:14px">
      <div class="field"><label>Username</label><input id="aa_name" placeholder="e.g., Alex"></div>
      <div class="field"><label>Profile Image URL (optional)</label><input id="aa_url" placeholder="https://..."></div>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="aa_cancel" class="btn ghost">Cancel</button>
      <button id="aa_add" class="btn primary">Add</button>
    </div>
  `);
  m.querySelector('#aa_cancel').onclick=closeModal;
  m.querySelector('#aa_add').onclick=()=>{
    const name=m.querySelector('#aa_name').value.trim(); const url=m.querySelector('#aa_url').value.trim();
    if(!name) return; const u={id:uid(), name, favor:0, pin:'', grace:2, away:[], avatarColor:'#'+(Math.random()*0xFFFFFF<<0).toString(16).padStart(6,'6'), avatarUrl:url};
    State.data.users.push(u); State.save(); closeModal(); renderProfiles();
  };
}

/* Dashboard */
const profileScreen=$('#profileScreen'); const dashboard=$('#dashboard');
const dashAvatar=$('#dashAvatar'); const settingsBtn=$('#settingsBtn'); const settingsDrawer=$('#settingsDrawer'); const closeSettings=$('#closeSettings');
const tabs=$$('.tab'); const tasksTab=$('#tasksTab'); const seasonalTab=$('#seasonalTab'); const watchTab=$('#watchTab'); const walletTab=$('#walletTab');
const notifBtn=$('#notifBtn'); const notifMenu=$('#notifMenu'); const notifCount=$('#notifCount'); const streakCount=$('#streakCount');

function switchToDashboard(){ profileScreen.classList.add('hidden'); dashboard.classList.remove('hidden'); dashboard.classList.add('fade-in'); renderDashboard(); }
dashAvatar.addEventListener('click', ()=>{ dashboard.classList.add('hidden'); profileScreen.classList.remove('hidden'); renderProfiles(); notifMenu.classList.add('hidden'); });
tabs.forEach(t=> t.addEventListener('click', ()=> switchTab(t.dataset.tab)));
function switchTab(name){ tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===name)); tasksTab.classList.toggle('hidden', name!=='tasks'); seasonalTab.classList.toggle('hidden', name!=='seasonal'); watchTab.classList.toggle('hidden', name!=='watch'); walletTab.classList.toggle('hidden', name!=='wallet'); }
settingsBtn.addEventListener('click', ()=>{ settingsDrawer.classList.toggle('hidden'); renderSettingsDrawerMeta(); }); closeSettings.addEventListener('click', ()=> settingsDrawer.classList.add('hidden'));

/* Tabs content refs */
const cutoffChip=$('#cutoffChip'); const weekChip=$('#weekChip'); const dailyGrid=$('#dailyGrid'); const weeklyGrid=$('#weeklyGrid'); const seasonalGrid=$('#seasonalGrid');
const rushBanner=$('#rushBanner'); const seasonalBanner=$('#seasonalBanner'); const dismissSeasonal=$('#dismissSeasonal');
const swapBtn=$('#swapBtn'); const useGraceBtn=$('#useGraceBtn'); const graceCountEl=$('#graceCount'); const walletBalances=$('#walletBalances'); const txLog=$('#txLog');
const dailySection=$('#dailySection'); const graceMask=$('#graceMask');

dismissSeasonal.onclick = ()=>{ State.data.system.seasonalBannerDismissed = true; State.save(); seasonalBanner.classList.add('hidden'); };
swapBtn.onclick = ()=> openSwapModal();

function renderDashboard(){ applyUserTheme(State.currentUser && State.currentUser.avatarColor);
  const user=State.currentUser;
  dashAvatar.innerHTML=''; if(user.avatarUrl){ const img=document.createElement('img'); img.src=user.avatarUrl; img.alt=user.name; dashAvatar.appendChild(img); } else { const ini=document.createElement('div'); ini.className='initial'; ini.textContent=user.name[0].toUpperCase(); dashAvatar.style.background=user.avatarColor; dashAvatar.appendChild(ini); }
  const seasonalEnabled=State.data.catalog.seasonal.enabled; $$('.tab[data-tab="seasonal"]').forEach(el=> el.classList.toggle('hidden', !seasonalEnabled));
  $('#settingsAvatar').textContent=user.name[0].toUpperCase(); const sImg=$('#settingsAvatarImg'); if(user.avatarUrl){ sImg.src=user.avatarUrl; sImg.classList.remove('hidden'); $('#settingsAvatar').classList.add('hidden'); } else { sImg.classList.add('hidden'); $('#settingsAvatar').classList.remove('hidden'); }
  $('#settingsUserName').textContent=user.name;
  cutoffChip.textContent = `Cutoff ${ (State.data.settings.dailyCutoffTimeLocal || String(State.data.settings.dailyCutoffHour).padStart(2,'0')+':00') }`;
  weekChip.textContent=`Week of ${startOfWeek().toLocaleDateString()}`;
  graceCountEl.textContent=user.grace;
  rushBanner.classList.toggle('hidden', !State.isRushActive()); $('#seasonDeadlineTxt').textContent=State.data.settings.seasonal.deadline; $('#seasonDeadlineTxt2').textContent=State.data.settings.seasonal.deadline;
  if(seasonalEnabled && !State.data.system.seasonalBannerDismissed){ seasonalBanner.classList.remove('hidden'); $('#seasonDeadlineTxt').textContent=State.data.settings.seasonal.deadline; $('#seasonDeadlineTxt2').textContent=State.data.settings.seasonal.deadline; } else { seasonalBanner.classList.add('hidden'); }
  updateNotifBadge();
  streakCount.textContent=(State.data.system.streak||0);

  renderDaily(); renderWeekly(); renderSeasonal(); renderWatch(); renderWallet(); renderSettingsDrawerMeta();
}

function taskById(id){ return State.data.catalog.tasks.find(t=>t.id===id) || State.data.catalog.seasonal.tasks.find(t=>t.id===id); }
function logTx(userId,text,amount){ (State.data.walletTx ||= []).push({id:uid(), userId, text, amount, date:new Date().toISOString()}); State.save(); }

function renderDaily(){
  const user=State.currentUser; dailyGrid.innerHTML=''; const list=State.data.assignments.daily[user.id]||[];
  list.forEach(a=>{
    const t=State.data.catalog.tasks.find(x=>x.id===a.taskId); if(!t) return;
    const box=document.createElement('div'); box.className='task-box'; if(a.completed) box.classList.add('completed');
    box.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div class="chip">${t.icon||'‚úÖ'}</div>
        <div class="task-weights"><span class="pos">+${fmt(t.pos)}</span><span class="neg">‚àí${fmt(t.neg)}</span></div>
      </div>
      <div style="font-size:12px;color:#c5c9d3">${t.room}</div>
      <div class="title">${t.title}</div>
      <div class="row" style="justify-content:flex-end">${a.completed?'<button class="btn ghost task-undo">Undo</button>':''}</div>`;
    box.addEventListener('click', e=>{ if(e.target.classList.contains('task-undo')) return; toggleTaskComplete('daily', user.id, a, t, !!a.completed); });
    box.querySelector('.task-undo')?.addEventListener('click',e=>{ e.stopPropagation(); toggleTaskComplete('daily', user.id, a, t, true); });
    dailyGrid.appendChild(box);
  });
}
function renderWeekly(){
  const user=State.currentUser; weeklyGrid.innerHTML=''; const list=State.data.assignments.weekly[user.id]||[];
  list.forEach(a=>{
    const t=State.data.catalog.tasks.find(x=>x.id===a.taskId); if(!t) return;
    const box=document.createElement('div'); box.className='task-box'; if(a.completed) box.classList.add('completed');
    box.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div class="chip">${t.icon||'‚úÖ'}</div>
        <div class="task-weights"><span class="pos">+${fmt(t.pos)}</span><span class="neg">‚àí${fmt(t.neg)}</span></div>
      </div>
      <div style="font-size:12px;color:#c5c9d3">${t.room}</div>
      <div class="title">${t.title}</div>
      <div class="row" style="justify-content:flex-end">${a.completed?'<button class="btn ghost task-undo">Undo</button>':''}</div>`;
    box.addEventListener('click', e=>{ if(e.target.classList.contains('task-undo')) return; toggleTaskComplete('weekly', user.id, a, t, !!a.completed); });
    box.querySelector('.task-undo')?.addEventListener('click',e=>{ e.stopPropagation(); toggleTaskComplete('weekly', user.id, a, t, true); });
    weeklyGrid.appendChild(box);
  });
}
function renderSeasonal(){
  const user=State.currentUser; seasonalGrid.innerHTML=''; const list=State.data.assignments.seasonal[user.id]||[];
  list.forEach(a=>{
    const t=State.data.catalog.seasonal.tasks.find(x=>x.id===a.taskId); if(!t) return;
    const box=document.createElement('div'); box.className='task-box'; if(a.completed) box.classList.add('completed');
    box.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div class="chip">${t.icon||'üßΩ'}</div>
        <div class="task-weights"><span class="pos">+${fmt(t.pos)}</span><span class="neg">‚àí${fmt(t.neg)}</span></div>
      </div>
      <div style="font-size:12px;color:#c5c9d3">${t.room||'Seasonal'}</div>
      <div class="title">${t.title}</div>
      <div class="row" style="justify-content:flex-end">${a.completed?'<button class="btn ghost task-undo">Undo</button>':''}</div>`;
    box.addEventListener('click', e=>{ if(e.target.classList.contains('task-undo')) return; toggleTaskComplete('seasonal', user.id, a, t, !!a.completed); });
    box.querySelector('.task-undo')?.addEventListener('click',e=>{ e.stopPropagation(); toggleTaskComplete('seasonal', user.id, a, t, true); });
    seasonalGrid.appendChild(box);
  });
}

function toggleTaskComplete(scope, userId, assign, task, undo=false){
  const user=State.userById(userId); const rushBonus=State.isRushActive()?State.data.system.rush.bonus:0;
  if(!assign.completed && !undo){ assign.completed=true; const gain=task.pos + (rushBonus||0); user.favor+=gain; logTx(userId,`Completed ${task.title}${rushBonus?' (Rush +'+fmt(rushBonus)+')':''}`,`+${fmt(gain)}`); }
  else if(assign.completed && undo){ assign.completed=false; const gain=task.pos + (State.isRushActive()?State.data.system.rush.bonus:0); user.favor-=gain; logTx(userId,`Undo complete ${task.title}` ,`-${fmt(gain)}`); }
  State.save(); renderDashboard();
}

/* Swap modal */
function openSwapModal(){
  const current=State.currentUser; const daily=State.data.assignments.daily[current.id]||[];
  const m=openModal(`
    <div class="title">Swap a Daily Task</div>
    <div class="field"><label>Your Task</label><select id="sw_task"></select></div>
    <div class="field"><label>With User</label><select id="sw_user"></select></div>
    <div class="row" style="justify-content:flex-end"><button id="sw_cancel" class="btn ghost">Cancel</button><button id="sw_send" class="btn primary">Send Request</button></div>
  `);
  const selTask=m.querySelector('#sw_task'); daily.forEach(a=>{ const t=State.data.catalog.tasks.find(x=>x.id===a.taskId); if(t) selTask.innerHTML+=`<option value="${t.id}">${t.room} ‚Äî ${t.title}</option>`; });
  const selUser=m.querySelector('#sw_user'); State.data.users.filter(u=>u.id!==current.id).forEach(u=> selUser.innerHTML+=`<option value="${u.id}">${u.name}</option>`);
  m.querySelector('#sw_cancel').onclick=closeModal;
  m.querySelector('#sw_send').onclick=()=>{
    const taskId=selTask.value; const toUserId=selUser.value; const req={id:uid(), fromUserId:current.id, toUserId, taskId, date:new Date().toISOString()}; State.data.swaps.push(req);
    pushNotif(toUserId, `${current.name} wants to swap "${taskTitle(taskId)}"`, [
      {label:'Approve', action:{type:'swap_approve', id:req.id}},
      {label:'Deny', action:{type:'swap_deny', id:req.id}}
    ]);
    pushNotif(current.id, `Swap request sent to ${State.userById(toUserId).name} for "${taskTitle(taskId)}"`, []);
    State.save(); closeModal();
  };
}
function taskTitle(id){ const t=State.data.catalog.tasks.find(x=>x.id===id)||State.data.catalog.seasonal.tasks.find(x=>x.id===id); return t?`${t.room||'‚Äî'} ${t.title}`:'Task'; }

/* Grace overlay */
function showGraceOverlay(show){ dailySection.classList.toggle('grace-active', show); graceMask.classList.toggle('hidden', !show); }
function useGraceToken(){ const user=State.currentUser; if(user.grace<=0){ alert('No grace tokens available'); return; } user.grace-=1; logTx(user.id,'Grace used','‚Äî'); State.save(); renderDashboard(); showGraceOverlay(true); $('#undoGraceBtn').onclick=()=>{ user.grace+=1; logTx(user.id,'Grace undone','‚Äî'); State.save(); renderDashboard(); showGraceOverlay(false); }; $('#okGraceBtn').onclick=()=> showGraceOverlay(false); }
useGraceBtn.onclick = useGraceToken;

/* Watch + Notifs */
const watchGrid=$('#watchGrid'); const watchRulesCount=$('#watchRulesCount');
function renderWatch(){
  watchGrid.innerHTML=''; const rules=State.data.catalog.rules; watchRulesCount.textContent=`${rules.length} rules`; const u=State.currentUser;
  rules.forEach(r=>{
    const box=document.createElement('div'); box.className='task-box';
    const claimedKey=`claimed_${u.id}_${todayStr()}_${r.id}`; const claimed=!!sessionStorage.getItem(claimedKey); if(claimed) box.classList.add('completed');
    box.innerHTML=`
      <div class="row" style="justify-content:space-between"><div class="chip">üëÅÔ∏è</div><div class="chip">+${fmt(r.weight)} favor</div></div>
      <div class="title">${r.title}</div>
      <div class="row" style="justify-content:flex-end">${claimed?'<button class="btn ghost undo-claim">Undo</button>':'<button class="btn primary claim">Claim</button>'}</div>`;
    box.querySelector('.claim')?.addEventListener('click',()=>{ u.favor+=r.weight; sessionStorage.setItem(claimedKey,'1'); logTx(u.id,`Claimed: ${r.title}`,`+${fmt(r.weight)}`); State.data.users.filter(x=>x.id!==u.id).forEach(o=> pushNotif(o.id, `${u.name} claimed a rule: "${r.title}"`, [])); State.save(); renderDashboard(); });
    box.querySelector('.undo-claim')?.addEventListener('click',()=>{ u.favor-=r.weight; sessionStorage.removeItem(claimedKey); logTx(u.id,`Undo claim: ${r.title}`,`-${fmt(r.weight)}`); State.data.users.filter(x=>x.id!==u.id).forEach(o=> pushNotif(o.id, `${u.name} reversed a claim: "${r.title}"`, [])); State.save(); renderDashboard(); });
    watchGrid.appendChild(box);
  });
}
function pushNotif(userId,text,actions){ State.data.notifications.push({id:uid(), userId, text, actions, date:new Date().toISOString()}); updateNotifBadge(); State.save(); }
function updateNotifBadge(){ const curr=State.currentUser; const count=State.data.notifications.filter(n=>n.userId===curr.id).length; notifCount.textContent=count; notifCount.classList.toggle('hidden', count===0); }
notifBtn.addEventListener('click', ()=>{
  const curr=State.currentUser; const list=State.data.notifications.filter(n=>n.userId===curr.id);
  notifMenu.innerHTML=`<div class="row" style="justify-content:space-between; padding:6px 8px"><div style="font-weight:700">Notifications</div><button id="notifClear" class="btn ghost">Clear all</button></div>`;
  list.forEach(n=>{
    const item=document.createElement('div'); item.className='notif-item';
    const actions=(n.actions||[]).map(a=>`<button class="btn ghost act" data-type="${a.action.type}" data-id="${a.action.id}">${a.label}</button>`).join('');
    item.innerHTML=`<div>${n.text}</div><div class="notif-actions">${actions}<button class="btn ghost dismiss">Dismiss</button></div>`;
    item.querySelector('.dismiss').onclick=()=>{ State.data.notifications=State.data.notifications.filter(x=>x.id!==n.id); State.save(); updateNotifBadge(); notifBtn.click(); };
    item.querySelectorAll('.act').forEach(btn=> btn.addEventListener('click', ()=> handleNotifAction(btn.dataset.type, btn.dataset.id, n)));
    notifMenu.appendChild(item);
  });
  $('#notifClear').onclick=()=>{ State.data.notifications=State.data.notifications.filter(n=>n.userId!==curr.id); State.save(); updateNotifBadge(); notifMenu.classList.add('hidden'); };
  notifMenu.classList.toggle('hidden');
});
function handleNotifAction(type,id,notif){
  if(type==='swap_approve'){ const req=State.data.swaps.find(s=>s.id===id); if(req){ const fromList=State.data.assignments.daily[req.fromUserId]||[]; const toList=State.data.assignments.daily[req.toUserId]||[]; const idxFrom=fromList.findIndex(a=>a.taskId===req.taskId); if(idxFrom>-1){ const other=toList[0]; const fromTask=fromList[idxFrom]; if(other){ const temp=fromTask.taskId; fromTask.taskId=other.taskId; toList[0].taskId=temp; } else { toList.push(fromTask); fromList.splice(idxFrom,1); } pushNotif(req.fromUserId, `${State.userById(req.toUserId).name} approved your swap.`, []); } State.data.swaps=State.data.swaps.filter(s=>s.id!==id); } }
  else if(type==='swap_deny'){ const req=State.data.swaps.find(s=>s.id===id); if(req){ pushNotif(req.fromUserId, `${State.userById(req.toUserId).name} denied your swap.`, []); State.data.swaps=State.data.swaps.filter(s=>s.id!==id); } }
  State.data.notifications=State.data.notifications.filter(n=>n.id!==notif.id); State.save(); renderDashboard(); notifBtn.click();
}

/* Wallet */
function renderWallet(){
  const u=State.currentUser; walletBalances.innerHTML=''; State.data.users.forEach(x=>{ const pill=document.createElement('div'); pill.className='balance-pill'; pill.textContent=`${x.name}: ${fmt(x.favor)}`; walletBalances.appendChild(pill); });
  txLog.innerHTML=''; (State.data.walletTx||[]).filter(t=>t.userId===u.id).slice(-100).reverse().forEach(t=>{ const row=document.createElement('div'); row.className='tx'; row.innerHTML=`<div>${new Date(t.date).toLocaleString()} ‚Äî ${t.text}</div><div style="white-space:nowrap">${t.amount}</div>`; txLog.appendChild(row); });
}
function openRedeemModal(){
  const m=openModal(`<div class="title">Redeem Favor</div><div class="field"><label>Amount</label><input id="rf_amt" type="number" min="0" step="0.25" placeholder="e.g., 2"></div><div class="field"><label>Note (optional)</label><input id="rf_note" placeholder="What did you redeem for?"></div><div class="row" style="justify-content:flex-end"><button class="btn ghost" id="rf_cancel">Cancel</button><button class="btn primary" id="rf_ok">Redeem</button></div>`);
  m.querySelector('#rf_cancel').onclick=closeModal; m.querySelector('#rf_ok').onclick=()=>{ const u=State.currentUser; const amt=parseFloat(m.querySelector('#rf_amt').value||'0'); const note=m.querySelector('#rf_note').value.trim(); if(!amt || amt<=0) return; u.favor=Math.max(0,u.favor-amt); logTx(u.id,`Redeemed favor${note?': '+note:''}`,`-${fmt(amt)}`); State.save(); closeModal(); renderDashboard(); };
}
function openTradeModal(){
  const m=openModal(`<div class="title">Trade Favor</div><div class="field"><label>Recipient</label><select id="tr_user"></select></div><div class="field"><label>Amount</label><input id="tr_amt" type="number" min="0" step="0.25" placeholder="e.g., 1.5"></div><div class="row" style="justify-content:flex-end"><button class="btn ghost" id="tr_cancel">Cancel</button><button class="btn primary" id="tr_ok">Send</button></div>`);
  const sel=m.querySelector('#tr_user'); State.data.users.filter(x=>x.id!==State.currentUser.id).forEach(u=> sel.innerHTML+=`<option value="${u.id}">${u.name}</option>`);
  m.querySelector('#tr_cancel').onclick=closeModal; m.querySelector('#tr_ok').onclick=()=>{ const from=State.currentUser; const to=State.userById(sel.value); const amt=parseFloat(m.querySelector('#tr_amt').value||'0'); if(!to || !amt || amt<=0) return; to.favor+=amt; logTx(from.id,`Traded to ${to.name}`,`‚Äî`); pushNotif(to.id, `${from.name} gave you +${fmt(amt)} favor`, []); State.save(); closeModal(); renderDashboard(); };
}
function openGrantGraceModal(){
  const m=openModal(`<div class="title">Grant Grace Token</div><div class="field"><label>Recipient</label><select id="gg_user"></select></div><div class="row" style="justify-content:flex-end"><button class="btn ghost" id="gg_cancel">Cancel</button><button class="btn primary" id="gg_ok">Grant</button></div>`);
  const sel=m.querySelector('#gg_user'); State.data.users.filter(x=>x.id!==State.currentUser.id).forEach(u=> sel.innerHTML+=`<option value="${u.id}">${u.name}</option>`);
  m.querySelector('#gg_cancel').onclick=closeModal; m.querySelector('#gg_ok').onclick=()=>{ const from=State.currentUser; const to=State.userById(sel.value); if(!to) return; to.grace+=1; logTx(from.id,`Granted grace to ${to.name}`,`‚Äî`); pushNotif(to.id, `${from.name} granted you a Grace token`, []); State.save(); closeModal(); renderDashboard(); };
}
$('#redeemBtn').onclick=openRedeemModal; $('#tradeBtn').onclick=openTradeModal; $('#grantGraceBtn').onclick=openGrantGraceModal;

/* Settings */
const settingsDateTime=$('#settingsDateTime');
function renderSettingsDrawerMeta(){ const now=new Date(); settingsDateTime.textContent=now.toLocaleString([], {hour:'2-digit', minute:'2-digit', hour12:true}) + ' ¬∑ ' + now.toDateString(); }
$$('.settings-tile').forEach(t=> t.addEventListener('click', ()=> openSettingsCategory(t.dataset.cat)));

function openSettingsCategory(cat){
  if(cat==='general'){
    const s = State.data.settings;
    const defTime = (s && s.dailyCutoffTimeLocal) ? s.dailyCutoffTimeLocal : ((('0'+((s&&s.dailyCutoffHour)!=null?s.dailyCutoffHour:22)).slice(-2))+':00');
    const modal = `<div class="title">General</div>
      <div class="grid">
        <div class="row">
          <label style="min-width:220px">Daily cutoff (device local time)</label>
          <input type="time" id="g_cutoff" class="btn" value="${defTime}" />
        </div>
        <div class="row">
          <label style="min-width:220px">Rush Hour window</label>
          <input type="time" id="rw_start" class="btn" value="${s.rush.start||'17:00'}" /> 
          <span style="opacity:.7">to</span>
          <input type="time" id="rw_end" class="btn" value="${s.rush.end||'20:00'}" />
        </div>
        <div class="row">
          <label style="min-width:220px">Rush Hour bonus per task</label>
          <input type="number" id="rw_b" class="btn" min="0" step="0.25" value="${s.rush.bonus||0}" />
        </div>
      </div>
      <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px;">
        <button class="btn ghost" id="g_close">Close</button>
        <button class="btn primary" id="g_save">Save</button>
      </div>`;
    const m = openModal(modal, true);
    m.querySelector('#g_close').onclick = closeModal;
    m.querySelector('#g_save').onclick = () => {
      const t = m.querySelector('#g_cutoff').value || defTime;
      State.data.settings.dailyCutoffTimeLocal = t;
      State.data.settings.dailyCutoffHour = parseInt(t.split(':')[0],10);
      State.data.settings.rush = State.data.settings.rush || {};
      State.data.settings.rush.start = m.querySelector('#rw_start').value || '17:00';
      State.data.settings.rush.end   = m.querySelector('#rw_end').value   || '20:00';
      State.data.settings.rush.bonus = parseFloat(m.querySelector('#rw_b').value || 0) || 0;
      State.save(); closeModal(); renderDashboard();
    };
    return;
  }
  if(cat==='tasks'){ /* same as previous build; left intact */ openTasksSettings(); return; }
  if(cat==='seasonal'){ openSeasonalSettings(); return; }
  if(cat==='watch'){ openWatchSettings(); return; }
  if(cat==='away'){ openAwaySettings(); return; }
  if(cat==='export'){ openExportSettings(); return; }
}

/* Tasks settings (abridged version) */
function openTasksSettings(){
  const all=State.data.catalog.tasks;
  const m=openModal(`<div class="title">Tasks</div><div class="grid" style="gap:10px"><div class="row" style="gap:6px"><button id="t_add" class="btn primary">Add Task</button><button id="t_dist_daily" class="btn ghost">Redistribute Daily</button><button id="t_dist_weekly" class="btn ghost">Redistribute Weekly</button></div><div id="t_list"></div></div>`, true);
  const tlist=m.querySelector('#t_list');
  function draw(){ tlist.innerHTML=''; all.forEach(t=>{ const row=document.createElement('div'); row.className='advanced-user'; row.style.gridTemplateColumns='60px 1fr'; row.innerHTML=`<div class="avatar-circle" style="width:52px;height:52px;"><div class="initial">${t.icon||'üßπ'}</div></div><div class="row" style="justify-content:space-between; width:100%"><div><div style="font-weight:700">${t.room} ‚Äî ${t.title}</div><div style="color:var(--muted);font-size:12px">${t.freq.toUpperCase()} ¬∑ +${fmt(t.pos)} / ‚àí${fmt(t.neg)}</div></div><div class="row"><button class="btn ghost edit">Edit</button><button class="btn ghost del">Remove</button></div></div>`; row.querySelector('.edit').onclick=()=> editTask(t); row.querySelector('.del').onclick=()=>{ if(confirm('Remove task?')){ const i=State.data.catalog.tasks.findIndex(x=>x.id===t.id); State.data.catalog.tasks.splice(i,1); State.save(); draw(); } }; tlist.appendChild(row); }); }
  function editTask(t){ const em=openModal(`<div class="title">Edit Task</div><div class="grid" style="grid-template-columns:1fr 1fr; gap:14px"><div class="field"><label>Room</label><input id="room" value="${t.room}"></div><div class="field"><label>Title</label><input id="tt" value="${t.title}"></div><div class="field"><label>Icon</label><input id="icon" value="${t.icon||''}"></div><div class="field"><label>Frequency</label><select id="freq"><option ${t.freq==='daily'?'selected':''} value="daily">Daily</option><option ${t.freq==='weekly'?'selected':''} value="weekly">Weekly</option></select></div><div class="field"><label>Positive Weight</label><input id="pos" type="number" step="0.25" value="${t.pos}"></div><div class="field"><label>Negative Weight</label><input id="neg" type="number" step="0.25" value="${t.neg}"></div></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="e_close">Close</button><button class="btn primary" id="e_save">Save</button></div>`); em.querySelector('#e_close').onclick=closeModal; em.querySelector('#e_save').onclick=()=>{ t.room=em.querySelector('#room').value.trim()||t.room; t.title=em.querySelector('#tt').value.trim()||t.title; t.icon=em.querySelector('#icon').value.trim()||t.icon; t.freq=em.querySelector('#freq').value; (function(){const __v=parseFloat(em.querySelector('#pos').value);t.pos=isNaN(__v)?t.pos:__v;})(); (function(){const __w=parseFloat(em.querySelector('#neg').value);t.neg=isNaN(__w)?t.neg:__w;})(); State.save(); closeModal(); draw(); }; }
  m.querySelector('#t_add').onclick=()=>{ State.data.catalog.tasks.push({id:uid(), room:'Room', title:'New Task', freq:'daily', pos:1, neg:0.5, icon:'üßπ'}); State.save(); draw(); };
  m.querySelector('#t_dist_daily').onclick=()=>{ State.distributeDaily(); State.save(); alert('Daily redistributed'); };
  m.querySelector('#t_dist_weekly').onclick=()=>{ State.distributeWeekly(); State.save(); alert('Weekly redistributed'); };
  draw();
}
/* Seasonal settings */
function openSeasonalSettings(){
  const m=openModal(`<div class="title">Seasonal</div><div class="grid" style="grid-template-columns:1fr 1fr; gap:14px"><div class="field"><label>Enable Seasonal</label><div id="sswitch" class="switch ${State.data.catalog.seasonal.enabled?'on':''}"></div></div><div class="field"><label>Deadline (YYYY-MM-DD)</label><input id="sdeadline" value="${State.data.settings.seasonal.deadline||todayStr()}"></div></div><div class="row" style="gap:6px"><button id="s_add" class="btn primary">Add Seasonal Task</button></div><div id="s_list" style="margin-top:8px"></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="s_close">Close</button><button class="btn primary" id="s_save">Save</button></div>`, true);
  const s_list=m.querySelector('#s_list');
  function draw(){ s_list.innerHTML=''; const list=State.data.catalog.seasonal.tasks; list.forEach(t=>{ const row=document.createElement('div'); row.className='advanced-user'; row.style.gridTemplateColumns='60px 1fr'; row.innerHTML=`<div class="avatar-circle" style="width:52px;height:52px;"><div class="initial">${t.icon||'üßΩ'}</div></div><div class="row" style="justify-content:space-between; width:100%"><div><div style="font-weight:700">${t.title}</div><div style="color:var(--muted);font-size:12px">+${fmt(t.pos)} / ‚àí${fmt(t.neg)}</div></div><div class="row"><button class="btn ghost edit">Edit</button><button class="btn ghost del">Remove</button></div></div>`; row.querySelector('.edit').onclick=()=> editSeasonal(t); row.querySelector('.del').onclick=()=>{ const i=State.data.catalog.seasonal.tasks.findIndex(x=>x.id===t.id); State.data.catalog.seasonal.tasks.splice(i,1); State.save(); draw(); }; s_list.appendChild(row); }); }
  function editSeasonal(t){ const em=openModal(`<div class="title">Edit Seasonal Task</div><div class="grid" style="grid-template-columns:1fr 1fr; gap:14px"><div class="field"><label>Title</label><input id="tt" value="${t.title}"></div><div class="field"><label>Icon</label><input id="icon" value="${t.icon||''}"></div><div class="field"><label>Positive Weight</label><input id="pos" type="number" step="0.25" value="${t.pos}"></div><div class="field"><label>Negative Weight</label><input id="neg" type="number" step="0.25" value="${t.neg}"></div></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="e_close">Close</button><button class="btn primary" id="e_save">Save</button></div>`); em.querySelector('#e_close').onclick=closeModal; em.querySelector('#e_save').onclick=()=>{ t.title=em.querySelector('#tt').value.trim()||t.title; t.icon=em.querySelector('#icon').value.trim()||t.icon; (function(){const __v=parseFloat(em.querySelector('#pos').value);t.pos=isNaN(__v)?t.pos:__v;})(); (function(){const __w=parseFloat(em.querySelector('#neg').value);t.neg=isNaN(__w)?t.neg:__w;})(); State.save(); closeModal(); draw(); }; }
  m.querySelector('#sswitch').onclick=e=> e.currentTarget.classList.toggle('on');
  m.querySelector('#s_add').onclick=()=>{ State.data.catalog.seasonal.tasks.push({id:uid(), title:'Spring Clean: Windows', pos:2, neg:1, icon:'ü™ü'}); State.save(); draw(); };
  m.querySelector('#s_close').onclick=closeModal;
  m.querySelector('#s_save').onclick=()=>{
    const enabled=m.querySelector('#sswitch').classList.contains('on'); const wasEnabled=State.data.catalog.seasonal.enabled;
    State.data.catalog.seasonal.enabled=enabled; State.data.settings.seasonal.deadline=m.querySelector('#sdeadline').value||todayStr();
    if(enabled && !wasEnabled){ State.data.system.seasonalBannerDismissed=false; } // reset banner only on activation
    if(enabled){
      const list=State.data.catalog.seasonal.tasks; const users=State.presentUsers(); const buckets=new Map(users.map(u=>[u.id,[]]));
      list.forEach((t,i)=>{ const u=users[i%users.length]; buckets.get(u.id).push({taskId:t.id, completed:false}); });
      State.data.assignments.seasonal=Object.fromEntries(buckets);
    }
    State.save(); closeModal(); renderDashboard();
  };
  draw();
}
/* Watch settings */
function openWatchSettings(){
  const rules=State.data.catalog.rules;
  const m=openModal(`<div class="title">The Watch</div><div class="row" style="gap:6px"><button id="w_add" class="btn primary">Add Rule</button></div><div id="w_list" style="margin-top:8px"></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="w_close">Close</button></div>`, true);
  const wlist=m.querySelector('#w_list');
  function draw(){ wlist.innerHTML=''; rules.forEach(r=>{ const row=document.createElement('div'); row.className='advanced-user'; row.style.gridTemplateColumns='60px 1fr'; row.innerHTML=`<div class="avatar-circle" style="width:52px;height:52px;"><div class="initial">üëÅÔ∏è</div></div><div class="row" style="justify-content:space-between; width:100%"><div>${r.title} ¬∑ <span style="color:var(--muted)">+${fmt(r.weight)}</span></div><div class="row"><button class="btn ghost edit">Edit</button><button class="btn ghost del">Remove</button></div></div>`; row.querySelector('.edit').onclick=()=> editRule(r); row.querySelector('.del').onclick=()=>{ const i=State.data.catalog.rules.findIndex(x=>x.id===r.id); State.data.catalog.rules.splice(i,1); State.save(); draw(); renderDashboard(); }; wlist.appendChild(row); }); }
  function editRule(r){ const em=openModal(`<div class="title">Edit Rule</div><div class="field"><label>Title</label><input id="rt" value="${r.title}"></div><div class="field"><label>Weight</label><input id="rw" type="number" step="0.25" value="${r.weight}"></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="e_close">Close</button><button class="btn primary" id="e_save">Save</button></div>`); em.querySelector('#e_close').onclick=closeModal; em.querySelector('#e_save').onclick=()=>{ r.title=em.querySelector('#rt').value.trim()||r.title; r.weight=parseFloat(em.querySelector('#rw').value)||r.weight; State.save(); closeModal(); draw(); renderDashboard(); }; }
  m.querySelector('#w_add').onclick=()=>{ State.data.catalog.rules.push({id:uid(), title:'New Rule', weight:0.25}); State.save(); draw(); };
  m.querySelector('#w_close').onclick=closeModal;
  draw();
}
/* Away settings */
function openAwaySettings(){
  const m=openModal(`<div class="title">Away Scheduling</div><div id="away_list"></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="a_close">Close</button></div>`, true);
  const al=m.querySelector('#away_list');
  function draw(){ al.innerHTML=''; State.data.users.forEach(u=>{ const row=document.createElement('div'); row.className='advanced-user'; row.style.gridTemplateColumns='60px 1fr'; row.innerHTML=`<div class="avatar-circle" style="width:52px;height:52px;"><div class="initial">${u.name[0]}</div></div><div class="row" style="justify-content:space-between; width:100%"><div><div style="font-weight:700">${u.name}</div><div style="color:var(--muted);font-size:12px">${(u.away||[]).length} scheduled</div></div><div class="row"><button class="btn ghost add">Add</button><button class="btn ghost view">View</button></div></div>`; row.querySelector('.add').onclick=()=> addAway(u); row.querySelector('.view').onclick=()=> viewAway(u); al.appendChild(row); }); }
  function addAway(u){ const em=openModal(`<div class="title">Set Away ‚Äî ${u.name}</div><div class="grid" style="grid-template-columns:1fr 1fr; gap:14px"><div class="field"><label>Start (YYYY-MM-DD)</label><input id="as"></div><div class="field"><label>End (YYYY-MM-DD)</label><input id="ae"></div></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="e_close">Cancel</button><button class="btn primary" id="e_save">Save</button></div>`); em.querySelector('#e_close').onclick=closeModal; em.querySelector('#e_save').onclick=()=>{ const s=em.querySelector('#as').value; const e=em.querySelector('#ae').value; if(!u.away) u.away=[]; u.away.push({start:s, end:e}); State.save(); closeModal(); draw(); }; }
  function viewAway(u){ const em=openModal(`<div class="title">Away ‚Äî ${u.name}</div><div id="alist"></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="e_close">Close</button></div>`); const alist=em.querySelector('#alist'); alist.innerHTML=''; (u.away||[]).forEach((a,i)=>{ const row=document.createElement('div'); row.className='advanced-user'; row.style.gridTemplateColumns='1fr 80px'; row.innerHTML=`<div>${a.start} ‚Üí ${a.end}</div><div class="row" style="justify-content:flex-end"><button class="btn ghost del">Remove</button></div>`; row.querySelector('.del').onclick=()=>{ u.away.splice(i,1); State.save(); viewAway(u); }; alist.appendChild(row); }); em.querySelector('#e_close').onclick=closeModal; }
  m.querySelector('#a_close').onclick=closeModal; draw();
}
/* Export/Import */
function openExportSettings(){
  const m=openModal(`<div class="title">Export / Import</div><div class="row" style="gap:8px"><button class="btn primary" id="ex">Export JSON</button><input type="file" id="imfile" accept="application/json" style="display:none"><button class="btn ghost" id="im">Import JSON</button></div><div style="margin-top:8px;color:var(--muted)">Use export to back up your household data, or import a prior file.</div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn ghost" id="x_close">Close</button></div>`, true);
  m.querySelector('#x_close').onclick=closeModal; m.querySelector('#ex').onclick=()=>{ const blob=new Blob([JSON.stringify(State.data,null,2)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ourfavor-export.json'; a.click(); URL.revokeObjectURL(url); };
  m.querySelector('#im').onclick=()=> m.querySelector('#imfile').click(); m.querySelector('#imfile').onchange=e=>{ const f=e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ State.data=JSON.parse(reader.result); State.save(); closeModal(); location.reload(); }catch(err){ alert('Import failed'); } }; reader.readAsText(f); };
}

/* Rollovers */
function checkRollovers(){
  const last=State.data.system.lastDailyDist;
  if(last!==todayStr()){
    for(const uid of State.userIds()){
      const daily=State.data.assignments.daily[uid]||[];
      daily.forEach(a=>{
        if(!a.completed){
          const t=State.data.catalog.tasks.find(x=>x.id===a.taskId);
          if(t){ const others=State.data.users.filter(u=>u.id!==uid); if(others.length){ const share=t.neg/others.length; others.forEach(o=>{ o.favor+=share; pushNotif(o.id, `You gained +${fmt(share)} favor from missed task: ${t.title}`, []); }); logTx(uid, `Missed task: ${t.title} (distributed ‚àí${fmt(t.neg)})`, '‚Äî'); } }
        }
      });
    }
    State.distributeDaily();
    const dow=new Date().getDay(); if(dow===1){ State.data.users.forEach(u=> u.grace=2); }
  }
  const lastW=new Date(State.data.system.lastWeeklyDist); const thisW=startOfWeek();
  if(lastW.getTime()!==thisW.getTime()){
    for(const uid of State.userIds()){
      const weekly=State.data.assignments.weekly[uid]||[];
      weekly.forEach(a=>{
        if(!a.completed){
          const t=State.data.catalog.tasks.find(x=>x.id===a.taskId);
          if(t){ const others=State.data.users.filter(u=>u.id!==uid); if(others.length){ const share=t.neg/others.length; others.forEach(o=>{ o.favor+=share; pushNotif(o.id, `You gained +${fmt(share)} favor from missed weekly task: ${t.title}`, []); }); logTx(uid, `Missed weekly: ${t.title} (distributed ‚àí${fmt(t.neg)})`, '‚Äî'); } }
        }
      });
    }
    State.distributeWeekly();
  }
  State.save();
}
checkRollovers();

/* Settings drawer clock */
function renderSettingsDrawerMeta(){ const now=new Date(); $('#settingsDateTime').textContent = now.toLocaleString([], {hour:'2-digit', minute:'2-digit', hour12:true}) + ' ¬∑ ' + now.toDateString(); }

/* Init */
function init(){
  renderProfiles();
  const st=State.data.catalog.seasonal.enabled;
  $$('.tab[data-tab="seasonal"]').forEach(el=> el.classList.toggle('hidden', !st));
  setInterval(()=>{ if(!dashboard.classList.contains('hidden')){ $('#rushBanner').classList.toggle('hidden', !State.isRushActive()); renderSettingsDrawerMeta(); } }, 30000);
}
init();
</script>

<script>
// --- Daily cutoff penalties (non-destructive injection) ---
(function(){
  function applyDailyPenaltiesAtCutoff(){
    try{
      if(!window.State || !State.data || !State.data.settings || !State.data.system) return;
      var cutoffHour = Number(State.data.settings.dailyCutoffHour ?? 22);
      var now = new Date();
      if(now.getHours() < cutoffHour) return;

      // Only run once per day
      var today = (typeof todayStr === 'function') ? todayStr() : new Date().toISOString().slice(0,10);
      if(State.data.system.lastDailyPenalty === today) return;

      var users = (typeof State.presentUsers === 'function' ? State.presentUsers() : State.data.users) || [];
      var tasks = (State.data.catalog && State.data.catalog.tasks) || [];
      var fmt = (typeof window.fmt === 'function') ? window.fmt : (n=>Number(n).toFixed(2));
      var push = (typeof window.pushNotif === 'function') ? window.pushNotif : function(){};

      // Build a quick lookup for tasks by id
      var tMap = Object.create(null);
      tasks.forEach(function(t){ tMap[t.id] = t; });

      // Process daily assignments for today
      var daily = (State.data.assignments && State.data.assignments.daily) || {};
      users.forEach(function(u){
        var uid = u.id;
        var assigns = daily[uid] || [];
        assigns.forEach(function(a){
          if(a.completed) return;
          if(a.date && a.date !== today) return;
          var t = tMap[a.taskId];
          if(!t) return;
          var neg = Number(t.neg || 0);
          if(!(neg > 0)) return;

          // Distribute evenly to other users
          var others = users.filter(function(x){ return x.id !== uid; });
          if(!others.length) return;
          var share = neg / others.length;
          others.forEach(function(o){
            o.favor = (o.favor || 0) + share;
            push(o.id, "You gained +" + fmt(share) + " favor from missed task: " + (t.title || ""), []);
          });
          push(uid, "Missed task: " + (t.title || "") + " (distributed ‚àí" + fmt(neg) + ")", []);
        });
      });

      State.data.system.lastDailyPenalty = today;
      if(typeof State.save === 'function') State.save();
      if(typeof renderDashboard === 'function') renderDashboard();
    }catch(e){ /* silent fail-safe */ }
  }
  // Run on load and every minute
  if(document.readyState === 'complete') applyDailyPenaltiesAtCutoff();
  else window.addEventListener('load', applyDailyPenaltiesAtCutoff);
  setInterval(applyDailyPenaltiesAtCutoff, 60000);
})();
</script>


<script>
// Wallet UI progressive enhancement (keeps original JS intact)
(function(){
  function enhanceWallet(){
    var tab = document.getElementById('walletTab');
    if(!tab || tab.classList.contains('hidden')) return;

    var balances = document.getElementById('walletBalances');
    var txLog = document.getElementById('txLog');
    if(!balances || !txLog) return;

    // --- 1) Build cards grid for balances (Favor + Grace) ---
    // Replace balances content with cards built from current users
    var users = (State.presentUsers ? State.presentUsers() : State.data.users) || [];
    if(!tab.querySelector('.wallet-grid')){
      var grid = document.createElement('div');
      grid.className = 'wallet-grid';
      users.forEach(function(u){
        var card = document.createElement('div');
        card.className = 'wallet-card';
        card.innerHTML = '<div class="name">'+(u.name||'User')+'</div>' +
                         '<div class="favor">'+ (window.fmt?fmt(u.favor||0):(u.favor||0)) +' Favor</div>' +
                         '<div class="grace">Grace: '+ (u.grace||0) +'</div>';
        grid.appendChild(card);
      });
      // Replace balances container content but keep the same node to preserve any listeners attached above it
      balances.innerHTML = '';
      balances.appendChild(grid);
    }

    // --- 2) Move action buttons under balances (preserve listeners) ---
    if(!tab.querySelector('.wallet-actions')){
      var headerRow = tab.querySelector('.section .section-header .row');
      if(headerRow){
        var actions = document.createElement('div');
        actions.className = 'wallet-actions';
        // Move existing buttons if found
        ['redeemBtn','tradeBtn','grantGraceBtn'].forEach(function(id){
          var btn = document.getElementById(id);
          if(btn) actions.appendChild(btn); // moving keeps event listeners intact
        });
        // Place actions under balances
        balances.parentNode.insertBefore(actions, balances.nextSibling);
      }
    }

    // --- 3) Add Transaction header + kebab filters (non-destructive) ---
    if(!tab.querySelector('#txnHeader')){
      var hdr = document.createElement('div');
      hdr.id = 'txnHeader';
      hdr.className = 'txn-header';
      hdr.innerHTML = '<div class="txn-title">Transaction History</div>' +
                      '<button class="btn kebab" id="txnKebab" aria-label="Filter"><span>‚ãÆ</span></button>' +
                      '<div class="kebab-menu" id="txnMenu"></div>';
      // Insert header just before txLog
      txLog.parentNode.insertBefore(hdr, txLog);

      // Build menu content
      var menu = hdr.querySelector('#txnMenu');
      var userOptions = ['<option value="">All users</option>']
        .concat(users.map(function(u){ return '<option value="'+u.id+'">'+u.name+'</option>'; }))
        .join('');
      var types = ['gain','redeem','trade','grace_add','grace_used'];
      menu.innerHTML = '<div class="row"><strong style="font-size:12px;opacity:.8;">Filter by User</strong></div>' +
                       '<div class="row"><select id="filterUser" class="btn" style="width:100%;">'+userOptions+'</select></div>' +
                       '<div class="row" style="margin-top:8px;"><strong style="font-size:12px;opacity:.8;">Filter by Type</strong></div>' +
                       '<div class="row" style="flex-wrap:wrap;">' +
                       types.map(function(t){ return '<label class="chip"><input type="checkbox" class="txnType" value="'+t+'" checked> '+t.replace('_',' ')+'</label>'; }).join('') +
                       '</div>';

      // Toggle menu
      var kebab = hdr.querySelector('#txnKebab');
      kebab.addEventListener('click', function(ev){
        ev.stopPropagation();
        menu.classList.toggle('open');
      });
      document.addEventListener('click', function(){ menu.classList.remove('open'); }, {once:true});
    }

    // --- 4) Filtered render into txLog ---
    function appliesType(entry, selected){
      if(selected.length===0) return true;
      if(!entry || typeof entry.type === 'undefined' || entry.type === null) return true;
      return selected.indexOf(entry.type) !== -1;
    }
    function appliesUser(entry, userId){
      if(!userId) return true;
      return (entry.userId===userId) || (entry.fromId===userId) || (entry.toId===userId);
    }
    function renderTx(){
      var list = State.data.walletTx || [];
      var userId = (tab.querySelector('#filterUser')||{}).value || '';
      var selected = Array.prototype.map.call(tab.querySelectorAll('.txnType:checked'), function(x){return x.value;});
      var rows = list.slice().reverse().filter(function(e){ return appliesUser(e, userId) && appliesType(e, selected); })
        .map(function(e){
          var sign = (e.amount||0) >= 0 ? '+' : '';
          var who = (State.userById && State.userById(e.userId)) ? State.userById(e.userId).name : (e.user || '');
          var meta = e.text || '';
          var amt = (window.fmt?fmt(e.amount||0):(e.amount||0));
          var cls = (e.amount||0) >= 0 ? 'positive' : 'negative';
          return '<div class="tx '+cls+'"><div><div>'+ (who||'‚Äî') +'</div><div class="meta">'+ meta +'</div></div><div class="amt">'+ sign + amt +'</div></div>';
        }).join('');
      txLog.innerHTML = rows || '<div class="meta" style="padding:8px 6px;opacity:.75;">No transactions yet.</div>';
    }
    renderTx();

    // Wire filters (if present)
    var fu = tab.querySelector('#filterUser'); if(fu) fu.addEventListener('change', renderTx);
    tab.querySelectorAll('.txnType').forEach(function(cb){ cb.addEventListener('change', renderTx); });
  }

  // Run when wallet tab becomes active
  function onTabClick(e){
    var t = e.target.closest('.tab');
    if(!t) return;
    setTimeout(enhanceWallet, 0);
  }
  document.addEventListener('click', onTabClick);

  // Also run on initial load and after renders
  window.addEventListener('load', function(){ setTimeout(enhanceWallet, 0); });
  // If renderDashboard exists, patch a post-render tick without overriding it
  if(typeof renderDashboard === 'function'){
    var _rd = renderDashboard;
    window.renderDashboard = function(){
      var r = _rd.apply(this, arguments);
      try{ setTimeout(enhanceWallet, 0); }catch(_e){}
      return r;
    };
  }
})();
</script>


<script>
// ---- Wallet TX tagging wrapper (non-destructive) ----
(function(){
  if (window.__walletTxTaggerInstalled) return;
  window.__walletTxTaggerInstalled = true;
  var _orig = window.logTx;
  if (typeof _orig !== 'function') return;
  function inferType(text, amount, explicit){
    if (explicit) return explicit;
    try{
      var t = (text||'').toLowerCase();
      if (t.includes('redeem')) return 'redeem';
      if (t.includes('trade')) return 'trade';
      if (t.includes('granted grace') || t.includes('granted') && t.includes('grace')) return 'grace_add';
      if (t.includes('grace used') || t.includes('used grace')) return 'grace_used';
    }catch(_e){}
    var n = parseFloat(amount);
    if (!isNaN(n)) return 'gain';
    return 'gain';
  }
  window.logTx = function(userId, text, amount, type){
    try{
      _orig.apply(this, [userId, text, amount]);
      if (!window.State || !State.data) return;
      var arr = (State.data.walletTx ||= []);
      // Find the most recent matching entry (within last 20) without a type
      for (var i = arr.length - 1; i >= Math.max(0, arr.length - 20); i--) {
        var e = arr[i];
        if (!e) continue;
        if (e.userId === userId && e.text === text && e.amount === amount && !e.type) {
          e.type = inferType(text, amount, type);
          break;
        }
      }
      if (typeof State.save === 'function') State.save();
    }catch(_e){
      try{ _orig.apply(this, [userId, text, amount]); }catch(__){}
    }
  };
})();
</script>


<script>
/* ===== OurFavor Fixes (per-user Grace + cutoff redistribution) ===== */
(function(){
  function addTx(userId, amount, text, type){
    try{
      State.data.walletTx = State.data.walletTx || [];
      State.data.walletTx.push({
        id: (Math.random().toString(36).slice(2)),
        userId: userId,
        amount: amount,
        text: text,
        type: type || null,
        ts: Date.now()
      });
    }catch(e){ console.warn('addTx failed', e); }
  }
  function findTask(taskId){
    var tasks=(State.data && State.data.catalog && State.data.catalog.tasks)||[];
    for(var i=0;i<tasks.length;i++){ if(tasks[i].id===taskId) return tasks[i]; }
    return null;
  }

  // Bootstrap
  (function(){
    State.data.system = State.data.system || {};
    State.data.system.graceUses = State.data.system.graceUses || {}; // { 'YYYY-MM-DD': { userId: true } }
    State.data.system.lastGraceWeek = State.data.system.lastGraceWeek || (new Date(0)).toISOString();
  })();

  function refreshWeeklyGrace(){
    try{
      var d=new Date(); var day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0);
      var weekISO = d.toISOString();
      if(State.data.system.lastGraceWeek !== weekISO){
        (State.data.users||[]).forEach(function(u){ u.grace = 2; });
        State.data.system.graceUses = {};
        State.data.system.lastGraceWeek = weekISO;
        State.save && State.save();
      }
    }catch(e){ console.warn('refreshWeeklyGrace error', e); }
  }

  function bindUseGrace(){
    var btn = document.getElementById('useGraceBtn');
    if(!btn || btn._boundPerUserGrace) return;
    var clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    btn = document.getElementById('useGraceBtn');
    btn.addEventListener('click', function(){
      var u = State.currentUser; if(!u) return;
      refreshWeeklyGrace();
      var today = (new Date()).toISOString().slice(0,10);
      var map = State.data.system.graceUses[today] || (State.data.system.graceUses[today] = {});
      if(map[u.id]){ alert('Grace already used today.'); return; }
      if((u.grace||0) <= 0){ alert('No Grace tokens left.'); return; }
      u.grace -= 1;
      map[u.id] = true;
      var mask = document.getElementById('graceMask');
      if(mask){ mask.classList.remove('hidden'); document.getElementById('okGraceBtn')?.addEventListener('click', function(){ mask.classList.add('hidden'); }, {once:true}); }
      var gc = document.getElementById('graceCount'); if(gc) gc.textContent = String(u.grace);
      addTx(u.id, 0, 'Grace used', 'grace_used');
      State.save && State.save();
    });
    btn._boundPerUserGrace = true;
  }

  function processDailyFor(dateStr){
    try{
      var users = (State.data.users||[]);
      var daily = State.data.assignments && State.data.assignments.daily || {};
      var usedMap = (State.data.system.graceUses||{})[dateStr] || {};
      users.forEach(function(u){
        var assigns = (daily[u.id]||[]).filter(function(a){ return a.date===dateStr && !a.completed; });
        if(!assigns.length) return;
        if(usedMap[u.id]) return; // pardoned by grace
        assigns.forEach(function(a){
          var t = findTask(a.taskId) || {neg:0, title:'Task', room:''};
          var others = users.filter(function(o){ return o.id !== u.id; });
          if(!others.length) return;
          var per = (t.neg||0) / others.length;
          others.forEach(function(o){
            o.favor = (o.favor||0) + per;
            addTx(o.id, per, 'Missed task by '+ (u.name||'user') + ': ' + (t.room? t.room+': ' : '') + (t.title||'task'), 'missed');
          });
        });
      });
      State.save && State.save();
    }catch(e){ console.warn('processDailyFor error', e); }
  }

  function processWeeklyFor(weekStartISO){
    try{
      var users = (State.data.users||[]);
      var weekly = State.data.assignments && State.data.assignments.weekly || {};
      users.forEach(function(u){
        var assigns = (weekly[u.id]||[]).filter(function(a){ return a.weekStartISO===weekStartISO && !a.completed; });
        assigns.forEach(function(a){
          var t = findTask(a.taskId) || {neg:0, title:'Task', room:''};
          var others = users.filter(function(o){ return o.id !== u.id; });
          if(!others.length) return;
          var per = (t.neg||0) / others.length;
          others.forEach(function(o){
            o.favor = (o.favor||0) + per;
            addTx(o.id, per, 'Missed weekly by '+ (u.name||'user') + ': ' + (t.room? t.room+': ' : '') + (t.title||'task'), 'missed');
          });
        });
      });
      State.save && State.save();
    }catch(e){ console.warn('processWeeklyFor error', e); }
  }

  function runRollover(){
    try{
      refreshWeeklyGrace();
      var cutoffToday = getDeviceLocalCutoffDate(now);
      if(now >= cutoffToday && State.data.system.lastDailySettled !== today){
        processDailyFor(yesterdayStr);
        State.distributeDaily && State.distributeDaily();
        State.data.system.lastDailySettled = today;
        State.save && State.save();
      }

      // Weekly settle once per week boundary
      if(State.data.system.lastWeeklySettled !== weekStart){
        processWeeklyFor(State.data.system.lastWeeklySettled);
        State.distributeWeekly && State.distributeWeekly();
        State.data.system.lastWeeklySettled = weekStart;
        State.save && State.save();
      }

      var gc = document.getElementById('graceCount'); if(gc) gc.textContent = String(State.currentUser?.grace || 0);
    }catch(e){ console.warn('runRollover error', e); }
  }

  window.addEventListener('load', function(){
    try{
      bindUseGrace();
      runRollover();
      setInterval(runRollover, 60000);
    }catch(e){ console.warn(e); }
  });
})();
</script>


<script>
// Grace overlay fixes: blur + working Undo
(function(){
  function showGraceOverlay(){
    var mask = document.getElementById('graceMask');
    var daily = document.getElementById('dailySection');
    if(mask){ mask.classList.remove('hidden'); }
    if(daily){ daily.classList.add('grace-active'); }
  }
  function hideGraceOverlay(){
    var mask = document.getElementById('graceMask');
    var daily = document.getElementById('dailySection');
    if(mask){ mask.classList.add('hidden'); }
    if(daily){ daily.classList.remove('grace-active'); }
  }
  function undoGrace(){
    var u = State.currentUser; if(!u) return;
    var today = (new Date()).toISOString().slice(0,10);
    var map = (State.data.system && State.data.system.graceUses && State.data.system.graceUses[today]) || {};
    if(map[u.id]){
      delete map[u.id];
      u.grace = (u.grace||0) + 1;
      var gc = document.getElementById('graceCount'); if(gc) gc.textContent = String(u.grace);
      if(typeof addTx === 'function'){ addTx(u.id, 0, 'Grace undone', 'grace_used'); }
      else{
        try{
          State.data.walletTx = State.data.walletTx || [];
          State.data.walletTx.push({id:Math.random().toString(36).slice(2), userId:u.id, amount:0, text:'Grace undone', type:'grace_used', ts:Date.now()});
        }catch(e){}
      }
      State.save && State.save();
    }
    hideGraceOverlay();
  }
  // Bind overlay buttons once
  function bindOverlayButtons(){
    var ok = document.getElementById('okGraceBtn');
    var un = document.getElementById('undoGraceBtn');
    if(ok && !ok._boundG){ ok.addEventListener('click', hideGraceOverlay); ok._boundG = true; }
    if(un && !un._boundG){ un.addEventListener('click', undoGrace); un._boundG = true; }
  }

  // Patch Use Grace button to also force overlay blur (without altering existing logic)
  function patchUseGraceToShow(){
    var btn = document.getElementById('useGraceBtn');
    if(!btn || btn._patchedOverlay) return;
    btn.addEventListener('click', function(){
      setTimeout(function(){ bindOverlayButtons(); showGraceOverlay(); }, 0);
    });
    btn._patchedOverlay = true;
  }

  window.addEventListener('load', function(){
    bindOverlayButtons();
    patchUseGraceToShow();
  });
  document.addEventListener('click', function(e){
    if(e.target && (e.target.id === 'useGraceBtn')){
      setTimeout(function(){ bindOverlayButtons(); showGraceOverlay(); }, 0);
    }
  }, true);
})();
</script>


<script>
// Settings: wire up Redistribute buttons + avoid double cutoff engines
(function(){
  function bindRedistributeButtons(){
    // Delegate by ID so it survives modal reopens
    document.addEventListener('click', function(e){
      var t = e.target;
      if(!t || !t.id) return;
      if(t.id === 't_dist_daily'){
        e.preventDefault();
        try{
          State.distributeDaily && State.distributeDaily();
          State.save && State.save();
          if(typeof renderDashboard==='function') renderDashboard();
          if(typeof pushNotif==='function' && State.currentUser){ pushNotif(State.currentUser.id, 'Daily tasks redistributed.', []); }
        }catch(err){ console.warn('Redistribute Daily failed', err); }
      }
      if(t.id === 't_dist_weekly'){
        e.preventDefault();
        try{
          State.distributeWeekly && State.distributeWeekly();
          State.save && State.save();
          if(typeof renderDashboard==='function') renderDashboard();
          if(typeof pushNotif==='function' && State.currentUser){ pushNotif(State.currentUser.id, 'Weekly tasks redistributed.', []); }
        }catch(err){ console.warn('Redistribute Weekly failed', err); }
      }
    }, true);
  }
  function guardCutoffEngines(){
    // If the native cutoff engine exists, disable the secondary one we injected earlier
    if(typeof window.applyDailyPenaltiesAtCutoff === 'function'){
      try{
        // Overwrite runRollover with a no-op to prevent double distribution/penalties
        window.runRollover = function(){};
      }catch(_){}
    }
  }
  window.addEventListener('load', function(){
    bindRedistributeButtons();
    guardCutoffEngines();
  });
})();
</script>


<script>
/* ===== Improved random-balanced redistribution (daily & weekly) ===== */
(function(){
  function riskOf(t){ var p = Math.max(0, +t.pos||0), n = Math.max(0, +t.neg||0); return p + n; }
  function percentile(arr, p){
    if(!arr.length) return 0; var s = arr.slice().sort(function(a,b){return a-b;});
    var idx = Math.floor(p*(s.length-1)); return s[idx];
  }
  function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=(Math.random()* (i+1))|0; var tmp=a[i]; a[i]=a[j]; a[j]=tmp; } return a; }
  function assignBalanced(tasks, users, period){
    // period: 'daily' or 'weekly'
    var vals = tasks.map(riskOf);
    var hiCut = percentile(vals, 0.75);
    var isHi = function(t){ return riskOf(t) >= hiCut && hiCut>0; };

    // sort by risk desc + tiny jitter so repeated clicks don't yield identical result
    var order = tasks.slice().sort(function(a,b){ return (riskOf(b)+Math.random()*0.01) - (riskOf(a)+Math.random()*0.01); });

    // build buckets
    var buckets = new Map(users.map(function(u){ return [u.id, { risk:0, hi:0, list:[] }]; }));

    order.forEach(function(t){
      // compute candidate users
      var entries = users.map(function(u){
        var b = buckets.get(u.id);
        return { u:u, r:b.risk, h:b.hi };
      });
      var chosen;
      if(isHi(t)){
        // prefer users with the fewest high-risk already
        var minH = Math.min.apply(null, entries.map(function(e){ return e.h; }));
        var poolH = entries.filter(function(e){ return e.h===minH; });
        // within that pool, pick among the K lowest risk users at random
        poolH.sort(function(a,b){ return a.r - b.r; });
        var K = Math.max(1, Math.min(3, poolH.length));
        chosen = poolH[(Math.random()*K)|0].u;
      }else{
        // normal task: pick randomly among the K lowest risk users
        entries.sort(function(a,b){ return a.r - b.r; });
        var K2 = Math.max(1, Math.min(3, entries.length));
        chosen = entries[(Math.random()*K2)|0].u;
      }
      var bkt = buckets.get(chosen.id);
      bkt.list.push(period==='daily' ?
        { taskId:t.id, completed:false, date: todayStr() } :
        { taskId:t.id, completed:false, weekStartISO: startOfWeek().toISOString() });
      bkt.risk += riskOf(t);
      if(isHi(t)) bkt.hi += 1;
    });

    var out = {}; buckets.forEach(function(v, uid){ out[uid] = v.list; });
    return out;
  }

  function presentUsersSafe(){
    try{ return State.presentUsers ? State.presentUsers() : (State.data.users||[]); }
    catch(_){ return (State.data.users||[]); }
  }

  // Override with improved versions
  State.distributeDaily = function(){
    var all = (State.data.catalog && State.data.catalog.tasks) ? State.data.catalog.tasks : [];
    var daily = all.filter(function(t){ return (t.freq||t.frequency||'daily') === 'daily'; });
    var users = presentUsersSafe(); if(!users.length) return;
    State.data.assignments = State.data.assignments || {};
    State.data.assignments.daily = assignBalanced(daily, users, 'daily');
    State.data.system = State.data.system || {};
    State.data.system.lastDailyDist = todayStr();
    State.save && State.save();
  };

  State.distributeWeekly = function(){
    var all = (State.data.catalog && State.data.catalog.tasks) ? State.data.catalog.tasks : [];
    var weekly = all.filter(function(t){ return (t.freq||t.frequency||'weekly') === 'weekly'; });
    var users = presentUsersSafe(); if(!users.length) return;
    State.data.assignments = State.data.assignments || {};
    State.data.assignments.weekly = assignBalanced(weekly, users, 'weekly');
    State.data.system = State.data.system || {};
    State.data.system.lastWeeklyDist = startOfWeek().toISOString();
    State.save && State.save();
  };
})();
</script>


<script>
/* ===== Grace overlay: per-user only + auto-hide/lock at cutoff ===== */
(function(){
  // Helper: get today's YYYY-MM-DD and cutoff Date for today
  function todayStr(){ return new Date().toISOString().slice(0,10); }
  function todayCutoffDate(){ return getDeviceLocalCutoffDate(); }

  // Show overlay only for the user who redeemed it
  function showGraceOverlayFor(userId){
    var mask = document.getElementById('graceMask');
    var daily = document.getElementById('dailySection');
    if(!mask) return;
    mask.dataset.forUser = userId || '';
    var cur = State.currentUser && State.currentUser.id;
    if(cur && cur === userId){
      mask.classList.remove('hidden');
      if(daily){ daily.classList.add('grace-active'); }
      // While visible and before cutoff, allow undo; after cutoff, lock it
      updateGraceUndoLock();
    }else{
      // Different user viewing: keep overlay hidden
      mask.classList.add('hidden');
      if(daily){ daily.classList.remove('grace-active'); }
    }
  }

  function hideGraceOverlay(){
    var mask = document.getElementById('graceMask');
    var daily = document.getElementById('dailySection');
    if(mask){ mask.classList.add('hidden'); }
    if(daily){ daily.classList.remove('grace-active'); }
  }

  // Lock/disable undo at or after cutoff for the day the grace was used
  function updateGraceUndoLock(){
    var undoBtn = document.getElementById('undoGraceBtn');
    var mask = document.getElementById('graceMask');
    if(!undoBtn || !mask) return;
    var cutoff = todayCutoffDate();
    var now = new Date();
    var locked = now >= cutoff;
    // Disable pointer and visually soften if locked
    undoBtn.disabled = !!locked;
    undoBtn.style.opacity = locked ? .5 : 1;
    undoBtn.style.pointerEvents = locked ? 'none' : 'auto';
    // If locked, also hide the overlay (require re-use next day if needed)
    if(locked){ hideGraceOverlay(); }
  }

  // Patch the Use Grace button so it shows overlay only for the redeemer
  function patchUseGrace(){
    var btn = document.getElementById('useGraceBtn');
    if(!btn || btn._patchedPerUserOverlay) return;
    btn.addEventListener('click', function(){
      var u = State.currentUser; if(!u) return;
      // After state updates, show overlay strictly for this user
      setTimeout(function(){ showGraceOverlayFor(u.id); }, 0);
    });
    btn._patchedPerUserOverlay = true;
  }

  // Bind OK and Undo with per-user guard
  function bindOverlayButtons(){
    var ok = document.getElementById('okGraceBtn');
    var un = document.getElementById('undoGraceBtn');
    if(ok && !ok._boundG){
      ok.addEventListener('click', hideGraceOverlay);
      ok._boundG = true;
    }
    if(un && !un._boundG){
      un.addEventListener('click', function(){
        // Guard: only allow undo for the same user who redeemed and before cutoff
        var mask = document.getElementById('graceMask');
        var forUser = mask && mask.dataset.forUser;
        var cur = State.currentUser && State.currentUser.id;
        var now = new Date();
        if(now >= todayCutoffDate()){ hideGraceOverlay(); return; }
        if(!cur || !forUser || cur !== forUser){ hideGraceOverlay(); return; }
        // Perform existing undo logic if present (from prior patch), else do minimal revert
        try{
          // Try to call the undo function we injected earlier if available
          if(typeof window._undoGraceInternal === 'function'){ window._undoGraceInternal(); hideGraceOverlay(); return; }
        }catch(_){}
        // Fallback minimal: add back grace and clear flag
        var u = State.currentUser; if(!u) return;
        var map = (State.data.system && State.data.system.graceUses && State.data.system.graceUses[todayStr()]) || {};
        if(map[u.id]){ delete map[u.id]; u.grace = (u.grace||0)+1; var gc=document.getElementById('graceCount'); if(gc) gc.textContent=String(u.grace); State.save && State.save(); }
        hideGraceOverlay();
      });
      un._boundG = true;
    }
  }

  // Expose minimal internal undo so earlier code (if any) can call it
  if(!window._undoGraceInternal){
    window._undoGraceInternal = function(){
      var u = State.currentUser; if(!u) return;
      var today = todayStr();
      var map = (State.data.system && State.data.system.graceUses && State.data.system.graceUses[today]) || {};
      if(map[u.id]){
        delete map[u.id]; u.grace = (u.grace||0)+1;
        var gc=document.getElementById('graceCount'); if(gc) gc.textContent=String(u.grace);
        State.save && State.save();
      }
    };
  }

  // Periodically check for cutoff to auto-lock/hide overlay
  var _iv = null;
  function startOverlayCutoffWatcher(){
    if(_iv) return;
    _iv = setInterval(updateGraceUndoLock, 30000); // check every 30s
  }

  window.addEventListener('load', function(){
    bindOverlayButtons();
    patchUseGrace();
    startOverlayCutoffWatcher();
    updateGraceUndoLock();
  });

  // If user switches tabs or profiles, re-apply guards quickly
  document.addEventListener('click', function(){ setTimeout(function(){ bindOverlayButtons(); patchUseGrace(); updateGraceUndoLock(); }, 0); }, true);
})();
</script>


<script>
/* ===== Grace overlay visibility enforcer (per-user only) ===== */
(function(){
  function hideOverlay(){
    var mask = document.getElementById('graceMask');
    var daily = document.getElementById('dailySection');
    if(mask) mask.classList.add('hidden');
    if(daily) daily.classList.remove('grace-active');
  }
  function enforceOverlayForCurrentUser(){
    var mask = document.getElementById('graceMask');
    if(!mask) return;
    var forUser = mask.dataset && mask.dataset.forUser;
    var cur = (State.currentUser && State.currentUser.id) || null;
    // If overlay is visible but not for current user, hide it.
    var isVisible = !mask.classList.contains('hidden');
    if(isVisible && (!cur || !forUser || cur !== forUser)){
      hideOverlay();
    }
  }
  // Run on load
  window.addEventListener('load', function(){
    setTimeout(enforceOverlayForCurrentUser, 0);
  });
  // Re-run after dashboard re-renders
  if(typeof window.renderDashboard === 'function'){
    var _rd = window.renderDashboard;
    window.renderDashboard = function(){
      var r = _rd.apply(this, arguments);
      try{ setTimeout(enforceOverlayForCurrentUser, 0); }catch(_){}
      return r;
    };
  }
  // Re-run on any profile switch/tab click
  document.addEventListener('click', function(e){
    // Give UI a moment to switch State.currentUser
    setTimeout(enforceOverlayForCurrentUser, 0);
  }, true);
  // Periodic safety check (low frequency)
  setInterval(enforceOverlayForCurrentUser, 2000);
})();
</script>


<script>
// ===== Local cutoff time UI (device local) =====
(function(){
  function pad(n){ return (n<10?'0':'')+n; }
  function getLocalCutoff(){ 
    var s = State.data && State.data.settings && State.data.settings.dailyCutoffTimeLocal;
    if(typeof s === 'string' && /^\d{2}:\d{2}$/.test(s)) return s;
    // fallback to hour if present
    var h = (State.data && State.data.settings && State.data.settings.dailyCutoffHour) || 22;
    return pad(h)+':00';
  }
  function setLocalCutoff(val){
    State.data = State.data || {}; State.data.settings = State.data.settings || {};
    if(typeof val === 'string' && /^\d{2}:\d{2}$/.test(val)){
      State.data.settings.dailyCutoffTimeLocal = val;
      // keep dailyCutoffHour in sync for older code paths
      var parts = val.split(':');
      State.data.settings.dailyCutoffHour = parseInt(parts[0],10) || 22;
      State.save && State.save();
    }
  }
  // Hook into opening of General settings
  var _openGeneral = window.openGeneralSettings;
  window.openGeneralSettings = function(){
    var r = _openGeneral ? _openGeneral.apply(this, arguments) : undefined;
    try{
      var panel = document.getElementById('settingsPanel') || document.body;
      // Remove timezone controls if any
      var tz = panel.querySelector('[data-role="timezoneRow"]');
      if(tz){ tz.remove(); }
      // Insert/ensure cutoff time row
      var markerId = 'cutoffLocalRow';
      if(!panel.querySelector('#'+markerId)){
        var host = panel.querySelector('.settings-form') || panel;
        var row = document.createElement('div');
        row.className = 'row'; row.id = markerId;
        row.innerHTML = '<label style="min-width:220px">Daily cutoff (device local time)</label>'+
                        '<input type="time" id="cutoffTimeLocal" class="btn" style="width:160px">';
        host.appendChild(row);
      }
      var input = panel.querySelector('#cutoffTimeLocal');
      if(input){ input.value = getLocalCutoff(); input.onchange = function(){ setLocalCutoff(this.value); }; }
    }catch(e){ console.warn('cutoff UI patch failed', e); }
    return r;
  };
})();
</script>


<script>
// ===== Device-local cutoff helpers =====
(function(){
  window.getDeviceLocalCutoffDate = function(refDate){
    var d = refDate ? new Date(refDate) : new Date();
    var s = (State.data && State.data.settings && State.data.settings.dailyCutoffTimeLocal) || null;
    var h = 22, m = 0;
    if(typeof s === 'string' && /^\d{2}:\d{2}$/.test(s)){ h = parseInt(s.slice(0,2),10)||22; m = parseInt(s.slice(3,5),10)||0; }
    else if(State.data && State.data.settings && typeof State.data.settings.dailyCutoffHour === 'number'){ h = State.data.settings.dailyCutoffHour; }
    d.setHours(h, m, 0, 0); // local time
    return d;
  };
  window.todayStrLocal = function(refDate){
    var d = refDate ? new Date(refDate) : new Date();
    return d.toISOString().slice(0,10);
  };
})();
</script>


<style>
/* Mini Swap Modal (standalone, non-conflicting) */
#swapMiniBackdrop{
  position: fixed; inset: 0; z-index: 100;
  background: rgba(10,12,16,0.55);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: none;
}
#swapMiniModal{
  position: fixed; z-index: 101; inset: 0;
  display: none; align-items: center; justify-content: center;
}
#swapMiniCard{
  min-width: 320px; max-width: 520px;
  background: rgba(28,32,40,0.92);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 18px; padding: 16px 16px 12px 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.35);
}
#swapMiniCard .title{ font-size: 18px; font-weight: 600; margin-bottom: 12px; }
#swapMiniCard .field{ display:flex; gap:12px; align-items:center; margin: 10px 0; }
#swapMiniCard label{ width: 110px; opacity: .9; }
#swapMiniCard select{ flex: 1; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: #fff; }
#swapMiniCard .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top: 12px; }
#swapMiniCard .btn{ padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color:#fff; }
#swapMiniCard .btn.primary{ background: rgba(120,162,255,0.22); }
#swapMiniCard .btn:disabled{ opacity: .5; pointer-events: none; }
</style>
<script>
(function(){
  function ensureMiniModal(){
    if(document.getElementById('swapMiniBackdrop')) return;
    var back = document.createElement('div'); back.id = 'swapMiniBackdrop';
    var wrap = document.createElement('div'); wrap.id = 'swapMiniModal';
    var card = document.createElement('div'); card.id = 'swapMiniCard';
    wrap.appendChild(card);
    document.body.appendChild(back);
    document.body.appendChild(wrap);
  }
  function closeMini(){ var b=document.getElementById('swapMiniBackdrop'); var m=document.getElementById('swapMiniModal'); if(b) b.style.display='none'; if(m) m.style.display='none'; }
  function openMiniSwap(){
    ensureMiniModal();
    var b=document.getElementById('swapMiniBackdrop'); var m=document.getElementById('swapMiniModal'); var c=document.getElementById('swapMiniCard');
    if(!State || !State.currentUser) return;
    var current = State.currentUser;
    var today = (typeof todayStrLocal==='function'? todayStrLocal() : new Date().toISOString().slice(0,10));
    function taskLabel(tid){ try{ var t=(State.data.catalog.tasks||[]).find(function(x){return x.id===tid;}); return t? ((t.room||'‚Äî')+' ‚Äî '+t.title) : tid; }catch(_){ return tid; } }
    var myDaily = ((State.data.assignments||{}).daily||{})[current.id]||[];
    myDaily = myDaily.filter(function(a){ return a.date===today && !a.completed; });
    var users = (State.data.users||[]).filter(function(u){ return u.id!==current.id; });
    // Build content
    c.innerHTML = ''
      + '<div class="title">Swap a Daily Task</div>'
      + '<div class="field"><label>Your Task</label><select id="sw_my" class="sel"></select></div>'
      + '<div class="field"><label>With User</label><select id="sw_user" class="sel"></select></div>'
      + '<div class="field"><label>Their Task</label><select id="sw_other" class="sel" disabled><option value="">Select a user first</option></select></div>'
      + '<div class="actions">'
      +   '<button class="btn" id="sw_cancel">Cancel</button>'
      +   '<button class="btn primary" id="sw_send" disabled>Send Request</button>'
      + '</div>';
    var selMy = c.querySelector('#sw_my'), selUser = c.querySelector('#sw_user'), selOther = c.querySelector('#sw_other'), sendBtn = c.querySelector('#sw_send');
    // Populate my tasks
    selMy.innerHTML = myDaily.map(function(a){ return '<option value="'+a.taskId+'">'+taskLabel(a.taskId)+'</option>'; }).join('');
    // Populate users
    selUser.innerHTML = users.map(function(u){ return '<option value="'+u.id+'">'+u.name+'</option>'; }).join('');
    function populateOther(){
      var oid = selUser.value; selOther.innerHTML=''; selOther.disabled = true; sendBtn.disabled = true;
      if(!oid){ return; }
      var list = (((State.data.assignments||{}).daily||{})[oid]||[]).filter(function(a){ return a.date===today && !a.completed; });
      if(!list.length){ selOther.innerHTML = '<option value="">No available tasks</option>'; return; }
      selOther.innerHTML = list.map(function(a){ return '<option value="'+a.taskId+'">'+taskLabel(a.taskId)+'</option>'; }).join('');
      selOther.disabled = false; sendBtn.disabled = false;
    }
    selUser.addEventListener('change', populateOther); populateOther();
    c.querySelector('#sw_cancel').onclick = closeMini;
    c.querySelector('#sw_send').onclick = function(){
      var fromTaskId = selMy.value, toUserId = selUser.value, toTaskId = selOther.value;
      if(!fromTaskId || !toUserId || !toTaskId) return;
      // Create request
      var req = { id: (Math.random().toString(36).slice(2)), fromUserId: current.id, toUserId: toUserId, fromTaskId: fromTaskId, toTaskId: toTaskId, date: new Date().toISOString() };
      State.data.swaps = State.data.swaps || []; State.data.swaps.push(req);
      // Notify
      function ttitle(tid){ var t=(State.data.catalog.tasks||[]).find(function(x){return x.id===tid;}); return t?t.title:tid; }
      pushNotif(toUserId, current.name+' wants to swap "'+ttitle(fromTaskId)+'" for your "'+ttitle(toTaskId)+'"', [
        {label:'Approve', action:{type:'swap_approve', id:req.id}},
        {label:'Deny', action:{type:'swap_deny', id:req.id}}
      ]);
      pushNotif(current.id, 'Swap request sent: "'+ttitle(fromTaskId)+'" ‚Üî "'+ttitle(toTaskId)+'"', []);
      State.save && State.save();
      closeMini();
    };
    // Show
    b.style.display='block'; m.style.display='flex';
    // Close by clicking backdrop
    b.onclick = closeMini;
  }

  // Intercept the broken Swap handler in capture phase, open our modal instead
  function bindCapture(){
    var btn = document.getElementById('swapBtn');
    if(btn && !btn._miniBound){
      btn.addEventListener('click', function(ev){
        ev.preventDefault(); ev.stopImmediatePropagation();
        // Close any stuck backdrops if present
        try{ var mr=document.getElementById('modalRoot'); if(mr) mr.innerHTML=''; }catch(_){}
        openMiniSwap();
      }, true); // capture
      btn._miniBound = true;
    }
  }

  // Swap approval wrapper: only handle when our toTaskId exists, otherwise defer to original handler
  (function(){
    var orig = window.handleNotifAction;
    window.handleNotifAction = function(type, id, notif){
      try{
        if((type==='swap_approve' || type==='swap_deny') && State && State.data){
          State.data.swaps = State.data.swaps || [];
          var req = State.data.swaps.find(function(s){ return s && s.id===id; });
          if(req && req.toTaskId){
            var fromUserId=req.fromUserId, toUserId=req.toUserId, fromTaskId=req.fromTaskId||req.taskId, toTaskId=req.toTaskId;
            if(type==='swap_deny'){
              pushNotif(fromUserId, (State.userById(toUserId).name)+' denied your swap request.', []);
            }else{
              var today = (typeof todayStrLocal==='function'? todayStrLocal() : new Date().toISOString().slice(0,10));
              function findEntry(arr, tid){ for(var i=0;i<arr.length;i++){ var a=arr[i]; if(a.taskId===tid && a.date===today) return {i:i,a:a}; } return null; }
              var A=(State.data.assignments.daily[fromUserId]||[]), B=(State.data.assignments.daily[toUserId]||[]);
              var eA=findEntry(A, fromTaskId), eB=findEntry(B, toTaskId);
              if(!eA || !eB){
                pushNotif(fromUserId, 'Swap failed: one of the tasks is no longer available.', []);
                pushNotif(toUserId, 'Swap failed: one of the tasks is no longer available.', []);
              }else if(eA.a.completed || eB.a.completed){
                pushNotif(fromUserId, 'Swap failed: one of the tasks is already completed.', []);
                pushNotif(toUserId, 'Swap failed: one of the tasks is already completed.', []);
              }else{
                var aObj=A.splice(eA.i,1)[0], bObj=B.splice(eB.i,1)[0];
                (State.data.assignments.daily[toUserId]=State.data.assignments.daily[toUserId]||[]).push({taskId:aObj.taskId, completed:aObj.completed, date:aObj.date});
                (State.data.assignments.daily[fromUserId]=State.data.assignments.daily[fromUserId]||[]).push({taskId:bObj.taskId, completed:bObj.completed, date:bObj.date});
                var title=function(tid){ var t=(State.data.catalog.tasks||[]).find(function(x){return x.id===tid;}); return t? t.title : tid; };
                pushNotif(fromUserId, 'Swap approved: You now have "'+title(toTaskId)+'"', []);
                pushNotif(toUserId,   'Swap approved: You now have "'+title(fromTaskId)+'"', []);
              }
            }
            // cleanup
            State.data.swaps = State.data.swaps.filter(function(s){ return s.id!==id; });
            State.data.notifications = (State.data.notifications||[]).filter(function(n){ return n.id !== (notif && notif.id); });
            State.save && State.save(); if(typeof renderDashboard==='function') renderDashboard();
            return;
          }
        }
      }catch(e){ /* fall through*/ }
      if(typeof orig === 'function'){ return orig.apply(this, arguments); }
    };
  })();

  window.addEventListener('load', bindCapture);
  // If Swap button is dynamically re-rendered, try to bind again after any click
  document.addEventListener('click', function(){ setTimeout(bindCapture, 0); }, true);
})();
</script>


<style>
/* Harmonize mini swap modal with site modal & accents */
#swapMiniBackdrop{ display: none; } /* Will be toggled to flex by script */
#swapMiniBackdrop.modal-backdrop{ backdrop-filter: blur(var(--blur,18px)) saturate(1.05); -webkit-backdrop-filter: blur(var(--blur,18px)) saturate(1.05); }
#swapMiniCard{ background: var(--card) !important; border: 1px solid rgba(255,255,255,0.14) !important; border-radius: var(--radius,24px) !important; box-shadow: none !important; color: var(--on-surface,#e8e8ea) !important; }
#swapMiniCard .title{ color: var(--on-surface,#e8e8ea) !important; }
#swapMiniCard .btn.primary{ 
  background: linear-gradient(135deg, rgba(var(--accent-rgb,107,134,255),0.28), rgba(var(--accent-rgb,107,134,255),0.18)) !important;
  border-color: rgba(var(--accent-rgb,107,134,255),0.35) !important;
}
#swapMiniCard select{ background: rgba(255,255,255,0.06) !important; color: var(--on-surface,#e8e8ea) !important; border-color: rgba(255,255,255,0.14) !important; }
</style>
<script>
// Make the standalone mini modal use .modal / .modal-backdrop styles and accent tint
(function(){
  function harmonizeMini(){
    var back = document.getElementById('swapMiniBackdrop');
    var wrap = document.getElementById('swapMiniModal');
    var card = document.getElementById('swapMiniCard');
    if(!back || !card) return;
    // Use site classes
    back.classList.add('modal-backdrop');
    card.classList.add('modal');
    // Ensure structure: .modal-backdrop centers .modal
    if(card.parentElement !== back){
      try{ back.appendChild(card); }catch(_){}
    }
    // Hide extra wrapper if present
    if(wrap){ wrap.style.display='none'; }
    // If previously shown, ensure backdrop uses flex to center
    if(back.style.display==='block'){ back.style.display='flex'; }
  }
  // Run when swap is opened and on load
  window.addEventListener('load', harmonizeMini);
  document.addEventListener('click', function(e){
    if(e && (e.target && e.target.id==='swapBtn' || /\bswap\b/i.test((e.target && e.target.textContent)||''))){
      setTimeout(harmonizeMini, 0);
    }
  }, true);
})();
</script>


<style>
/* Swap mini modal: left-aligned contents to match site modals */
#swapMiniCard { text-align: left !important; }
#swapMiniCard .title { text-align: left !important; }
#swapMiniCard .field { justify-content: flex-start !important; }
#swapMiniCard label { text-align: left !important; }
#swapMiniCard select { text-align: left !important; }
#swapMiniCard .actions { justify-content: flex-end !important; }
</style>


<style>
/* Force row layout & left-to-right labels like other modals */
#swapMiniBackdrop.modal-backdrop { 
  display: flex !important; 
  align-items: center !important; 
  justify-content: center !important; 
}
#swapMiniCard .field {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  gap: 12px !important;
}
#swapMiniCard label {
  flex: 0 0 140px !important;
  min-width: 140px !important;
  text-align: left !important;
}
#swapMiniCard select {
  flex: 1 1 auto !important;
  width: auto !important;
  text-align: left !important;
}
#swapMiniCard .actions { justify-content: flex-end !important; }
</style>


<style>
/* Display control driven by class (fix close): hidden by default */
#swapMiniBackdrop.modal-backdrop { display: none !important; }
#swapMiniBackdrop.modal-backdrop.open { display: flex !important; }
</style>
<script>
// Ensure the mini modal opens/closes reliably with class toggles
(function(){
  // Add 'open' class right after clicking Swap so CSS shows the modal
  document.addEventListener('click', function(e){
    var t = e.target || {};
    if(t.id==='swapBtn' || (/\bswap\b/i.test(t.textContent||''))){
      setTimeout(function(){
        var b = document.getElementById('swapMiniBackdrop');
        if(b){ b.classList.add('open'); b.style.display=''; }
      }, 0);
    }
  }, true);

  // Close handlers for Cancel/Send (standalone ids)
  document.addEventListener('click', function(e){
    var id = (e.target && e.target.id) || '';
    if(id==='sw_cancel' || id==='sw_send' || id==='sw_cancel_fb' || id==='sw_send_fb'){
      var b = document.getElementById('swapMiniBackdrop');
      var m = document.getElementById('swapMiniModal');
      if(b){ b.classList.remove('open'); b.style.display='none'; }
      if(m){ m.style.display='none'; }
    }
    // Clicking backdrop closes too
    if(id==='swapMiniBackdrop'){
      var b2 = document.getElementById('swapMiniBackdrop');
      var m2 = document.getElementById('swapMiniModal');
      if(b2){ b2.classList.remove('open'); b2.style.display='none'; }
      if(m2){ m2.style.display='none'; }
    }
  }, true);
})();
</script>

</body>
</html>
